 <!DOCTYPE html>
<html lang="pt-br" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanças IA Pro Premium - Sistema Completo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js">

// ===== K-DEV AUTH (FASE 1 - LOCAL) =====
function fp_getLoggedUser(){
  try { return JSON.parse(localStorage.getItem('loggedUser')||'null'); } catch(e){ return null; }
}
function fp_requireLogin(){
  const u = fp_getLoggedUser();
  if(!u){ window.location.href = 'login.html'; return null; }
  return u;
}
function fp_applyUserPlanToAppState(){
  const u = fp_requireLogin();
  if(!u) return;
  window.AppState = window.AppState || {};
  AppState.settings = AppState.settings || {};
  AppState.settings.accountType = (u.plan === 'premium') ? 'premium' : 'basic';
}
function fp_logout(){
  localStorage.removeItem('loggedUser');
  window.location.href = 'login.html';
}
// ===== END AUTH =====

</script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ========== VARIÁVEIS E RESET ========== */
        :root {
            --primary: #00D4AA;
            --primary-light: #6C63FF;
            --secondary: #1C1C1E;
            --tertiary: #2C2C2E;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-hover: rgba(255, 255, 255, 0.08);
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-tertiary: rgba(255, 255, 255, 0.5);
            --success: #30D158;
            --danger: #FF453A;
            --warning: #FFD60A;
            --info: #5AC8FA;
            --border: rgba(255, 255, 255, 0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 15px 40px rgba(0, 0, 0, 0.4);
            --glass: rgba(255, 255, 255, 0.08);
            --glass-hover: rgba(255, 255, 255, 0.12);
            --premium: #FFD700;
            --basic: #8E8E93;
            
            --ai-gradient: linear-gradient(135deg, #00D4AA, #6C63FF);
            --ai-glow: 0 0 20px rgba(0, 212, 170, 0.3);
            --ai-glow-purple: 0 0 20px rgba(108, 99, 255, 0.3);
        }

        [data-theme="light"] {
            --secondary: #F2F2F7;
            --tertiary: #FFFFFF;
            --card-bg: rgba(255, 255, 255, 0.7);
            --card-hover: rgba(255, 255, 255, 0.9);
            --text-primary: #000000;
            --text-secondary: rgba(0, 0, 0, 0.7);
            --text-tertiary: rgba(0, 0, 0, 0.5);
            --border: rgba(0, 0, 0, 0.1);
            --glass: rgba(0, 0, 0, 0.05);
            --glass-hover: rgba(0, 0, 0, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--secondary), #000);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ========== LAYOUT PRINCIPAL ========== */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 60px;
        }

        /* ========== HEADER ========== */
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-bottom: 20px;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: var(--ai-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: var(--ai-glow);
        }

        .logo-text h1 {
            font-size: 22px;
            font-weight: 800;
            background: var(--ai-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-text p {
            font-size: 11px;
            color: var(--text-tertiary);
            letter-spacing: 1px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .account-type-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: var(--premium);
            color: #000;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .account-type-badge.basic {
            background: var(--basic);
            color: white;
        }

        /* ========== MENU LATERAL ========== */
        .side-menu {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 280px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border);
            padding: 20px;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .side-menu.active {
            transform: translateX(0);
        }

        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .menu-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }

        .menu-section {
            margin-bottom: 25px;
        }

        .menu-title {
            font-size: 12px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            padding-left: 10px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s;
            margin-bottom: 5px;
            border: 1px solid transparent;
            cursor: pointer;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            font-size: 14px;
            position: relative;
        }

        .menu-item:hover {
            background: var(--glass-hover);
            color: var(--text-primary);
            transform: translateX(5px);
        }

        .menu-item.active {
            background: var(--ai-gradient);
            color: white;
            border-color: var(--primary);
        }

        .menu-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .menu-item.premium-locked::after {
            content: 'PREMIUM';
            position: absolute;
            right: 10px;
            font-size: 10px;
            padding: 2px 6px;
            background: var(--premium);
            color: #000;
            border-radius: 10px;
            font-weight: bold;
        }

        /* ========== DASHBOARD ========== */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        @media (max-width: 1200px) {
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid var(--border);
            transition: all 0.3s;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            margin: 10px 0;
        }

        .stat-title {
            font-size: 14px;
            color: var(--text-tertiary);
            margin-bottom: 5px;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        @media (max-width: 992px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid var(--border);
            position: relative;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .chart-wrapper {
            height: 250px;
            position: relative;
        }

        /* ========== FORMULÁRIOS ========== */
        .form-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            padding: 20px;
            overflow-y: auto;
        }

        .form-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .form-container {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 25px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .form-title {
            font-size: 20px;
            font-weight: 700;
        }

        .form-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            background: var(--glass);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.2);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        /* ========== BOTÕES ========== */
        .btn {
            padding: 12px 24px;
            border-radius: var(--radius-md);
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--ai-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--ai-glow);
        }

        .btn-secondary {
            background: var(--glass);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--glass-hover);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-premium {
            background: var(--premium);
            color: #000;
            font-weight: 700;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-block {
            width: 100%;
        }

        /* ========== TRANSAÇÕES ========== */
        .transaction-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            transition: all 0.3s;
            cursor: pointer;
        }

        .transaction-card:hover {
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .transaction-category {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: var(--glass);
        }

        .transaction-amount {
            font-size: 18px;
            font-weight: 700;
        }

        .transaction-amount.income {
            color: var(--success);
        }

        .transaction-amount.expense {
            color: var(--danger);
        }

        .transaction-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .transaction-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .transaction-card:hover .transaction-actions {
            opacity: 1;
        }

        /* ========== IA ASSISTANT ========== */
        .ai-assistant {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .ai-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--ai-gradient);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: var(--ai-glow);
            transition: all 0.3s;
            position: relative;
        }

        .ai-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(0, 212, 170, 0.5);
        }

        .ai-button.listening::after {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border: 2px solid var(--danger);
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        .ai-button.speaking::after {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border: 2px solid var(--primary);
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        /* ========== INSIGHTS ========== */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .insight-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .insight-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--ai-gradient);
        }

        .insight-icon {
            width: 50px;
            height: 50px;
            background: var(--glass);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .insight-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .insight-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* ========== FUNCIONALIDADES GRID ========== */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .feature-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid var(--border);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--ai-gradient);
        }

        .feature-icon {
            width: 50px;
            height: 50px;
            background: var(--glass);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .feature-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .feature-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* ========== CONTAS BANCÁRIAS ========== */
        .accounts-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .account-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .account-card:hover {
            transform: translateX(5px);
            border-color: var(--primary);
        }

        .account-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .account-icon {
            width: 50px;
            height: 50px;
            background: var(--glass);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--primary);
        }

        .account-details h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .account-details p {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .account-balance {
            font-size: 20px;
            font-weight: 700;
        }

        /* ========== CARTÕES DE CRÉDITO ========== */
        .credit-cards-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .credit-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: var(--radius-lg);
            padding: 20px;
            color: white;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .credit-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 30px 30px;
            opacity: 0.3;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-chip {
            width: 40px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            position: relative;
        }

        .card-number {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            letter-spacing: 2px;
            margin-bottom: 15px;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ========== CATEGORIAS ========== */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .category-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid var(--border);
            transition: all 0.3s;
            cursor: pointer;
        }

        .category-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .category-icon {
            width: 45px;
            height: 45px;
            background: var(--glass);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--primary);
        }

        .category-name {
            font-weight: 600;
            font-size: 15px;
        }

        .category-stats {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* ========== OBJETIVOS ========== */
        .goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .goal-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .goal-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--ai-gradient);
        }

        .goal-progress {
            height: 8px;
            background: var(--glass);
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }

        .goal-progress-bar {
            height: 100%;
            background: var(--ai-gradient);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .goal-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* ========== MEMBROS ========== */
        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .member-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid var(--border);
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .member-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        .member-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--ai-gradient);
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .member-name {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .member-relationship {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* ========== DROPDOWN MENUS ========== */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background: var(--tertiary);
            min-width: 200px;
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            overflow: hidden;
            top: 100%;
            right: 0;
        }

        .dropdown-content a {
            color: var(--text-primary);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background 0.3s;
            font-size: 14px;
        }

        .dropdown-content a:hover {
            background: var(--glass-hover);
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        /* ========== ANIMAÇÕES ========== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        /* ========== UTILITIES ========== */
        .hidden { display: none !important; }
        .visible { display: block !important; }
        .flex { display: flex; }
        .grid { display: grid; }
        .gap-10 { gap: 10px; }
        .gap-15 { gap: 15px; }
        .gap-20 { gap: 20px; }
        .mb-15 { margin-bottom: 15px; }
        .mb-20 { margin-bottom: 20px; }
        .mb-25 { margin-bottom: 25px; }
        .mt-10 { margin-top: 10px; }
        .mt-15 { margin-top: 15px; }
        .mt-20 { margin-top: 20px; }
        .mt-25 { margin-top: 25px; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-primary { color: var(--primary); }
        .text-warning { color: var(--warning); }
        .text-premium { color: var(--premium); }
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: var(--primary);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-tertiary);
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            margin: 20px 0;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.3;
        }
        
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .premium-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--premium);
            color: #000;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }

        .premium-feature {
            position: relative;
            overflow: hidden;
        }

        .premium-feature::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.2), transparent);
            animation: shimmer 2s infinite;
        }

        /* ========== REPETIÇÃO DE DESPESAS ========== */
        .recurrence-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .recurrence-option {
            padding: 10px;
            border-radius: var(--radius-md);
            background: var(--glass);
            border: 1px solid var(--border);
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .recurrence-option:hover {
            background: var(--glass-hover);
        }

        .recurrence-option.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .installment-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .installment-input {
            width: 80px;
        }

        /* ========== RESPONSIVO ========== */
        @media (max-width: 768px) {
            .app-container {
                padding: 15px;
                padding-bottom: 80px;
            }
            
            .main-header {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .transaction-details {
                grid-template-columns: 1fr;
            }
            
            .insights-grid {
                grid-template-columns: 1fr;
            }
            
            .side-menu {
                width: 85%;
            }
            
            .features-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .categories-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .goals-grid {
                grid-template-columns: 1fr;
            }
            
            .members-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .categories-grid {
                grid-template-columns: 1fr;
            }
            
            .members-grid {
                grid-template-columns: 1fr;
            }
            
            .logo-text h1 {
                font-size: 18px;
            }
            
            .dropdown-content {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            }
        }
    
/* ===== PATCH: Settings Sheet ===== */
#settings-sheet-overlay{
  position:fixed; inset:0;
  background: rgba(0,0,0,.45);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  display:flex; align-items:flex-end; justify-content:center;
  z-index:9999;
}
.settings-sheet{
  width:min(720px, 96vw);
  max-height:85vh;
  background: var(--card-bg);
  border:1px solid var(--border);
  border-radius: 22px 22px 16px 16px;
  overflow:hidden;
  box-shadow: 0 20px 60px rgba(0,0,0,.45);
}
.settings-sheet-header{
  display:flex; align-items:center; justify-content:space-between;
  padding:14px 16px;
  border-bottom:1px solid var(--border);
}
.settings-sheet-title{ font-weight:700; }
.settings-sheet-close{
  width:38px;height:38px;border-radius:12px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.06);
  color: var(--text-primary);
}
.settings-sheet-body{
  padding:16px;
  overflow:auto;
}
.sheet-row{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px;
  padding:14px 12px;
  border:1px solid var(--border);
  border-radius: 16px;
  background: rgba(255,255,255,.04);
}
.sheet-section{
  border:1px solid var(--border);
  border-radius: 16px;
  padding:14px 12px;
  background: rgba(255,255,255,.04);
}


/* ===== K-DEV RESPONSIVE PREMIUM CHART PATCH ===== */
.chart-wrapper {
  height: auto !important;
  min-height: 180px;
  max-height: 320px;
}
.chart-wrapper canvas {
  width: 100% !important;
  height: auto !important;
  max-height: 320px !important;
}
/* ===== END PATCH ===== */


/* ===== K-DEV: TRANSAÇÕES • CALENDÁRIO + FILTROS ===== */
.finance-calendar-card{
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 18px;
  padding: 14px;
  margin: 6px 0 18px 0;
  backdrop-filter: blur(12px);
}
.calendar-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
}
.calendar-title{
  font-weight:800;
  text-transform: capitalize;
  opacity:.95;
}
.tx-cal-weekdays{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
  font-size:12px;
  opacity:.75;
  margin-bottom:6px;
  text-align:center;
}
.tx-cal-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
}
.tx-cal-cell{
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 12px;
  padding: 8px 6px;
  min-height: 52px;
  text-align:center;
  cursor:pointer;
  user-select:none;
}
.tx-cal-cell.muted{
  opacity:.35;
}
.tx-cal-cell.selected{
  outline: 2px solid rgba(255,255,255,0.35);
  background: rgba(255,255,255,0.06);
}
.tx-cal-daynum{ font-weight:800; }
.tx-cal-dots{ margin-top:4px; display:flex; justify-content:center; gap:4px; }
.tx-dot{ width:7px; height:7px; border-radius:50%; display:inline-block; }
.tx-dot.green{ background: var(--success, #2ee59d); }
.tx-dot.red{ background: var(--danger, #ff5a6a); }
.tx-cal-legend{
  margin-top:10px;
  font-size:12px;
  opacity:.85;
  display:flex;
  flex-wrap:wrap;
  align-items:center;
}
.tx-cal-daylist{ margin-top:10px; }


/* ===== K-DEV AUTH UI ===== */
.kdev-logout-btn{
  border: 1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.08);
  color: inherit;
  border-radius: 12px;
  padding: 8px 10px;
  font-weight: 700;
}
.kdev-logout-btn:active{ transform: scale(0.98); }

</style>
</head>
<body>
    <!-- MENU LATERAL -->
    <div class="side-menu" id="side-menu">
        <div class="menu-header">
            <div>
                <div style="font-weight: 700; font-size: 18px;">Finanças IA Pro Premium</div>
                <div style="font-size: 12px; color: var(--text-tertiary);">Menu Principal</div>
            </div>
            <button class="menu-close" id="menu-close">&times;</button>
        </div>
        
        <div class="menu-section">
            <div class="menu-title">Principal</div>
            <button class="menu-item active" data-section="dashboard">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </button>
            <button class="menu-item" data-section="transactions">
                <i class="fas fa-exchange-alt"></i>
                <span>Transações</span>
            </button>
            <button class="menu-item" data-section="accounts">
                <i class="fas fa-university"></i>
                <span>Contas Bancárias</span>
            </button>
            <button class="menu-item" data-section="credit-cards">
                <i class="fas fa-credit-card"></i>
                <span>Cartões de Crédito</span>
            </button>
        </div>
        
        <div class="menu-section">
            <div class="menu-title">Categorias</div>
            <button class="menu-item" data-section="categories">
                <i class="fas fa-tags"></i>
                <span>Categorias</span>
            </button>
            <button class="menu-item" data-section="budget">
                <i class="fas fa-chart-pie"></i>
                <span>Orçamento</span>
            </button>
        </div>
        
        <div class="menu-section">
            <div class="menu-title">Planejamento</div>
            <button class="menu-item" data-section="goals">
                <i class="fas fa-bullseye"></i>
                <span>Objetivos</span>
            </button>
            <button class="menu-item" data-section="members">
                <i class="fas fa-users"></i>
                <span>Membros</span>
            </button>
            <button class="menu-item" data-section="recurring">
                <i class="fas fa-redo"></i>
                <span>Despesas Recorrentes</span>
            </button>
        </div>
        
        <div class="menu-section">
            <div class="menu-title">Relatórios</div>
            <button class="menu-item" data-section="reports">
                <i class="fas fa-chart-bar"></i>
                <span>Relatórios</span>
            </button>
            <button class="menu-item premium-locked" data-section="insights">
                <i class="fas fa-lightbulb"></i>
                <span>Insights IA</span>
            </button>
        </div>
        
        <div class="menu-section">
            <div class="menu-title">Configurações</div>
            <button class="menu-item" data-section="settings">
                <i class="fas fa-cog"></i>
                <span>Configurações</span>
            </button>
        </div>
        
        <div style="margin-top: 30px; padding: 20px; background: rgba(0, 212, 170, 0.1); border-radius: var(--radius-md); border: 1px solid rgba(0, 212, 170, 0.3);">
            <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 10px;">Tipo de Conta</div>
            <div style="font-weight: 600; color: var(--primary);" id="menu-account-type">Plano Premium</div>
            <button class="btn btn-premium" style="width: 100%; margin-top: 15px;" onclick="toggleAccountType()">
                <i class="fas fa-crown"></i> <span id="menu-account-status">Ativo</span>
            </button>
        </div>
    </div>

    <!-- CONTEÚDO PRINCIPAL -->
    <div class="app-container">
        <!-- HEADER -->
        <header class="main-header">
            <div class="logo">
                <button class="menu-toggle" id="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <div class="logo-text">
                    <h1>Finanças IA Pro Premium</h1>
                    <p>SISTEMA COMPLETO • IA AVANÇADA</p>
                </div>
            </div>
            <div class="header-actions">
<button class="kdev-logout-btn" onclick="fp_logout()" title="Sair">Sair</button>
                <div class="account-type-badge" id="header-account-type">
                    <i class="fas fa-crown"></i> PREMIUM
                </div>
                <button class="icon-btn" id="theme-toggle">
                    <i class="fas fa-sun"></i>
                </button>
                <div class="dropdown">
                    <button class="icon-btn" id="notification-btn">
                        <i class="fas fa-bell"></i>
                    </button>
                    <div class="dropdown-content">
                        <a href="#" onclick="loadSection('insights')"><i class="fas fa-chart-line"></i> Análise do Mês</a>
                        <a href="#" onclick="showNotification('Nenhum alerta no momento', 'info')"><i class="fas fa-exclamation-circle"></i> Alertas de Gastos</a>
                        <a href="#" onclick="openAIPanel()"><i class="fas fa-lightbulb"></i> Insights da IA</a>
                        <a href="#" onclick="loadSection('recurring')"><i class="fas fa-calendar-alt"></i> Vencimentos</a>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="btn btn-primary" id="add-transaction-btn">
                        <i class="fas fa-plus"></i> Nova Transação
                    </button>
                    <div class="dropdown-content">
                        <a href="#" onclick="openTransactionForm('income')"><i class="fas fa-arrow-down"></i> Nova Receita</a>
                        <a href="#" onclick="openTransactionForm('expense')"><i class="fas fa-arrow-up"></i> Nova Despesa</a>
                        <a href="#" onclick="openTransactionForm('transfer')"><i class="fas fa-exchange-alt"></i> Transferência</a>
                        <a href="#" onclick="openRecurringForm()"><i class="fas fa-redo"></i> Despesa Recorrente</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- CONTEÚDO DINÂMICO -->
        <div id="content-area">
            <!-- O conteúdo será carregado dinamicamente aqui -->
        </div>
    </div>

    <!-- BOTÃO DA IA -->
    <div class="ai-assistant">
        <button class="ai-button" id="ai-button">
            <i class="fas fa-robot"></i>
        </button>
    </div>

    <!-- FORMULÁRIO DE TRANSAÇÃO AVANÇADO -->
    <div class="form-overlay" id="transaction-form">
        <div class="form-container">
            <div class="form-header">
                <div class="form-title">Nova Transação</div>
                <button class="form-close">&times;</button>
            </div>
            <form id="transaction-form-data">
                <div class="form-group">
                    <div class="quick-actions">
                        <button type="button" class="btn btn-secondary active" data-type="expense">
                            <i class="fas fa-arrow-up"></i> Despesa
                        </button>
                        <button type="button" class="btn btn-secondary" data-type="income">
                            <i class="fas fa-arrow-down"></i> Receita
                        </button>
                        <button type="button" class="btn btn-secondary" data-type="transfer">
                            <i class="fas fa-exchange-alt"></i> Transferência
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Valor (R$)</label>
                    <input type="number" step="0.01" class="form-input" id="amount" placeholder="0,00" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descrição</label>
                    <input type="text" class="form-input" id="description" placeholder="Exemplo: tênis novo" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Categoria</label>
                        <select class="form-select" id="category" required>
                            <option value="">Selecione uma categoria</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Subcategoria</label>
                        <select class="form-select" id="subcategory">
                            <option value="">Opcional</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Conta *</label>
                        <select class="form-select" id="account" required>
                            <option value="">Selecione uma conta</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Forma de Pagamento *</label>
                        <div class="quick-actions">
                            <button type="button" class="btn btn-secondary active" data-payment="credit">
                                <i class="fas fa-credit-card"></i> Crédito
                            </button>
                            <button type="button" class="btn btn-secondary" data-payment="debit">
                                <i class="fas fa-money-bill"></i> Débito
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data *</label>
                        <div class="quick-actions">
                            <button type="button" class="btn btn-secondary active" id="date-today">
                                Hoje
                            </button>
                            <input type="date" class="form-input" id="date" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Condição de Pagamento *</label>
                        <div class="quick-actions">
                            <button type="button" class="btn btn-secondary active" data-installment="single">
                                À vista
                            </button>
                            <button type="button" class="btn btn-secondary" data-installment="installment">
                                Parcelado
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" id="installment-section" style="display: none;">
                    <label class="form-label">Parcelas</label>
                    <div class="installment-controls">
                        <input type="number" class="form-input installment-input" id="installment-count" min="2" max="60" value="2">
                        <select class="form-select" id="installment-frequency">
                            <option value="monthly">Mensal</option>
                            <option value="weekly">Semanal</option>
                            <option value="biweekly">Quinzenal</option>
                        </select>
                        <div class="form-input" style="background: var(--glass);">
                            Total: <span id="installment-total">R$ 0,00</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Marcar como pago</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="paid" checked>
                        <span>Já paguei</span>
                    </div>
                    <small style="color: var(--text-tertiary); font-size: 12px;">
                        Ao desativar, o valor do gasto não será considerado no saldo do mês
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Repetir transação</label>
                    <div class="recurrence-options">
                        <div class="recurrence-option" data-recurrence="none">Não repetir</div>
                        <div class="recurrence-option" data-recurrence="monthly">Mensal</div>
                        <div class="recurrence-option" data-recurrence="weekly">Semanal</div>
                        <div class="recurrence-option" data-recurrence="yearly">Anual</div>
                    </div>
                    <div style="margin-top: 10px; display: none;" id="recurrence-details">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Início</label>
                                <input type="date" class="form-input" id="recurrence-start">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fim</label>
                                <input type="date" class="form-input" id="recurrence-end">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Membro</label>
                    <select class="form-select" id="member">
                        <option value="">Escolher membro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notas (opcional)</label>
                    <textarea class="form-textarea" id="notes" rows="2" placeholder="Observações adicionais..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="duplicate-transaction">
                        <i class="fas fa-copy"></i> Duplicar
                    </button>
                    <button type="button" class="btn btn-secondary form-close">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Registrar Transação
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- PAINEL DA IA AVANÇADA -->
    <div class="form-overlay" id="ai-panel">
        <div class="form-container" style="max-width: 700px;">
            <div class="form-header">
                <div class="form-title">
                    <i class="fas fa-robot"></i> Assistente Financeiro IA Avançado
                </div>
                <button class="form-close">&times;</button>
            </div>
            
            <div style="background: rgba(0, 212, 170, 0.1); padding: 15px; border-radius: var(--radius-md); margin-bottom: 20px; border: 1px solid rgba(0, 212, 170, 0.3);">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <div style="width: 8px; height: 8px; background: #30D158; border-radius: 50%;"></div>
                    <div style="font-size: 14px;">IA Online • Análise Inteligente Ativa</div>
                </div>
                <div style="font-size: 12px; color: var(--text-tertiary);">
                    Posso analisar seus gastos, sugerir economias, criar orçamentos e muito mais!
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <button class="btn btn-primary" id="ai-voice-start">
                    <i class="fas fa-microphone"></i> Comando por Voz
                </button>
                <button class="btn btn-secondary" id="ai-analyze-deep">
                    <i class="fas fa-chart-line"></i> Análise Profunda
                </button>
                <button class="btn btn-secondary" id="ai-suggest-budget">
                    <i class="fas fa-lightbulb"></i> Sugerir Orçamento
                </button>
                <button class="btn btn-secondary" id="ai-forecast">
                    <i class="fas fa-crystal-ball"></i> Previsão Financeira
                </button>
            </div>
            
            <div id="ai-chat" style="height: 300px; overflow-y: auto; margin-bottom: 20px; padding: 15px; background: var(--glass); border-radius: var(--radius-md); border: 1px solid var(--border);">
                <div class="ai-message">
                    <div style="font-weight: 600; color: var(--primary); margin-bottom: 5px;">Assistente IA:</div>
                    <div>Olá! Sou seu assistente financeiro inteligente avançado. Como posso ajudar você hoje?</div>
                    <div style="margin-top: 10px; font-size: 14px;">
                        <strong>Comandos disponíveis:</strong><br>
                        • "Analisar meus gastos do mês"<br>
                        • "Sugerir economia em [categoria]"<br>
                        • "Criar orçamento mensal"<br>
                        • "Prever finanças próximos 3 meses"<br>
                        • "Identificar gastos desnecessários"
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Pergunte ou dê um comando:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" class="form-input" id="ai-question" placeholder="Digite ou fale seu comando...">
                    <button class="btn btn-primary" id="ai-send">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <button class="btn btn-secondary" id="ai-voice-input">
                        <i class="fas fa-microphone-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
/* ================================================================
   FINANÇAS IA PRO PREMIUM - SISTEMA COMPLETO APRIMORADO
   Com contas Premium/Básica e IA Avançada
================================================================ */

// ========== CONFIGURAÇÃO ==========
const STORAGE_KEY = "financas_ia_pro_premium";
const DateTime = luxon.DateTime;

// Estado do aplicativo
let AppState = {
    accounts: [
        {
            id: 1,
            name: "Minha Carteira",
            type: "cash",
            balance: 124.88,
            bank: "Dinheiro Físico",
            manual: true,
            color: "#00D4AA"
        },
        {
            id: 2,
            name: "Banco Inter",
            type: "checking",
            balance: 2500.00,
            bank: "Banco Inter S.A.",
            manual: true,
            color: "#6C63FF"
        },
        {
            id: 3,
            name: "Nubank",
            type: "checking",
            balance: 1500.00,
            bank: "Nu Pagamentos S.A.",
            manual: true,
            color: "#8A05BE"
        }
    ],
    
    creditCards: [
        {
            id: 1,
            name: "Nubank",
            number: "**** **** **** 1234",
            limit: 5000,
            current: 1250.50,
            dueDate: "10",
            color: "#8A05BE"
        },
        {
            id: 2,
            name: "Inter",
            number: "**** **** **** 5678",
            limit: 3000,
            current: 800.00,
            dueDate: "15",
            color: "#FF6B00"
        }
    ],
    
    categories: {
        expenses: [
            { id: 1, name: "Alimentação", icon: "fa-utensils", color: "#FF6B8B", subcategories: ["Supermercado", "Restaurante", "Lanches", "Delivery"] },
            { id: 2, name: "Assinaturas", icon: "fa-receipt", color: "#FF9500", subcategories: ["Streaming", "Software", "Revistas", "Serviços"] },
            { id: 3, name: "Casa", icon: "fa-home", color: "#00D4AA", subcategories: ["Aluguel", "Condomínio", "Manutenção", "Decoração"] },
            { id: 4, name: "Dívidas", icon: "fa-file-invoice-dollar", color: "#FF453A", subcategories: ["Empréstimo", "Financiamento", "Cartão", "Outros"] },
            { id: 5, name: "Educação", icon: "fa-graduation-cap", color: "#5AC8FA", subcategories: ["Curso", "Material", "Faculdade", "Livros"] },
            { id: 6, name: "Empresarial", icon: "fa-briefcase", color: "#AF52DE", subcategories: ["Equipamento", "Serviços", "Impostos", "Marketing"] },
            { id: 7, name: "Lazer", icon: "fa-gamepad", color: "#6C63FF", subcategories: ["Cinema", "Games", "Passeios", "Hobbies"] },
            { id: 8, name: "Objetivos de vida", icon: "fa-bullseye", color: "#30D158", subcategories: ["Viagem", "Carro", "Casa Própria", "Investimento"] },
            { id: 9, name: "Outros (gastos)", icon: "fa-question-circle", color: "#8E8E93", subcategories: ["Diversos", "Imprevistos"] },
            { id: 10, name: "Pessoal", icon: "fa-user", color: "#FF9500", subcategories: ["Cuidados", "Beleza", "Roupas", "Acessórios"] },
            { id: 11, name: "Pet", icon: "fa-paw", color: "#FF6B8B", subcategories: ["Ração", "Veterinário", "Brinquedos", "Banho"] },
            { id: 12, name: "Saúde", icon: "fa-heartbeat", color: "#FF453A", subcategories: ["Plano de Saúde", "Remédios", "Consultas", "Exames"] },
            { id: 13, name: "Serviços", icon: "fa-tools", color: "#5AC8FA", subcategories: ["Internet", "Telefone", "Manutenção", "Limpeza"] },
            { id: 14, name: "Taxas", icon: "fa-file-invoice", color: "#8E8E93", subcategories: ["Bancárias", "Governamentais", "Serviços"] },
            { id: 15, name: "Transferências", icon: "fa-exchange-alt", color: "#AF52DE", subcategories: ["Entre Contas", "Para Terceiros"] },
            { id: 16, name: "Transporte", icon: "fa-car", color: "#00D4AA", subcategories: ["Combustível", "Ônibus/Uber", "Manutenção", "Estacionamento"] },
            { id: 17, name: "Vestuário", icon: "fa-tshirt", color: "#6C63FF", subcategories: ["Roupas", "Calçados", "Acessórios"] },
            { id: 18, name: "Viagem", icon: "fa-plane", color: "#FF9500", subcategories: ["Passagens", "Hospedagem", "Alimentação", "Passeios"] }
        ],
        income: [
            { id: 101, name: "Salário", icon: "fa-money-bill-wave", color: "#30D158", subcategories: ["Principal", "Extra"] },
            { id: 102, name: "Freelance", icon: "fa-laptop-code", color: "#5AC8FA", subcategories: ["Projetos", "Consultoria"] },
            { id: 103, name: "Investimentos", icon: "fa-chart-line", color: "#00D4AA", subcategories: ["Dividendos", "Renda Fixa", "Ações"] },
            { id: 104, name: "Presente", icon: "fa-gift", color: "#FF6B8B", subcategories: ["Familiares", "Amigos"] },
            { id: 105, name: "Aluguel", icon: "fa-home", color: "#AF52DE", subcategories: ["Imóvel", "Equipamentos"] },
            { id: 106, name: "Reembolso", icon: "fa-undo", color: "#FF9500", subcategories: ["Saúde", "Viagem", "Empresa"] }
        ]
    },
    
    transactions: [
        {
            id: 1,
            date: DateTime.now().toISODate(),
            type: "income",
            amount: 124.88,
            category: "Salário",
            subcategory: "Principal",
            description: "Depósito salário",
            account: "Banco Inter",
            paymentMethod: "debit",
            installments: 1,
            paid: true,
            member: null,
            notes: "",
            recurrence: "none"
        },
        {
            id: 2,
            date: DateTime.now().toISODate(),
            type: "expense",
            amount: 89.90,
            category: "Alimentação",
            subcategory: "Supermercado",
            description: "Compras semanais",
            account: "Minha Carteira",
            paymentMethod: "debit",
            installments: 1,
            paid: true,
            member: null,
            notes: "",
            recurrence: "none"
        },
        {
            id: 3,
            date: DateTime.now().minus({days: 2}).toISODate(),
            type: "expense",
            amount: 49.90,
            category: "Assinaturas",
            subcategory: "Streaming",
            description: "Netflix",
            account: "Nubank",
            paymentMethod: "credit",
            installments: 1,
            paid: true,
            member: null,
            notes: "Assinatura mensal",
            recurrence: "monthly"
        }
    ],
    
    members: [
        {
            id: 1,
            name: "Maria Silva",
            birthdate: "1990-05-15",
            relationship: "spouse",
            avatar: null,
            createdAt: DateTime.now().minus({months: 1}).toISODate()
        },
        {
            id: 2,
            name: "João Silva",
            birthdate: "2015-08-20",
            relationship: "child",
            avatar: null,
            createdAt: DateTime.now().minus({months: 1}).toISODate()
        }
    ],
    
    goals: [
        {
            id: 1,
            name: "Viagem para Europa",
            target: 15000,
            current: 3500,
            deadline: "2024-12-31",
            color: "#00D4AA",
            createdAt: DateTime.now().minus({months: 3}).toISODate()
        },
        {
            id: 2,
            name: "Notebook Novo",
            target: 4500,
            current: 1200,
            deadline: "2024-06-30",
            color: "#6C63FF",
            createdAt: DateTime.now().minus({months: 1}).toISODate()
        }
    ],
    
    budgets: [
        {
            id: 1,
            category: "Alimentação",
            limit: 800,
            spent: 450,
            month: DateTime.now().toFormat('yyyy-MM'),
            createdAt: DateTime.now().startOf('month').toISODate()
        },
        {
            id: 2,
            category: "Transporte",
            limit: 500,
            spent: 320,
            month: DateTime.now().toFormat('yyyy-MM'),
            createdAt: DateTime.now().startOf('month').toISODate()
        }
    ],
    
    recurringTransactions: [],
    
    settings: {
        theme: "dark",
        currency: "BRL",
        aiEnabled: true,
        voiceControl: true,
        autoCategorization: true,
        notifications: true,
        accountType: "premium",
        ttsEnabled: false,
        advancedAnalytics: true
    },
    
    currentSection: "dashboard"
};

// ========== FUNÇÕES DE ACESSO PREMIUM ==========
function hasPremiumAccess(){ return (AppState && AppState.settings && AppState.settings.accountType === 'premium'); }

function toggleAccountType() {
    if (AppState.settings.accountType === "premium") {
        if (confirm("Deseja mudar para conta Básica? Você perderá acesso a recursos avançados como IA, insights premium e gráficos detalhados.")) {
            AppState.settings.accountType = "basic";
            AppState.settings.aiEnabled = false;
            AppState.settings.advancedAnalytics = false;
            AppState.settings.ttsEnabled = false;
            saveAppData();
            showNotification("Conta alterada para Básica", "info");
            updateAccountTypeUI();
            loadSection(AppState.currentSection);
        }
    } else {
        if (confirm("Ativar conta Premium para acessar todos os recursos avançados?")) {
            fp_applyUserPlanToAppState();
            AppState.settings.aiEnabled = true;
            AppState.settings.advancedAnalytics = true;
            saveAppData();
            showNotification("Conta Premium ativada!", "success");
            updateAccountTypeUI();
            loadSection(AppState.currentSection);
        }
    }
}

function updateAccountTypeUI() {
    const headerBadge = document.getElementById('header-account-type');
    const menuStatus = document.getElementById('menu-account-status');
    const menuType = document.getElementById('menu-account-type');
    
    if (hasPremiumAccess()) {
        headerBadge.innerHTML = '<i class="fas fa-crown"></i> PREMIUM';
        headerBadge.className = 'account-type-badge';
        menuStatus.textContent = 'Ativo';
        menuType.textContent = 'Plano Premium';
        menuType.style.color = 'var(--primary)';
    } else {
        headerBadge.innerHTML = '<i class="fas fa-user"></i> BÁSICA';
        headerBadge.className = 'account-type-badge basic';
        menuStatus.textContent = 'Básica';
        menuType.textContent = 'Conta Básica';
        menuType.style.color = 'var(--basic)';
    }
}

// ========== INICIALIZAÇÃO ==========
document.addEventListener('DOMContentLoaded', () => {
    console.log('🚀 Iniciando Finanças IA Pro Premium...');
    
    // Carrega dados salvos
    loadAppData();
    // PATCH: pós-load
    AppState.settings = AppState.settings || {};
    fp_applyUserPlanToAppState();
    document.documentElement.setAttribute('data-theme', AppState.settings.theme || 'dark');
    // Configura data atual
    document.getElementById('date').value = DateTime.now().toISODate();
    document.getElementById('recurrence-start').value = DateTime.now().toISODate();
    document.getElementById('recurrence-end').value = DateTime.now().plus({months: 12}).toISODate();
    
    // Inicializa navegação
    initNavigation();
    
    // Inicializa formulários
    initForms();
    
    // Inicializa IA avançada
    initAdvancedAI();
    
    // Atualiza UI do tipo de conta
    fp_applyUserPlanToAppState();
    updateAccountTypeUI();
    
    // Carrega seção inicial
    loadSection('dashboard');
    
    console.log('✅ Sistema Premium pronto e 100% funcional!');
});

// ========== GERENCIAMENTO DE DADOS ==========
function loadAppData() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const data = JSON.parse(saved);
            Object.assign(AppState, data);
        }
        // PATCH: garante defaults e libera premium
        AppState.settings = AppState.settings || {};
        fp_applyUserPlanToAppState();
        if (!AppState.settings.theme) AppState.settings.theme = 'dark';
        if (AppState.settings.currency == null) AppState.settings.currency = 'BRL';
        if (AppState.settings.aiEnabled == null) AppState.settings.aiEnabled = true;
        if (AppState.settings.voiceControl == null) AppState.settings.voiceControl = true;
        if (AppState.settings.autoCategorization == null) AppState.settings.autoCategorization = true;
        if (AppState.settings.notifications == null) AppState.settings.notifications = true;
        if (AppState.settings.ttsEnabled == null) AppState.settings.ttsEnabled = true;
        if (AppState.settings.advancedAnalytics == null) AppState.settings.advancedAnalytics = true;
    } catch (error) {
        console.error('Erro ao carregar dados:', error);
    }
}

function saveAppData() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(AppState));
    } catch (error) {
        console.error('Erro ao salvar dados:', error);
    }
}

// ========== NAVEGAÇÃO ==========
function initNavigation() {
    // Menu lateral
    document.getElementById('menu-toggle').addEventListener('click', () => {
        document.getElementById('side-menu').classList.add('active');
    });
    
    document.getElementById('menu-close').addEventListener('click', () => {
        document.getElementById('side-menu').classList.remove('active');
    });
    
    // Itens do menu lateral
    document.querySelectorAll('.side-menu .menu-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.dataset.section;
            
            // Verifica acesso premium para seções bloqueadas
            if (this.classList.contains('premium-locked') && !hasPremiumAccess()) {
                showNotification('Esta seção requer conta Premium', 'warning');
                return;
            }
            
            // Atualiza menu ativo
            document.querySelectorAll('.side-menu .menu-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
            
            // Fecha menu lateral no mobile
            if (window.innerWidth < 768) {
                document.getElementById('side-menu').classList.remove('active');
            }
            
            // Carrega seção
            loadSection(section);
        });
    });
}

// ========== CARREGAMENTO DE SEÇÕES ==========
function loadSection(section) {
    console.log(`📱 Carregando seção: ${section}`);
    AppState.currentSection = section;
    const container = document.getElementById('content-area');
    
    // Verifica acesso premium para certas seções
    if (!hasPremiumAccess() && ['insights', 'reports'].includes(section)) {
        container.innerHTML = getPremiumLockedHTML(section);
        updatePageTitle(section);
        return;
    }
    
    switch(section) {
        case 'dashboard':
            container.innerHTML = getDashboardHTML();
            initDashboard();
            break;
        case 'transactions':
            container.innerHTML = getTransactionsHTML();
            initTransactions();
            break;
        case 'accounts':
            container.innerHTML = getAccountsHTML();
            initAccounts();
            break;
        case 'credit-cards':
            container.innerHTML = getCreditCardsHTML();
            initCreditCards();
            break;
        case 'categories':
            container.innerHTML = getCategoriesHTML();
            initCategories();
            break;
        case 'budget':
            container.innerHTML = getBudgetHTML();
            initBudget();
            break;
        case 'goals':
            container.innerHTML = getGoalsHTML();
            initGoals();
            break;
        case 'members':
            container.innerHTML = getMembersHTML();
            initMembers();
            break;
        case 'recurring':
            container.innerHTML = getRecurringHTML();
            initRecurring();
            break;
        case 'reports':
            container.innerHTML = getReportsHTML();
            initReports();
            break;
        case 'insights':
            container.innerHTML = getInsightsHTML();
            initInsights();
            break;
        case 'settings':
            container.innerHTML = getSettingsHTML();
            initSettings();
            break;
        default:
            container.innerHTML = getDashboardHTML();
            initDashboard();
    }
    
    // Atualiza título da página
    updatePageTitle(section);
}

function getPremiumLockedHTML(section) {
    const sectionNames = {
        'insights': 'Insights da IA',
        'reports': 'Relatórios Avançados'
    };
    
    return `
        <div class="empty-state" style="min-height: 60vh;">
            <i class="fas fa-crown" style="font-size: 64px; color: var(--premium); margin-bottom: 20px;"></i>
            <div style="font-size: 24px; font-weight: 700; margin-bottom: 10px;">Recurso Premium</div>
            <div style="font-size: 16px; color: var(--text-secondary); margin-bottom: 20px;">
                ${sectionNames[section]} está disponível apenas para contas Premium
            </div>
            <div style="max-width: 400px; margin: 0 auto;">
                <div style="background: var(--card-bg); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border); margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">Benefícios Premium:</div>
                    <div style="font-size: 14px; line-height: 1.6;">
                        • IA Financeira Avançada<br>
                        • Insights e Análises Profundas<br>
                        • Relatórios Detalhados<br>
                        • Gráficos Avançados<br>
                        • Previsões Financeiras<br>
                        • Assistente por Voz<br>
                        • Metas Inteligentes
                    </div>
                </div>
                <button class="btn btn-premium" onclick="toggleAccountType()" style="width: 100%;">
                    <i class="fas fa-crown"></i> Ativar Conta Premium
                </button>
                <button class="btn btn-secondary mt-10" onclick="loadSection('dashboard')" style="width: 100%;">
                    Voltar ao Dashboard
                </button>
            </div>
        </div>
    `;
}

function updatePageTitle(section) {
    const titles = {
        'dashboard': 'Dashboard Inteligente',
        'transactions': 'Transações',
        'accounts': 'Contas Bancárias',
        'credit-cards': 'Cartões de Crédito',
        'categories': 'Categorias',
        'budget': 'Orçamento',
        'goals': 'Objetivos',
        'members': 'Membros',
        'recurring': 'Despesas Recorrentes',
        'reports': 'Relatórios',
        'insights': 'Insights IA',
        'settings': 'Configurações'
    };
    
    document.title = `Finanças IA Pro Premium - ${titles[section] || 'Dashboard'}`;
}

// ========== DASHBOARD ==========
function getDashboardHTML() {
    const totalBalance = AppState.accounts.reduce((sum, acc) => sum + acc.balance, 0);
    const today = DateTime.now().toISODate();
    const monthStart = DateTime.now().startOf('month').toISODate();
    const monthEnd = DateTime.now().endOf('month').toISODate();
    
    const monthTransactions = AppState.transactions.filter(t => 
        t.date >= monthStart && t.date <= monthEnd
    );
    
    const monthIncome = monthTransactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const monthExpense = monthTransactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const todayIncome = AppState.transactions
        .filter(t => t.type === 'income' && t.date === today)
        .reduce((sum, t) => sum + t.amount, 0);
    
    const todayExpense = AppState.transactions
        .filter(t => t.type === 'expense' && t.date === today)
        .reduce((sum, t) => sum + t.amount, 0);
    
    const monthlySavingsRate = monthIncome > 0 ? ((monthIncome - monthExpense) / monthIncome * 100).toFixed(1) : 0;
    const avgDailyExpense = (monthExpense / DateTime.now().day).toFixed(2);
    
    // Análise de fluxo de caixa
    const cashFlow = monthIncome - monthExpense;
    const cashFlowStatus = cashFlow >= 0 ? 'positive' : 'negative';
    const cashFlowIcon = cashFlow >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
    const cashFlowColor = cashFlow >= 0 ? 'var(--success)' : 'var(--danger)';
    
    return `
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-title">Saldo Total</div>
                <div class="stat-value text-primary">${formatCurrency(totalBalance)}</div>
                <div class="stat-title">Disponível para uso</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-title">Receitas Mês</div>
                <div class="stat-value text-success">${formatCurrency(monthIncome)}</div>
                <div class="stat-title">+${formatCurrency(todayIncome)} hoje</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-title">Despesas Mês</div>
                <div class="stat-value text-danger">${formatCurrency(monthExpense)}</div>
                <div class="stat-title">${formatCurrency(todayExpense)} hoje</div>
            </div>
            
            <div class="stat-card" style="border-color: ${cashFlowColor};">
                <div class="stat-title">Fluxo de Caixa</div>
                <div class="stat-value" style="color: ${cashFlowColor};">
                    <i class="fas ${cashFlowIcon}"></i> ${formatCurrency(Math.abs(cashFlow))}
                </div>
                <div class="stat-title" style="color: ${cashFlowColor};">
                    ${cashFlow >= 0 ? 'Superávit' : 'Déficit'} do Mês
                </div>
            </div>
        </div>
        
        ${hasPremiumAccess() ? `
        <div class="charts-container">
            <div class="chart-card">
                <div class="chart-title">Distribuição por Categoria</div>
                <div class="chart-wrapper">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">Evolução Mensal</div>
                <div class="chart-wrapper">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="insights-grid">
            <div class="insight-card">
                <div class="insight-icon">
                    <i class="fas fa-lightbulb"></i>
                </div>
                <div class="insight-title">Insight da IA</div>
                <div class="insight-description" id="ai-insight-1">
                    Analisando seus dados financeiros...
                </div>
            </div>
            
            <div class="insight-card">
                <div class="insight-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="insight-title">Alerta de Gastos</div>
                <div class="insight-description" id="ai-insight-2">
                    Monitorando seus padrões...
                </div>
            </div>
            
            <div class="insight-card">
                <div class="insight-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="insight-title">Previsão</div>
                <div class="insight-description" id="ai-insight-3">
                    Calculando projeções...
                </div>
            </div>
        </div>
        ` : `
        <div style="background: var(--card-bg); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border); margin-bottom: 25px; text-align: center;">
            <i class="fas fa-chart-line" style="font-size: 36px; color: var(--premium); margin-bottom: 10px;"></i>
            <div style="font-weight: 600; margin-bottom: 5px;">Análises Premium Disponíveis</div>
            <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">
                Ative a conta Premium para acessar gráficos avançados e insights da IA
            </div>
            <button class="btn btn-premium" onclick="toggleAccountType()">
                <i class="fas fa-crown"></i> Ativar Premium
            </button>
        </div>
        `}
        
        <div class="quick-actions mt-20">
            <button class="btn btn-primary" onclick="openTransactionForm('income')">
                <i class="fas fa-arrow-down"></i> Nova Receita
            </button>
            <button class="btn btn-secondary" onclick="openTransactionForm('expense')">
                <i class="fas fa-arrow-up"></i> Nova Despesa
            </button>
            ${hasPremiumAccess() ? `
            <button class="btn btn-secondary" onclick="openAIPanel()">
                <i class="fas fa-robot"></i> Consultar IA
            </button>
            ` : ''}
        </div>
        
        <h3 class="section-title mt-25">
            <i class="fas fa-history"></i> Transações Recentes
        </h3>
        
        <div id="recent-transactions">
            <!-- Transações serão carregadas aqui -->
        </div>
    `;
}

function initDashboard() {
    // Carrega gráficos se tiver acesso premium
    setTimeout(() => {
        if (hasPremiumAccess()) {
            renderCategoryChart();
            renderMonthlyChart();
            generateAIInsights();
        }
    }, 100);
    
    // Carrega transações recentes
    loadRecentTransactions();
}

function renderCategoryChart() {
    const ctx = document.getElementById('categoryChart');
    if (!ctx) return;
    
    const monthStart = DateTime.now().startOf('month').toISODate();
    const monthEnd = DateTime.now().endOf('month').toISODate();
    
    const monthExpenses = AppState.transactions.filter(t => 
        t.type === 'expense' && t.date >= monthStart && t.date <= monthEnd
    );
    
    const categoryTotals = {};
    monthExpenses.forEach(transaction => {
        const category = transaction.category;
        categoryTotals[category] = (categoryTotals[category] || 0) + transaction.amount;
    });
    
    const labels = Object.keys(categoryTotals);
    const data = Object.values(categoryTotals);
    const colors = labels.map(label => {
        const category = AppState.categories.expenses.find(c => c.name === label);
        return category ? category.color : '#6C63FF';
    });
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: 'var(--text-primary)',
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
}

function renderMonthlyChart() {
    const ctx = document.getElementById('monthlyChart');
    if (!ctx) return;
    
    const now = DateTime.now();
    const months = [];
    const incomeData = [];
    const expenseData = [];
    
    // Últimos 6 meses
    for (let i = 5; i >= 0; i--) {
        const month = now.minus({months: i});
        const monthStart = month.startOf('month').toISODate();
        const monthEnd = month.endOf('month').toISODate();
        
        const monthTransactions = AppState.transactions.filter(t => 
            t.date >= monthStart && t.date <= monthEnd
        );
        
        const income = monthTransactions
            .filter(t => t.type === 'income')
            .reduce((sum, t) => sum + t.amount, 0);
        
        const expense = monthTransactions
            .filter(t => t.type === 'expense')
            .reduce((sum, t) => sum + t.amount, 0);
        
        months.push(month.toFormat('MMM/yy'));
        incomeData.push(income);
        expenseData.push(expense);
    }
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [
                {
                    label: 'Receitas',
                    data: incomeData,
                    borderColor: '#30D158',
                    backgroundColor: 'rgba(48, 209, 88, 0.1)',
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Despesas',
                    data: expenseData,
                    borderColor: '#FF453A',
                    backgroundColor: 'rgba(255, 69, 58, 0.1)',
                    tension: 0.3,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    labels: {
                        color: 'var(--text-primary)'
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'var(--text-primary)'
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'var(--text-primary)',
                        callback: function(value) {
                            return 'R$ ' + value;
                        }
                    }
                }
            }
        }
    });
}

function generateAIInsights() {
    const monthExpenses = AppState.transactions.filter(t => 
        t.type === 'expense' && 
        DateTime.fromISO(t.date).month === DateTime.now().month
    );
    
    if (monthExpenses.length === 0) {
        document.getElementById('ai-insight-1').textContent = "Adicione transações para receber insights da IA.";
        document.getElementById('ai-insight-2').textContent = "Comece registrando suas primeiras despesas.";
        document.getElementById('ai-insight-3').textContent = "A IA analisará seus padrões conforme você usar o sistema.";
        return;
    }
    
    // Insight 1: Categoria com maior gasto
    const categoryTotals = {};
    monthExpenses.forEach(t => {
        categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
    });
    
    const maxCategory = Object.entries(categoryTotals).reduce((a, b) => a[1] > b[1] ? a : b);
    const maxCategoryName = maxCategory[0];
    const maxCategoryAmount = maxCategory[1];
    
    document.getElementById('ai-insight-1').innerHTML = `
        <strong>${maxCategoryName}</strong> é sua maior despesa este mês: 
        <span class="text-danger">${formatCurrency(maxCategoryAmount)}</span>. 
        Considere revisar gastos nesta categoria.
    `;
    
    // Insight 2: Taxa de economia
    const monthIncome = AppState.transactions
        .filter(t => t.type === 'income' && 
            DateTime.fromISO(t.date).month === DateTime.now().month)
        .reduce((sum, t) => sum + t.amount, 0);
    
    const savings = monthIncome - monthExpenses.reduce((s, t) => s + t.amount, 0);
    const savingsRate = monthIncome > 0 ? (savings / monthIncome * 100).toFixed(1) : 0;
    
    let savingsMessage = savingsRate >= 20 ? 
        "Excelente! Você está economizando mais de 20% da sua renda." :
        savingsRate >= 10 ?
        "Bom! Mas tente aumentar sua economia para 20%." :
        "Atenção! Sua taxa de economia está baixa. Revise seus gastos.";
    
    document.getElementById('ai-insight-2').innerHTML = `
        Taxa de economia: <strong>${savingsRate}%</strong><br>
        ${savingsMessage}
    `;
    
    // Insight 3: Projeção mensal
    const dailyAvg = monthExpenses.reduce((s, t) => s + t.amount, 0) / DateTime.now().day;
    const projectedMonthly = dailyAvg * 30;
    const projectionVsIncome = monthIncome > 0 ? (projectedMonthly / monthIncome * 100).toFixed(1) : 100;
    
    let projectionMessage = projectionVsIncome <= 60 ?
        "Projeção saudável! Suas despesas estão controladas." :
        projectionVsIncome <= 80 ?
        "Cuidado! Suas despesas podem comprometer sua renda." :
        "Alerta! Projeção acima da renda. Corte gastos urgentemente.";
    
    document.getElementById('ai-insight-3').innerHTML = `
        Projeção mensal: <strong>${formatCurrency(projectedMonthly)}</strong><br>
        ${projectionMessage}
    `;
}

function loadRecentTransactions() {
    const container = document.getElementById('recent-transactions');
    if (!container) return;
    
    const recent = [...AppState.transactions]
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5);
    
    if (recent.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exchange-alt"></i>
                <div>Nenhuma transação registrada ainda</div>
                <button class="btn btn-primary mt-20" onclick="openTransactionForm('income')">
                    <i class="fas fa-plus"></i> Adicionar Primeira Transação
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = recent.map(transaction => {
        const isIncome = transaction.type === 'income';
        const category = [...AppState.categories.expenses, ...AppState.categories.income]
            .find(c => c.name === transaction.category);
        
        return `
            <div class="transaction-card" data-id="${transaction.id}">
                <div class="transaction-header">
                    <div class="transaction-category">
                        <div class="category-badge" style="background: ${category?.color || '#6C63FF'}20; color: ${category?.color || '#6C63FF'}">
                            <i class="fas ${category?.icon || 'fa-question'}"></i>
                            ${transaction.category}
                        </div>
                    </div>
                    <div class="transaction-amount ${transaction.type}">
                        ${isIncome ? '+' : '-'} ${formatCurrency(transaction.amount)}
                    </div>
                </div>
                <div class="transaction-details">
                    <div><i class="fas fa-calendar"></i> ${formatDate(transaction.date)}</div>
                    <div><i class="fas fa-wallet"></i> ${transaction.account}</div>
                    <div><i class="fas fa-sticky-note"></i> ${transaction.description || 'Sem descrição'}</div>
                </div>
                <div class="transaction-actions">
                    <button class="btn btn-sm btn-secondary" onclick="duplicateTransaction(${transaction.id})">
                        <i class="fas fa-copy"></i> Copiar
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="editTransaction(${transaction.id})">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteTransaction(${transaction.id})">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

// ========== TRANSAÇÕES ==========
function getTransactionsHTML() {
    const income = AppState.transactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const expense = AppState.transactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const balance = income - expense;
    
    return `
        <div class="dashboard-stats" style="margin-bottom: 25px;">
            <div class="stat-card">
                <div>Receitas Totais</div>
                <div class="stat-value text-success">${formatCurrency(income)}</div>
            </div>
            <div class="stat-card">
                <div>Despesas Totais</div>
                <div class="stat-value text-danger">${formatCurrency(expense)}</div>
            </div>
            <div class="stat-card">
                <div>Saldo</div>
                <div class="stat-value text-primary">${formatCurrency(balance)}</div>
            </div>
            <div class="stat-card">
                <div>Total de Transações</div>
                <div class="stat-value">${AppState.transactions.length}</div>
            </div>
        </div>
        
        <div class="quick-actions mb-20">
            <button class="btn btn-primary" onclick="openTransactionForm('income')">
                <i class="fas fa-arrow-down"></i> Nova Receita
            </button>
            <button class="btn btn-secondary" onclick="openTransactionForm('expense')">
                <i class="fas fa-arrow-up"></i> Nova Despesa
            </button>
            <button class="btn btn-secondary" onclick="filterTransactions()">
                <i class="fas fa-filter"></i> Filtrar
            </button>
        </div>
        
        
        <div class="finance-calendar-card" id="tx-calendar-card">
            <div class="calendar-header">
                <button class="btn btn-secondary" onclick="txCalPrev()"><i class="fas fa-chevron-left"></i></button>
                <div class="calendar-title" id="tx-cal-title"></div>
                <button class="btn btn-secondary" onclick="txCalNext()"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="tx-cal-weekdays">
                <div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div><div>Dom</div>
            </div>
            <div class="tx-cal-grid" id="tx-cal-grid"></div>
            <div class="tx-cal-legend">
                <span><span class="tx-dot green"></span> Receita</span>
                <span style="margin-left:14px;"><span class="tx-dot red"></span> Despesa</span>
                <span style="margin-left:14px; opacity:.8;">(toque no dia para ver no rodapé)</span>
            </div>
            <div class="tx-cal-daylist" id="tx-cal-daylist"></div>
        </div>

<h3 class="section-title">
            <i class="fas fa-list"></i> Todas as Transações
        </h3>
        
        <div id="all-transactions">
            <!-- Todas as transações serão carregadas aqui -->
        </div>
    `;
}


// ================= CALENDÁRIO DE LANÇAMENTOS (TRANSAÇÕES) =================
AppState.txCalMonth = AppState.txCalMonth || DateTime.now().startOf('month');

function initTransactions() {
    loadAllTransactions();
    initTxCalendar();
}

function initTxCalendar(){
    try{
        renderTxCalendar();
        bindTxCalendarSwipe();
    }catch(e){
        console.warn('calendar init failed', e);
    }
}

function txCalPrev(){
    AppState.txCalMonth = (AppState.txCalMonth || DateTime.now().startOf('month')).minus({months:1}).startOf('month');
    renderTxCalendar();
}
function txCalNext(){
    AppState.txCalMonth = (AppState.txCalMonth || DateTime.now().startOf('month')).plus({months:1}).startOf('month');
    renderTxCalendar();
}

function renderTxCalendar(){
    const title = document.getElementById('tx-cal-title');
    const grid = document.getElementById('tx-cal-grid');
    const daylist = document.getElementById('tx-cal-daylist');
    if(!title || !grid || !daylist) return;

    const month = AppState.txCalMonth || DateTime.now().startOf('month');
    title.textContent = month.setLocale('pt-BR').toFormat("MMMM 'de' yyyy");

    const start = month.startOf('month').startOf('week'); // Monday
    const end = month.endOf('month').endOf('week');

    const txByDate = {};
    (AppState.transactions||[]).forEach(t=>{
        if(!t.date) return;
        (txByDate[t.date] ||= []).push(t);
    });

    let htmlCells = "";
    let d = start;
    while(d <= end){
        const iso = d.toISODate();
        const inMonth = d.month === month.month;
        const list = txByDate[iso] || [];
        const hasIncome = list.some(t=>t.type==='income');
        const hasExpense = list.some(t=>t.type==='expense');
        const isSel = AppState.txSelectedDate === iso;

        htmlCells += `
        <div class="tx-cal-cell ${inMonth?'':'muted'} ${isSel?'selected':''}" onclick="selectTxDay('${iso}')">
            <div class="tx-cal-daynum">${d.day}</div>
            <div class="tx-cal-dots">
                ${hasIncome?'<span class="tx-dot green"></span>':''}
                ${hasExpense?'<span class="tx-dot red"></span>':''}
            </div>
        </div>`;
        d = d.plus({days:1});
    }
    grid.innerHTML = htmlCells;

    // Update day list
    renderTxDayList(AppState.txSelectedDate);
}

function selectTxDay(isoDate){
    // toggle selection
    AppState.txSelectedDate = (AppState.txSelectedDate === isoDate) ? null : isoDate;
    loadAllTransactions(); // updates list below "Todas as Transações"
    renderTxCalendar();    // refresh selection highlight + day list
}

function renderTxDayList(isoDate){
    const box = document.getElementById('tx-cal-daylist');
    if(!box) return;

    if(!isoDate){
        box.innerHTML = `<div class="empty-state" style="margin-top:10px;">
            <i class="fas fa-hand-pointer"></i>
            <div>Toque em um dia para ver os lançamentos aqui</div>
        </div>`;
        return;
    }

    const list = (AppState.transactions||[]).filter(t=>t.date===isoDate).sort((a,b)=>(b.id||0)-(a.id||0));
    if(list.length===0){
        box.innerHTML = `<div class="empty-state" style="margin-top:10px;">
            <i class="fas fa-calendar-day"></i>
            <div>Nenhum lançamento em ${DateTime.fromISO(isoDate).toFormat('dd/LL/yyyy')}</div>
        </div>`;
        return;
    }

    box.innerHTML = `
        <h4 style="margin:12px 0 8px 0;">${DateTime.fromISO(isoDate).toFormat('dd/LL/yyyy')}</h4>
        ${list.map(t=>`
            <div class="transaction-card" style="margin-bottom:10px;">
                <div class="transaction-header">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span class="tx-dot ${t.type==='income'?'green':'red'}"></span>
                        <div>
                            <div style="font-weight:700;">${escapeHtml(t.description || (t.type==='income'?'Receita':'Despesa'))}</div>
                            <div style="opacity:.8; font-size:12px;">${escapeHtml(t.category||'')}${t.subcategory?` • ${escapeHtml(t.subcategory)}`:''}</div>
                        </div>
                    </div>
                    <div class="${t.type==='income'?'text-success':'text-danger'}" style="font-weight:800;">
                        ${formatCurrency(t.amount || 0)}
                    </div>
                </div>
            </div>
        `).join('')}
    `;
}

function bindTxCalendarSwipe(){
    const el = document.getElementById('tx-calendar-card');
    if(!el) return;
    let x0 = null;
    el.addEventListener('touchstart', (e)=>{ x0 = e.touches[0].clientX; }, {passive:true});
    el.addEventListener('touchend', (e)=>{
        if(x0===null) return;
        const x1 = e.changedTouches[0].clientX;
        const dx = x1 - x0;
        x0 = null;
        if(Math.abs(dx) < 50) return;
        if(dx < 0) txCalNext(); else txCalPrev();
    }, {passive:true});
}


function loadAllTransactions() {
    const container = document.getElementById('all-transactions');
    if (!container) return;
    
    if (getFilteredTransactionsList().length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exchange-alt"></i>
                <div>Nenhuma transação registrada</div>
                <button class="btn btn-primary mt-20" onclick="openTransactionForm('income')">
                    <i class="fas fa-plus"></i> Adicionar Transação
                </button>
            </div>
        `;
        return;
    }
    
    // Agrupa transações por data
    const grouped = {};
    getFilteredTransactionsList().forEach(transaction => {
        const date = transaction.date;
        if (!grouped[date]) grouped[date] = [];
        grouped[date].push(transaction);
    });
    
    // Ordena datas
    const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
    
    let html = '';
    sortedDates.forEach(date => {
        const dateFormatted = formatDate(date);
        const dayTotal = grouped[date].reduce((sum, t) => {
            return t.type === 'income' ? sum + t.amount : sum - t.amount;
        }, 0);
        
        html += `
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px;">
                    <div style="font-weight: 600;">${dateFormatted}</div>
                    <div style="font-weight: 600; color: ${dayTotal >= 0 ? 'var(--success)' : 'var(--danger)'}">
                        ${dayTotal >= 0 ? '+' : ''}${formatCurrency(dayTotal)}
                    </div>
                </div>
        `;
        
        grouped[date].forEach(transaction => {
            const isIncome = transaction.type === 'income';
            const category = AppState.categories[isIncome ? 'income' : 'expenses']
                .find(c => c.name === transaction.category);
            
            html += `
                <div class="transaction-card" data-id="${transaction.id}">
                    <div class="transaction-header">
                        <div class="transaction-category">
                            <div class="category-badge" style="background: ${category?.color || '#6C63FF'}20; color: ${category?.color || '#6C63FF'}">
                                <i class="fas ${category?.icon || 'fa-question'}"></i>
                                ${transaction.category}
                            </div>
                        </div>
                        <div class="transaction-amount ${transaction.type}">
                            ${isIncome ? '+' : '-'} ${formatCurrency(transaction.amount)}
                        </div>
                    </div>
                    <div class="transaction-details">
                        <div><i class="fas fa-calendar"></i> ${formatDate(transaction.date)}</div>
                        <div><i class="fas fa-wallet"></i> ${transaction.account}</div>
                        <div><i class="fas fa-sticky-note"></i> ${transaction.description || 'Sem descrição'}</div>
                    </div>
                    <div class="transaction-actions">
                        <button class="btn btn-sm btn-secondary" onclick="duplicateTransaction(${transaction.id})">
                            <i class="fas fa-copy"></i> Copiar
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="editTransaction(${transaction.id})">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += `</div>`;
    });
    
    container.innerHTML = html;
}

function filterTransactions() {
    openTransactionFilterSheet();
}

function openTransactionFilterSheet(){
    const current = (AppState.txFilterMode || 'all');
    const mk = (v, label) => `
        <button class="btn btn-secondary" style="width:100%; justify-content:flex-start; margin:6px 0;"
            onclick="setTransactionFilter('${v}')">
            ${current===v ? '✅ ' : ''}${label}
        </button>`;
    openSettingsSheet('Filtros de Lançamentos', `
        <div class="settings-group">
            ${mk('week','Esta semana')}
            ${mk('month','Este mês')}
            ${mk('year','Este ano')}
            ${mk('lastyear','Ano anterior')}
            ${mk('all','Todas')}
            <div style="height:10px;"></div>
            ${mk('income','Receita')}
            ${mk('expense','Despesas')}
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="setTransactionFilter(currentFilterFromUI || (AppState.txFilterMode||'all'))">Aplicar</button>
        </div>
    `);
}

function setTransactionFilter(mode){
    AppState.txFilterMode = mode;
    // reset selected day when switching global filter
    AppState.txSelectedDate = null;
    closeSettingsSheet && closeSettingsSheet();
    // Recarrega a própria seção para atualizar stats/lista/calendário
    loadSection('transactions');
}

function getFilteredTransactionsList(){
    const list = (AppState.transactions || []).slice();
    const mode = AppState.txFilterMode || 'all';
    const now = DateTime.now();
    let out = list.filter(t=>{
        const d = DateTime.fromISO(t.date);
        if(mode==='week') return d >= now.startOf('week') && d <= now.endOf('week');
        if(mode==='month') return d >= now.startOf('month') && d <= now.endOf('month');
        if(mode==='year') return d >= now.startOf('year') && d <= now.endOf('year');
        if(mode==='lastyear') return d.year === (now.year - 1);
        if(mode==='income') return t.type === 'income';
        if(mode==='expense') return t.type === 'expense';
        return true;
    });
    // If a day is selected in calendar, intersect by that date
    if(AppState.txSelectedDate){
        out = out.filter(t => t.date === AppState.txSelectedDate);
    }
    // Sort newest first
    out.sort((a,b)=> (b.date||'').localeCompare(a.date||''));
    return out;
}

// ========== CONTAS BANCÁRIAS ==========
function getAccountsHTML() {
    return `
        <h3 class="section-title">
            <i class="fas fa-university"></i> Contas Bancárias
        </h3>
        
        <div class="accounts-list" id="accounts-list">
            <!-- Contas serão carregadas aqui -->
        </div>
        
        <div class="empty-state">
            <i class="fas fa-plus-circle"></i>
            <div>Tem conta em mais bancos?</div>
            <div style="font-size: 14px; margin-top: 5px; margin-bottom: 15px;">Adicione manualmente ou conecte automaticamente</div>
            <div class="quick-actions">
                <button class="btn btn-primary" onclick="openAccountForm()">
                    <i class="fas fa-plus"></i> Adicionar Conta Manual
                </button>
                <button class="btn btn-secondary" onclick="showNotification('Funcionalidade de conexão com bancos em desenvolvimento', 'info')">
                    <i class="fas fa-plug"></i> Conectar Banco
                </button>
            </div>
        </div>
        
        <h3 class="section-title mt-25">
            <i class="fas fa-money-bill-wave"></i> Dinheiro Físico
        </h3>
        
        <div class="account-card" onclick="showNotification('Conta de dinheiro físico selecionada', 'info')">
            <div class="account-info">
                <div class="account-icon" style="background: #00D4AA">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="account-details">
                    <h3>Dinheiro em Espécie</h3>
                    <p>Carteira • Manual</p>
                </div>
            </div>
            <div class="account-balance">${formatCurrency(AppState.accounts.find(a => a.type === 'cash')?.balance || 0)}</div>
        </div>
        
        <button class="btn btn-secondary mt-20" style="width: 100%;" onclick="openTransactionForm('expense')">
            <i class="fas fa-plus"></i> Registrar Transação em Dinheiro
        </button>
    `;
}

function initAccounts() {
    loadAccounts();
}

function loadAccounts() {
    const container = document.getElementById('accounts-list');
    if (!container) return;
    
    // Filtra contas que não são cash (dinheiro físico)
    const nonCashAccounts = AppState.accounts.filter(account => account.type !== 'cash');
    
    if (nonCashAccounts.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-university"></i>
                <div>Nenhuma conta bancária adicionada</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = nonCashAccounts.map(account => `
        <div class="account-card" data-id="${account.id}" onclick="viewAccountDetails(${account.id})">
            <div class="account-info">
                <div class="account-icon" style="background: ${account.color || 'var(--glass)'}">
                    <i class="fas ${getAccountIcon(account.type)}"></i>
                </div>
                <div class="account-details">
                    <h3>${account.name}</h3>
                    <p>${account.bank} ${account.manual ? '• Manual' : ''}</p>
                </div>
            </div>
            <div class="account-balance">${formatCurrency(account.balance)}</div>
        </div>
    `).join('');
}

function getAccountIcon(type) {
    const icons = {
        'checking': 'fa-university',
        'savings': 'fa-piggy-bank',
        'investment': 'fa-chart-line',
        'cash': 'fa-money-bill-wave',
        'credit': 'fa-credit-card'
    };
    return icons[type] || 'fa-wallet';
}

function viewAccountDetails(accountId) {
    const account = AppState.accounts.find(a => a.id === accountId);
    if (account) {
        showNotification(`Detalhes da conta ${account.name} em desenvolvimento`, 'info');
    }
}

function openAccountForm() {
    showNotification('Formulário de conta em desenvolvimento', 'info');
}

// ========== CARTÕES DE CRÉDITO ==========
function getCreditCardsHTML() {
    return `
        <h3 class="section-title">
            <i class="fas fa-credit-card"></i> Cartões de Crédito
        </h3>
        
        ${AppState.creditCards.length === 0 ? `
            <div class="empty-state">
                <i class="fas fa-credit-card"></i>
                <div>Nenhum cartão adicionado</div>
                <button class="btn btn-primary mt-20" onclick="addCreditCard()">
                    <i class="fas fa-plus"></i> Adicione seu primeiro cartão
                </button>
            </div>
        ` : `
            <div class="credit-cards-list" id="credit-cards-list">
                <!-- Cartões serão carregados aqui -->
            </div>
        `}
        
        <div class="quick-actions mt-20">
            <button class="btn btn-secondary" onclick="scanCard()">
                <i class="fas fa-camera"></i> Digitalizar Cartão
            </button>
            <button class="btn btn-secondary" onclick="importCards()">
                <i class="fas fa-file-import"></i> Importar Faturas
            </button>
        </div>
        
        <div class="mt-25" style="background: var(--card-bg); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border);">
            <h4 style="margin-bottom: 15px; font-size: 16px;">Resumo dos Cartões</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <div style="font-size: 12px; color: var(--text-tertiary);">Limite Total</div>
                    <div style="font-size: 18px; font-weight: 700;">${formatCurrency(AppState.creditCards.reduce((sum, card) => sum + card.limit, 0))}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: var(--text-tertiary);">Utilizado</div>
                    <div style="font-size: 18px; font-weight: 700;" class="text-danger">${formatCurrency(AppState.creditCards.reduce((sum, card) => sum + card.current, 0))}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: var(--text-tertiary);">Disponível</div>
                    <div style="font-size: 18px; font-weight: 700;" class="text-success">${formatCurrency(AppState.creditCards.reduce((sum, card) => sum + (card.limit - card.current), 0))}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: var(--text-tertiary);">Utilização</div>
                    <div style="font-size: 18px; font-weight: 700;">${(AppState.creditCards.reduce((sum, card) => sum + card.current, 0) / AppState.creditCards.reduce((sum, card) => sum + card.limit, 0) * 100).toFixed(1)}%</div>
                </div>
            </div>
        </div>
    `;
}


function openCreditCardForm(cardId=null){
  AppState.creditCards = AppState.creditCards || [];
  const isEdit = cardId !== null && cardId !== undefined;
  const idx = isEdit ? AppState.creditCards.findIndex(c=>c.id===cardId) : -1;
  const card = (isEdit && idx>=0) ? AppState.creditCards[idx] : { id: Date.now(), name:"", limit:0, used:0, dueDay:10, last4:"", color:"#6D5AE6" };

  const inner = `
    <div class="sheet-section">
      <div style="display:grid;gap:10px">
        <label style="display:grid;gap:6px">
          <div style="opacity:.85;font-size:12px">Nome do cartão</div>
          <input id="cc_name" class="glass-input" value="${escapeHtml(card.name||"")}" placeholder="Ex: Nubank" />
        </label>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <label style="display:grid;gap:6px">
            <div style="opacity:.85;font-size:12px">Limite</div>
            <input id="cc_limit" class="glass-input" inputmode="decimal" value="${card.limit ?? 0}" />
          </label>
          <label style="display:grid;gap:6px">
            <div style="opacity:.85;font-size:12px">Utilizado</div>
            <input id="cc_used" class="glass-input" inputmode="decimal" value="${card.used ?? 0}" />
          </label>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <label style="display:grid;gap:6px">
            <div style="opacity:.85;font-size:12px">Vence dia</div>
            <input id="cc_due" class="glass-input" inputmode="numeric" value="${card.dueDay ?? 10}" />
          </label>
          <label style="display:grid;gap:6px">
            <div style="opacity:.85;font-size:12px">Últimos 4 dígitos</div>
            <input id="cc_last4" class="glass-input" inputmode="numeric" maxlength="4" value="${escapeHtml(card.last4||"")}" placeholder="1234" />
          </label>
        </div>

        <div style="display:flex;gap:10px;margin-top:6px">
          <button class="btn-primary" style="flex:1" onclick="saveCreditCard(${card.id})">${isEdit ? "Salvar Alterações" : "Adicionar Cartão"}</button>
          ${isEdit ? `<button class="btn-secondary" style="min-width:120px" onclick="confirmDeleteCreditCard(${card.id})">Excluir</button>` : ``}
        </div>
      </div>
    </div>
  `;
  openSettingsSheet(isEdit ? "Editar Cartão" : "Adicionar Cartão", inner);
}

function saveCreditCard(cardId){
  AppState.creditCards = AppState.creditCards || [];
  const idx = AppState.creditCards.findIndex(c=>c.id===cardId);

  const name = (document.getElementById("cc_name")?.value || "").trim();
  const limit = Number((document.getElementById("cc_limit")?.value || "0").toString().replace(",", "."));
  const used = Number((document.getElementById("cc_used")?.value || "0").toString().replace(",", "."));
  const dueDay = parseInt(document.getElementById("cc_due")?.value || "10", 10);
  const last4 = (document.getElementById("cc_last4")?.value || "").trim().slice(-4);

  if (!name) { showNotification("Informe o nome do cartão", "warning"); return; }
  if (!isFinite(limit) || limit <= 0) { showNotification("Informe um limite válido", "warning"); return; }

  const base = (idx>=0) ? AppState.creditCards[idx] : { id: cardId, color: "#6D5AE6" };
  const card = { ...base, name, limit, used: Math.max(0, isFinite(used)?used:0), dueDay: isFinite(dueDay)?dueDay:10, last4 };

  if (idx>=0) AppState.creditCards[idx]=card;
  else AppState.creditCards.push(card);

  saveData();
  closeSettingsSheet();
  loadCreditCards();
  showNotification(idx>=0 ? "Cartão atualizado!" : "Cartão adicionado!", "success");
}

function confirmDeleteCreditCard(cardId){
  const card = AppState.creditCards?.find(c=>c.id===cardId);
  if (!card) return;
  const inner = `
    <div class="sheet-section">
      <div style="margin-bottom:10px">Excluir <strong>${escapeHtml(card.name)}</strong>?</div>
      <div style="display:flex;gap:10px">
        <button class="btn-secondary" style="flex:1" onclick="closeSettingsSheet()">Cancelar</button>
        <button class="btn-primary" style="flex:1" onclick="deleteCreditCard(${cardId})">Excluir</button>
      </div>
    </div>
  `;
  openSettingsSheet("Confirmar Exclusão", inner);
}

function deleteCreditCard(cardId){
  AppState.creditCards = AppState.creditCards || [];
  AppState.creditCards = AppState.creditCards.filter(c=>c.id!==cardId);
  saveData();
  closeSettingsSheet();
  loadCreditCards();
  showNotification("Cartão excluído.", "success");
}
function initCreditCards() {
  loadCreditCards();
}

function loadCreditCards() {
  const container = document.getElementById('credit-cards-list');
  if (!container) return;

  AppState.creditCards = AppState.creditCards || [];
  if (!AppState.creditCards.length) {
    container.innerHTML = `
      <div style="opacity:.8;padding:14px;border-radius:14px;background:rgba(255,255,255,.04);border:1px dashed rgba(255,255,255,.12)">
        Nenhum cartão cadastrado. Use o botão <strong>Adicionar Cartão</strong>.
      </div>`;
    return;
  }

  container.innerHTML = AppState.creditCards.map(card => {
    const utilization = card.limit ? (card.used / card.limit * 100) : 0;
    return `
      <div class="credit-card" onclick="viewCardDetails(${card.id})" style="background: linear-gradient(135deg, ${card.color}80, ${adjustColor(card.color, -20)});">
        <div class="card-header">
          <div class="card-name">${escapeHtml(card.name)}</div>
          <div class="card-number">**** **** **** ${escapeHtml(card.last4 || "----")}</div>
        </div>
        <div class="card-limits">
          <div class="limit-item">
            <div class="limit-label">Limite</div>
            <div class="limit-value">${formatCurrency(card.limit || 0)}</div>
          </div>
          <div class="limit-item">
            <div class="limit-label">Utilizado</div>
            <div class="limit-value">${formatCurrency(card.used || 0)}</div>
          </div>
          <div class="limit-item">
            <div class="limit-label">Vence</div>
            <div class="limit-value">Dia ${card.dueDay || "-"}</div>
          </div>
          <div class="limit-item">
            <div class="limit-label">Uso</div>
            <div class="limit-value">${(utilization||0).toFixed(1)}%</div>
          </div>
        </div>
        <div style="margin-top:10px;height:8px;border-radius:999px;background:rgba(255,255,255,.18);overflow:hidden">
          <div style="height:100%;width:${Math.min(100,Math.max(0,utilization||0))}%;background:rgba(255,255,255,.8)"></div>
        </div>
      </div>
    `;
  }).join('');
}

function adjustColor(color, amount) {
    let usePound = false;
    if (color[0] === "#") {
        color = color.slice(1);
        usePound = true;
    }
    const num = parseInt(color, 16);
    let r = (num >> 16) + amount;
    if (r > 255) r = 255;
    else if (r < 0) r = 0;
    let b = ((num >> 8) & 0x00FF) + amount;
    if (b > 255) b = 255;
    else if (b < 0) b = 0;
    let g = (num & 0x0000FF) + amount;
    if (g > 255) g = 255;
    else if (g < 0) g = 0;
    return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16).padStart(6, '0');
}

function addCreditCard() {
  openCreditCardForm(null);
}

function viewCardDetails(cardId) {
  openCreditCardForm(cardId);
}

function scanCard() {
    showNotification('Digitalização de cartões em desenvolvimento', 'info');
}

function importCards() {
    showNotification('Importação de faturas em desenvolvimento', 'info');
}

// ========== CATEGORIAS ==========
function getCategoriesHTML() {
    return `
        <div style="margin-bottom: 20px;">
            <input type="text" class="form-input" placeholder="Buscar por categoria..." id="category-search" oninput="filterCategories(this.value)">
        </div>
        
        <h3 class="section-title">
            <i class="fas fa-arrow-up"></i> Gastos
        </h3>
        
        <div class="categories-grid" id="expense-categories">
            <!-- Categorias de gastos serão carregadas aqui -->
        </div>
        
        <h3 class="section-title mt-25">
            <i class="fas fa-arrow-down"></i> Ganhos
        </h3>
        
        <div class="categories-grid" id="income-categories">
            <!-- Categorias de ganhos serão carregadas aqui -->
        </div>
        
        <div class="quick-actions mt-20">
            <button class="btn btn-primary" onclick="addCategory()">
                <i class="fas fa-plus"></i> Nova Categoria
            </button>
            <button class="btn btn-secondary" onclick="editCategories()">
                <i class="fas fa-edit"></i> Editar Categorias
            </button>
        </div>
    `;
}

function initCategories() {
    loadCategories();
}

function loadCategories() {
    const expenseContainer = document.getElementById('expense-categories');
    const incomeContainer = document.getElementById('income-categories');
    
    if (expenseContainer) {
        expenseContainer.innerHTML = AppState.categories.expenses.map(category => `
            <div class="category-card" onclick="viewCategoryDetails('expense', ${category.id})">
                <div class="category-header">
                    <div class="category-icon" style="background: ${category.color}20; color: ${category.color};">
                        <i class="fas ${category.icon}"></i>
                    </div>
                    <div>
                        <div class="category-name">${category.name}</div>
                        <div class="category-stats">${category.subcategories?.length || 0} subcategorias</div>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    if (incomeContainer) {
        incomeContainer.innerHTML = AppState.categories.income.map(category => `
            <div class="category-card" onclick="viewCategoryDetails('income', ${category.id})">
                <div class="category-header">
                    <div class="category-icon" style="background: ${category.color}20; color: ${category.color};">
                        <i class="fas ${category.icon}"></i>
                    </div>
                    <div>
                        <div class="category-name">${category.name}</div>
                        <div class="category-stats">${category.subcategories?.length || 0} subcategorias</div>
                    </div>
                </div>
            </div>
        `).join('');
    }
}

function filterCategories(search) {
    const searchLower = search.toLowerCase();
    
    // Filtra categorias de gastos
    const expenseCards = document.querySelectorAll('#expense-categories .category-card');
    expenseCards.forEach(card => {
        const name = card.querySelector('.category-name').textContent.toLowerCase();
        card.style.display = name.includes(searchLower) ? 'block' : 'none';
    });
    
    // Filtra categorias de ganhos
    const incomeCards = document.querySelectorAll('#income-categories .category-card');
    incomeCards.forEach(card => {
        const name = card.querySelector('.category-name').textContent.toLowerCase();
        card.style.display = name.includes(searchLower) ? 'block' : 'none';
    });
}

function viewCategoryDetails(type, categoryId) {
    const categories = type === 'income' ? AppState.categories.income : AppState.categories.expenses;
    const category = categories.find(c => c.id === categoryId);
    if (category) {
        showNotification(`Detalhes da categoria ${category.name} em desenvolvimento`, 'info');
    }
}

function addCategory() {
    showNotification('Adicionar categoria em desenvolvimento', 'info');
}

function editCategories() {
    showNotification('Editar categorias em desenvolvimento', 'info');
}

// ========== ORÇAMENTO ==========
function getBudgetHTML() {
    return `
        <h3 class="section-title">
            <i class="fas fa-chart-pie"></i> Orçamento Mensal
        </h3>
        
        <div class="dashboard-stats" style="margin-bottom: 25px;">
            <div class="stat-card">
                <div>Orçamento Total</div>
                <div class="stat-value">${formatCurrency(AppState.budgets.reduce((sum, b) => sum + b.limit, 0))}</div>
            </div>
            <div class="stat-card">
                <div>Gasto Total</div>
                <div class="stat-value text-danger">${formatCurrency(AppState.budgets.reduce((sum, b) => sum + b.spent, 0))}</div>
            </div>
            <div class="stat-card">
                <div>Disponível</div>
                <div class="stat-value text-success">${formatCurrency(AppState.budgets.reduce((sum, b) => sum + (b.limit - b.spent), 0))}</div>
            </div>
            <div class="stat-card">
                <div>Utilização</div>
                <div class="stat-value">${(AppState.budgets.reduce((sum, b) => sum + b.spent, 0) / AppState.budgets.reduce((sum, b) => sum + b.limit, 0) * 100).toFixed(1)}%</div>
            </div>
        </div>
        
        <h4 class="section-title">
            <i class="fas fa-list"></i> Orçamentos por Categoria
        </h4>
        
        <div id="budget-list">
            <!-- Orçamentos serão carregadas aqui -->
        </div>
        
        <div class="quick-actions mt-20">
            <button class="btn btn-primary" onclick="createBudget()">
                <i class="fas fa-plus"></i> Criar Orçamento
            </button>
            <button class="btn btn-secondary" onclick="generateBudgetReport()">
                <i class="fas fa-file-pdf"></i> Relatório de Orçamento
            </button>
        </div>
    `;
}

function initBudget() {
    loadBudgets();
}

function loadBudgets() {
    const container = document.getElementById('budget-list');
    if (!container) return;
    
    if (AppState.budgets.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-chart-pie"></i>
                <div>Nenhum orçamento definido</div>
                <button class="btn btn-primary mt-20" onclick="createBudget()">
                    <i class="fas fa-plus"></i> Criar Primeiro Orçamento
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = AppState.budgets.map(budget => {
        const percentage = (budget.spent / budget.limit) * 100;
        const category = [...AppState.categories.expenses, ...AppState.categories.income]
            .find(c => c.name === budget.category);
        
        return `
            <div class="transaction-card">
                <div class="transaction-header">
                    <div class="transaction-category">
                        <div class="category-badge" style="background: ${category?.color || '#6C63FF'}20; color: ${category?.color || '#6C63FF'}">
                            <i class="fas ${category?.icon || 'fa-question'}"></i>
                            ${budget.category}
                        </div>
                    </div>
                    <div class="transaction-amount ${percentage > 100 ? 'text-danger' : percentage > 80 ? 'text-warning' : 'text-success'}">
                        ${percentage.toFixed(1)}%
                    </div>
                </div>
                <div class="transaction-details">
                    <div><i class="fas fa-money-bill"></i> Limite: ${formatCurrency(budget.limit)}</div>
                    <div><i class="fas fa-shopping-cart"></i> Gasto: ${formatCurrency(budget.spent)}</div>
                    <div><i class="fas fa-wallet"></i> Restante: ${formatCurrency(budget.limit - budget.spent)}</div>
                </div>
                <div class="goal-progress">
                    <div class="goal-progress-bar" style="width: ${Math.min(percentage, 100)}%; background: ${percentage > 100 ? 'var(--danger)' : percentage > 80 ? 'var(--warning)' : 'var(--success)'};"></div>
                </div>
            </div>
        `;
    }).join('');
}

function createBudget() {
    showNotification('Criar orçamento em desenvolvimento', 'info');
}

function generateBudgetReport() {
    showNotification('Relatório de orçamento em desenvolvimento', 'info');
}

// ========== OBJETIVOS ==========
function getGoalsHTML() {
    return `
        <h3 class="section-title">
            <i class="fas fa-bullseye"></i> Objetivos Financeiros
        </h3>
        
        ${AppState.goals.length === 0 ? `
            <div class="empty-state">
                <i class="fas fa-bullseye"></i>
                <div>Crie, gerencie e acompanhe seus objetivos pessoais</div>
                <button class="btn btn-primary mt-20" onclick="createGoal()">
                    <i class="fas fa-plus"></i> Adicionar objetivo
                </button>
            </div>
        ` : `
            <div class="goals-grid" id="goals-list">
                <!-- Objetivos serão carregados aqui -->
            </div>
        `}
        
        <div class="quick-actions mt-20">
            <button class="btn btn-primary" onclick="createGoal()">
                <i class="fas fa-plus"></i> Novo Objetivo
            </button>
            <button class="btn btn-secondary" onclick="showGoalStrategies()">
                <i class="fas fa-lightbulb"></i> Estratégias da IA
            </button>
        </div>
        
        <div class="mt-25" style="background: var(--card-bg); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border);">
            <h4 style="margin-bottom: 15px; font-size: 16px;">Progresso Total</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <div style="font-size: 12px; color: var(--text-tertiary);">Total Alcançado</div>
                    <div style="font-size: 18px; font-weight: 700;" class="text-success">
                        ${formatCurrency(AppState.goals.reduce((sum, g) => sum + g.current, 0))}
                    </div>
                </div>
                <div>
                    <div style="font-size: 12px; color: var(--text-tertiary);">Meta Total</div>
                    <div style="font-size: 18px; font-weight: 700;">
                        ${formatCurrency(AppState.goals.reduce((sum, g) => sum + g.target, 0))}
                    </div>
                </div>
                <div>
                    <div style="font-size: 12px; color: var(--text-tertiary);">Progresso Médio</div>
                    <div style="font-size: 18px; font-weight: 700;">
                        ${AppState.goals.length > 0 ? 
                          (AppState.goals.reduce((sum, g) => sum + (g.current / g.target * 100), 0) / AppState.goals.length).toFixed(1) : 
                          '0'}%
                    </div>
                </div>
                <div>
                    <div style="font-size: 12px; color: var(--text-tertiary);">Objetivos</div>
                    <div style="font-size: 18px; font-weight: 700;">${AppState.goals.length}</div>
                </div>
            </div>
        </div>
    `;
}

function initGoals() {
    if (AppState.goals.length > 0) {
        loadGoals();
    }
}

function loadGoals() {
    const container = document.getElementById('goals-list');
    if (!container) return;
    
    container.innerHTML = AppState.goals.map(goal => {
        const percentage = (goal.current / goal.target) * 100;
        const deadline = DateTime.fromISO(goal.deadline);
        const daysRemaining = Math.ceil(deadline.diffNow('days').days);
        
        return `
            <div class="goal-card" onclick="viewGoalDetails(${goal.id})">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="font-weight: 700; font-size: 16px;">${goal.name}</div>
                    <div style="font-size: 14px; color: var(--text-tertiary);">
                        ${percentage.toFixed(1)}%
                    </div>
                </div>
                
                <div class="goal-progress">
                    <div class="goal-progress-bar" style="width: ${Math.min(percentage, 100)}%;"></div>
                </div>
                
                <div class="goal-details">
                    <div>
                        <div style="font-size: 11px; color: var(--text-tertiary);">Alcançado</div>
                        <div style="font-weight: 600;">${formatCurrency(goal.current)}</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-tertiary);">Meta</div>
                        <div style="font-weight: 600;">${formatCurrency(goal.target)}</div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-tertiary);">Faltam</div>
                        <div style="font-weight: 600;">${daysRemaining} dias</div>
                    </div>
                </div>
                
                <div style="margin-top: 15px;">
                    <button class="btn btn-sm btn-primary" style="width: 100%;" onclick="addToGoal(${goal.id}); event.stopPropagation();">
                        <i class="fas fa-plus"></i> Adicionar Valor
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function createGoal() {
    showNotification('Criar objetivo em desenvolvimento', 'info');
}

function viewGoalDetails(goalId) {
    const goal = AppState.goals.find(g => g.id === goalId);
    if (goal) {
        showNotification(`Detalhes do objetivo ${goal.name} em desenvolvimento`, 'info');
    }
}

function addToGoal(goalId) {
    showNotification('Adicionar valor ao objetivo em desenvolvimento', 'info');
}

function showGoalStrategies() {
    showNotification('Estratégias da IA para objetivos em desenvolvimento', 'info');
}

// ========== MEMBROS ==========
function getMembersHTML() {
    return `
        <h3 class="section-title">
            <i class="fas fa-users"></i> Membros da Família
        </h3>
        
        <div class="members-grid" id="members-list">
            <!-- Membros serão carregados aqui -->
        </div>
        
        <div class="empty-state">
            <i class="fas fa-user-plus"></i>
            <div>Adicione membros para controlar gastos individuais</div>
            <div style="font-size: 14px; margin-top: 5px; margin-bottom: 15px;">Perfeito para famílias e casais</div>
            <div class="quick-actions">
                <button class="btn btn-primary" onclick="addMember()">
                    <i class="fas fa-plus"></i> Adicionar Membro
                </button>
                <button class="btn btn-secondary" onclick="showFamilyReports()">
                    <i class="fas fa-chart-pie"></i> Relatório Familiar
                </button>
            </div>
        </div>
        
        <div class="mt-25" style="background: var(--card-bg); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border);">
            <h4 style="margin-bottom: 15px; font-size: 16px;">Gastos por Membro (Este Mês)</h4>
            <div id="members-spending">
                <!-- Gastos por membro serão carregados aqui -->
            </div>
        </div>
    `;
}

function initMembers() {
    loadMembers();
    loadMembersSpending();
}

function loadMembers() {
    const container = document.getElementById('members-list');
    if (!container) return;
    
    if (AppState.members.length === 0) {
        return;
    }
    
    container.innerHTML = AppState.members.map(member => {
        const relationship = getRelationshipText(member.relationship);
        const age = calculateAge(member.birthdate);
        
        return `
            <div class="member-card" onclick="viewMemberDetails(${member.id})">
                <div class="member-avatar" style="background: var(--ai-gradient);">
                    ${member.name.charAt(0).toUpperCase()}
                </div>
                <div class="member-name">${member.name}</div>
                <div class="member-relationship">${relationship}</div>
                ${age ? `<div style="font-size: 11px; color: var(--text-tertiary); margin-top: 5px;">${age} anos</div>` : ''}
            </div>
        `;
    }).join('');
}

function getRelationshipText(relationship) {
    const relationships = {
        'spouse': 'Cônjuge',
        'child': 'Filho(a)',
        'parent': 'Pai/Mãe',
        'sibling': 'Irmão(ã)',
        'other': 'Outro'
    };
    return relationships[relationship] || 'Membro';
}

function calculateAge(birthdate) {
    if (!birthdate) return null;
    const birth = DateTime.fromISO(birthdate);
    const now = DateTime.now();
    return Math.floor(now.diff(birth, 'years').years);
}

function loadMembersSpending() {
    const container = document.getElementById('members-spending');
    if (!container) return;
    
    if (AppState.members.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-tertiary);">Adicione membros para ver gastos individuais</div>';
        return;
    }
    
    // Calcula gastos por membro para o mês atual
    const monthStart = DateTime.now().startOf('month').toISODate();
    const monthEnd = DateTime.now().endOf('month').toISODate();
    
    const memberSpending = {};
    AppState.members.forEach(member => {
        memberSpending[member.id] = 0;
    });
    
    AppState.transactions.forEach(transaction => {
        if (transaction.type === 'expense' && 
            transaction.date >= monthStart && 
            transaction.date <= monthEnd &&
            transaction.member) {
            
            const memberId = AppState.members.find(m => m.name === transaction.member)?.id;
            if (memberId) {
                memberSpending[memberId] = (memberSpending[memberId] || 0) + transaction.amount;
            }
        }
    });
    
    container.innerHTML = AppState.members.map(member => {
        const spent = memberSpending[member.id] || 0;
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 30px; height: 30px; border-radius: 50%; background: var(--ai-gradient); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                        ${member.name.charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <div style="font-weight: 500;">${member.name}</div>
                        <div style="font-size: 12px; color: var(--text-tertiary);">${getRelationshipText(member.relationship)}</div>
                    </div>
                </div>
                <div style="font-weight: 600; color: ${spent > 0 ? 'var(--danger)' : 'var(--text-tertiary)'}">
                    ${spent > 0 ? '-' : ''}${formatCurrency(spent)}
                </div>
            </div>
        `;
    }).join('');
}

function addMember() {
    showNotification('Adicionar membro em desenvolvimento', 'info');
}

function viewMemberDetails(memberId) {
    const member = AppState.members.find(m => m.id === memberId);
    if (member) {
        showNotification(`Detalhes do membro ${member.name} em desenvolvimento`, 'info');
    }
}

function showFamilyReports() {
    showNotification('Relatório familiar em desenvolvimento', 'info');
}

// ========== DESPESAS RECORRENTES ==========
function getRecurringHTML() {
    return `
        <h3 class="section-title">
            <i class="fas fa-redo"></i> Despesas Recorrentes
        </h3>
        
        <div class="dashboard-stats" style="margin-bottom: 25px;">
            <div class="stat-card">
                <div>Despesas Ativas</div>
                <div class="stat-value">${AppState.recurringTransactions.length}</div>
            </div>
            <div class="stat-card">
                <div>Valor Mensal</div>
                <div class="stat-value text-danger">
                    ${formatCurrency(AppState.recurringTransactions.reduce((sum, t) => sum + t.amount, 0))}
                </div>
            </div>
            <div class="stat-card">
                <div>Vencem Hoje</div>
                <div class="stat-value text-warning">0</div>
            </div>
            <div class="stat-card">
                <div>Próximos 7 Dias</div>
                <div class="stat-value">0</div>
            </div>
        </div>
        
        <div class="quick-actions mb-20">
            <button class="btn btn-primary" onclick="openRecurringForm()">
                <i class="fas fa-plus"></i> Nova Recorrência
            </button>
            <button class="btn btn-secondary" onclick="importRecurring()">
                <i class="fas fa-file-import"></i> Importar Contas Fixas
            </button>
            <button class="btn btn-secondary" onclick="showDueDates()">
                <i class="fas fa-calendar-alt"></i> Próximos Vencimentos
            </button>
        </div>
        
        <h4 class="section-title">
            <i class="fas fa-list"></i> Recorrências Ativas
        </h4>
        
        <div id="recurring-list">
            <!-- Despesas recorrentes serão carregadas aqui -->
        </div>
    `;
}

function initRecurring() {
    loadRecurringTransactions();
}

function loadRecurringTransactions() {
    const container = document.getElementById('recurring-list');
    if (!container) return;
    
    if (AppState.recurringTransactions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-redo"></i>
                <div>Nenhuma despesa recorrente cadastrada</div>
                <button class="btn btn-primary mt-20" onclick="openRecurringForm()">
                    <i class="fas fa-plus"></i> Adicionar Primeira Recorrência
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = AppState.recurringTransactions.map(transaction => {
        const category = [...AppState.categories.expenses, ...AppState.categories.income]
            .find(c => c.name === transaction.category);
        
        return `
            <div class="transaction-card">
                <div class="transaction-header">
                    <div class="transaction-category">
                        <div class="category-badge" style="background: ${category?.color || '#6C63FF'}20; color: ${category?.color || '#6C63FF'}">
                            <i class="fas ${category?.icon || 'fa-question'}"></i>
                            ${transaction.category}
                        </div>
                        <div style="font-size: 12px; color: var(--text-tertiary);">
                            <i class="fas fa-redo"></i> ${getRecurrenceText(transaction.recurrence)}
                        </div>
                    </div>
                    <div class="transaction-amount expense">
                        - ${formatCurrency(transaction.amount)}
                    </div>
                </div>
                <div class="transaction-details">
                    <div><i class="fas fa-sticky-note"></i> ${transaction.description || 'Sem descrição'}</div>
                    <div><i class="fas fa-calendar"></i> Próxima: ${formatDate(transaction.nextDate)}</div>
                    <div><i class="fas fa-wallet"></i> ${transaction.account}</div>
                </div>
                <div class="transaction-actions">
                    <button class="btn btn-sm btn-success" onclick="payRecurring(${transaction.id})">
                        <i class="fas fa-check"></i> Marcar como Pago
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="editRecurring(${transaction.id})">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function getRecurrenceText(recurrence) {
    const recurrences = {
        'daily': 'Diário',
        'weekly': 'Semanal',
        'monthly': 'Mensal',
        'yearly': 'Anual',
        'biweekly': 'Quinzenal'
    };
    return recurrences[recurrence] || recurrence;
}

function openRecurringForm() {
    document.getElementById('transaction-form').classList.add('active');
    showNotification('Formulário de recorrência aberto', 'info');
}

function importRecurring() {
    showNotification('Importação de contas fixas em desenvolvimento', 'info');
}

function showDueDates() {
    showNotification('Próximos vencimentos em desenvolvimento', 'info');
}

function payRecurring(id) {
    showNotification('Marcar como pago em desenvolvimento', 'info');
}

function editRecurring(id) {
    showNotification('Editar recorrência em desenvolvimento', 'info');
}

// ========== RELATÓRIOS ==========
function getReportsHTML() {
    return `
        <h3 class="section-title">
            <i class="fas fa-chart-bar"></i> Relatórios Avançados
        </h3>
        
        <div class="features-grid mb-25">
            <div class="feature-card" onclick="generateMonthlyReport()">
                <div class="feature-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="feature-title">Relatório Mensal</div>
                <div class="feature-description">Análise detalhada do mês atual com gráficos e tendências</div>
            </div>
            
            <div class="feature-card" onclick="generateCategoryReport()">
                <div class="feature-icon">
                    <i class="fas fa-tags"></i>
                </div>
                <div class="feature-title">Por Categoria</div>
                <div class="feature-description">Distribuição de gastos e receitas por categoria</div>
            </div>
            
            <div class="feature-card" onclick="generateAnnualReport()">
                <div class="feature-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="feature-title">Anual Completo</div>
                <div class="feature-description">Evolução financeira ao longo de 12 meses</div>
            </div>
            
            <div class="feature-card" onclick="generateExport()">
                <div class="feature-icon">
                    <i class="fas fa-file-export"></i>
                </div>
                <div class="feature-title">Exportar Dados</div>
                <div class="feature-description">Exporte em CSV, Excel ou PDF para análise externa</div>
            </div>
        </div>
        
        <h4 class="section-title">
            <i class="fas fa-cogs"></i> Configurar Relatório Personalizado
        </h4>
        
        <div style="background: var(--card-bg); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border);">
            <div class="form-group">
                <label class="form-label">Período</label>
                <div class="form-row">
                    <div class="form-group">
                        <input type="date" class="form-input" id="report-start" value="${DateTime.now().startOf('month').toISODate()}">
                    </div>
                    <div class="form-group">
                        <input type="date" class="form-input" id="report-end" value="${DateTime.now().endOf('month').toISODate()}">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Tipo de Relatório</label>
                <select class="form-select" id="report-type">
                    <option value="comprehensive">Completo</option>
                    <option value="income">Apenas Receitas</option>
                    <option value="expense">Apenas Despesas</option>
                    <option value="cashflow">Fluxo de Caixa</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Formato</label>
                <div class="quick-actions">
                    <button class="btn btn-secondary active" data-format="pdf">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-secondary" data-format="excel">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                    <button class="btn btn-secondary" data-format="csv">
                        <i class="fas fa-file-csv"></i> CSV
                    </button>
                </div>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="previewReport()">
                    <i class="fas fa-eye"></i> Visualizar
                </button>
                <button class="btn btn-primary" onclick="generateCustomReport()">
                    <i class="fas fa-download"></i> Gerar Relatório
                </button>
            </div>
        </div>
    `;
}

function initReports() {
    // Configura botões de formato
    document.querySelectorAll('[data-format]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-format]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

function generateMonthlyReport() {
  const now = new Date();
  const startDate = new Date(now.getFullYear(), now.getMonth(), 1);
  const endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  const title = "Relatório Mensal";
  const startIso = startDate.toISOString().slice(0,10);
  const endIso = endDate.toISOString().slice(0,10);

  const tx = (AppState.transactions || []).filter(t => {
    const d = new Date(t.date);
    return d >= startDate && d <= endDate;
  });

  const income = tx.filter(t=>t.type==="income").reduce((s,t)=>s+(Number(t.amount)||0),0);
  const expenses = tx.filter(t=>t.type==="expense").reduce((s,t)=>s+(Number(t.amount)||0),0);
  const saldo = income - expenses;

  const byCat = {};
  tx.filter(t=>t.type==="expense").forEach(t=>{
    const c = (t.category || "Outros");
    byCat[c] = (byCat[c]||0) + (Number(t.amount)||0);
  });
  const catEntries = Object.entries(byCat).sort((a,b)=>b[1]-a[1]);
  const topListHtml = catEntries.length
    ? catEntries.slice(0,6).map(([c,v])=>`<div style="display:flex;justify-content:space-between;gap:12px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.06)"><span>${escapeHtml(c)}</span><strong>${formatCurrency(v)}</strong></div>`).join("")
    : `<div style="opacity:.8">Sem despesas no período.</div>`;

  const inner = `
    <div class="sheet-section">
      <div style="opacity:.85;margin-bottom:8px">Período: ${startIso} → ${endIso}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div style="padding:10px;border-radius:12px;background:rgba(255,255,255,.05)">
          <div style="opacity:.8;font-size:12px">Receitas</div>
          <div style="font-size:18px;font-weight:700">${formatCurrency(income)}</div>
        </div>
        <div style="padding:10px;border-radius:12px;background:rgba(255,255,255,.05)">
          <div style="opacity:.8;font-size:12px">Despesas</div>
          <div style="font-size:18px;font-weight:700">${formatCurrency(expenses)}</div>
        </div>
        <div style="padding:10px;border-radius:12px;background:rgba(255,255,255,.05)">
          <div style="opacity:.8;font-size:12px">Saldo</div>
          <div style="font-size:18px;font-weight:700">${formatCurrency(saldo)}</div>
        </div>
        <div style="padding:10px;border-radius:12px;background:rgba(255,255,255,.05)">
          <div style="opacity:.8;font-size:12px">Transações</div>
          <div style="font-size:18px;font-weight:700">${tx.length}</div>
        </div>
      </div>
    </div>

    <div class="sheet-section">
      <div style="font-weight:700;margin:4px 0 8px">Despesas por categoria</div>
      <div class="chart-wrapper">
        <canvas id="monthlyCategoryChart"></canvas>
      </div>
      <div style="margin-top:10px">
        ${topListHtml}
      </div>
    </div>
  `;

  openSettingsSheet(title, inner);

  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    const canvas = document.getElementById("monthlyCategoryChart");
    if (!canvas) return;
    const labels = catEntries.map(e=>e[0]).slice(0,10);
    const values = catEntries.map(e=>e[1]).slice(0,10);
    safeDestroyChart("monthlyCategoryChart");
    if (!labels.length) return;
    window.__charts = window.__charts || {};
    window.__charts["monthlyCategoryChart"] = new Chart(canvas, {
      type: "doughnut",
      data: { labels, datasets: [{ data: values }] },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { position: "bottom", labels: { boxWidth: 10 } },
          tooltip: {
            callbacks: {
              label: (tt) => {
                const v = tt.parsed;
                const total = values.reduce((s,x)=>s+x,0) || 1;
                const pct = (v/total*100);
                return `${tt.label}: ${formatCurrency(v)} (${pct.toFixed(1)}%)`;
              }
            }
          }
        }
      }
    });
  }));
}

function generateCategoryReport() {
  const startStr = document.getElementById('reportStartDate')?.value;
  const endStr = document.getElementById('reportEndDate')?.value;

  const startDate = startStr ? new Date(startStr) : new Date(new Date().getFullYear(), new Date().getMonth(), 1);
  const endDate = endStr ? new Date(endStr) : new Date(new Date().getFullYear(), new Date().getMonth()+1, 0);

  const startIso = startDate.toISOString().slice(0,10);
  const endIso = endDate.toISOString().slice(0,10);

  const tx = (AppState.transactions || []).filter(t => {
    const d = new Date(t.date);
    return d >= startDate && d <= endDate && t.type === "expense";
  });

  const byCat = {};
  tx.forEach(t=>{
    const c = (t.category || "Outros");
    byCat[c] = (byCat[c]||0) + (Number(t.amount)||0);
  });

  const entries = Object.entries(byCat).sort((a,b)=>b[1]-a[1]);
  const labels = entries.map(e=>e[0]).slice(0,12);
  const values = entries.map(e=>e[1]).slice(0,12);

  const inner = `
    <div class="sheet-section">
      <div style="opacity:.85;margin-bottom:8px">Período: ${startIso} → ${endIso}</div>
      <div class="chart-wrapper">
        <canvas id="categoryChart"></canvas>
      </div>
      <div style="margin-top:10px">
        ${entries.length ? entries.slice(0,8).map(([c,v])=>`<div style="display:flex;justify-content:space-between;gap:12px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.06)"><span>${escapeHtml(c)}</span><strong>${formatCurrency(v)}</strong></div>`).join("") : `<div style="opacity:.8">Sem despesas no período.</div>`}
      </div>
    </div>
  `;
  openSettingsSheet("Relatório por Categoria", inner);

  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    const canvas = document.getElementById("categoryChart");
    if (!canvas) return;
    safeDestroyChart("categoryChart");
    if (!labels.length) return;
    window.__charts = window.__charts || {};
    window.__charts["categoryChart"] = new Chart(canvas, {
      type: "bar",
      data: { labels, datasets: [{ label: "Despesas", data: values }] },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { callback: (v)=> formatCurrency(v) }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: (tt)=> `${formatCurrency(tt.parsed.y)}` } }
        }
      }
    });
  }));
}

function generateAnnualReport() {
  const year = new Date().getFullYear();
  const months = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
  const incomeByMonth = new Array(12).fill(0);
  const expenseByMonth = new Array(12).fill(0);

  (AppState.transactions || []).forEach(t=>{
    const d = new Date(t.date);
    if (d.getFullYear() !== year) return;
    const m = d.getMonth();
    const amt = Number(t.amount)||0;
    if (t.type==="income") incomeByMonth[m]+=amt;
    else if (t.type==="expense") expenseByMonth[m]+=amt;
  });

  const inner = `
    <div class="sheet-section">
      <div style="opacity:.85;margin-bottom:8px">Ano: ${year}</div>
      <div class="chart-wrapper">
        <canvas id="annualChart"></canvas>
      </div>
      <div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div style="padding:10px;border-radius:12px;background:rgba(255,255,255,.05)">
          <div style="opacity:.8;font-size:12px">Receitas no ano</div>
          <div style="font-size:18px;font-weight:700">${formatCurrency(incomeByMonth.reduce((s,x)=>s+x,0))}</div>
        </div>
        <div style="padding:10px;border-radius:12px;background:rgba(255,255,255,.05)">
          <div style="opacity:.8;font-size:12px">Despesas no ano</div>
          <div style="font-size:18px;font-weight:700">${formatCurrency(expenseByMonth.reduce((s,x)=>s+x,0))}</div>
        </div>
      </div>
    </div>
  `;
  openSettingsSheet("Relatório Anual", inner);

  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    const canvas = document.getElementById("annualChart");
    if (!canvas) return;
    safeDestroyChart("annualChart");
    window.__charts = window.__charts || {};
    window.__charts["annualChart"] = new Chart(canvas, {
      type: "line",
      data: {
        labels: months,
        datasets: [
          { label: "Receitas", data: incomeByMonth, tension: .35, fill: false },
          { label: "Despesas", data: expenseByMonth, tension: .35, fill: false }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          y: { beginAtZero: true, ticks: { callback: (v)=> formatCurrency(v) } }
        },
        plugins: {
          legend: { position: "bottom" },
          tooltip: { callbacks: { label: (tt)=> `${tt.dataset.label}: ${formatCurrency(tt.parsed.y)}` } }
        }
      }
    });
  }));
}

function generateExport() {
    showNotification('Exportando dados...', 'info');
}

function previewReport() {
    showNotification('Visualizando relatório...', 'info');
}

function generateCustomReport() {
    const start = document.getElementById('report-start').value;
    const end = document.getElementById('report-end').value;
    const type = document.getElementById('report-type').value;
    
    showNotification(`Gerando relatório ${type} de ${start} até ${end}...`, 'info');
}

// ========== INSIGHTS IA ==========
function getInsightsHTML() {
    return `
        <h3 class="section-title">
            <i class="fas fa-lightbulb"></i> Insights da IA Avançada
        </h3>
        
        <div style="background: rgba(0, 212, 170, 0.1); padding: 20px; border-radius: var(--radius-lg); border: 1px solid rgba(0, 212, 170, 0.3); margin-bottom: 25px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <div style="width: 12px; height: 12px; background: var(--primary); border-radius: 50%; animation: pulse 1s infinite;"></div>
                <div style="font-weight: 600;">IA Inteligente Ativa • Análise em Tempo Real</div>
            </div>
            <div style="font-size: 14px; color: var(--text-secondary);">
                Nosso algoritmo de IA analisa seus padrões de gastos e oferece recomendações personalizadas para otimizar suas finanças.
            </div>
        </div>
        
        <div class="insights-grid" id="ai-insights-grid">
            <!-- Insights da IA serão carregados aqui -->
        </div>
        
        <h4 class="section-title mt-25">
            <i class="fas fa-chart-line"></i> Tendências Detectadas
        </h4>
        
        <div id="trends-analysis">
            <!-- Análise de tendências será carregada aqui -->
        </div>
        
        <div class="quick-actions mt-20">
            <button class="btn btn-primary" onclick="openAIPanel()">
                <i class="fas fa-robot"></i> Conversar com a IA
            </button>
            <button class="btn btn-secondary" onclick="generateDeepAnalysis()">
                <i class="fas fa-brain"></i> Análise Profunda
            </button>
            <button class="btn btn-secondary" onclick="generateForecast()">
                <i class="fas fa-crystal-ball"></i> Previsão Financeira
            </button>
        </div>
    `;
}

function initInsights() {
    loadAIInsights();
    loadTrendsAnalysis();
}

function loadAIInsights() {
    const container = document.getElementById('ai-insights-grid');
    if (!container) return;
    
    const insights = generateAdvancedInsights();
    
    container.innerHTML = insights.map((insight, index) => `
        <div class="insight-card">
            <div class="insight-icon" style="color: ${insight.color};">
                <i class="fas ${insight.icon}"></i>
            </div>
            <div class="insight-title">${insight.title}</div>
            <div class="insight-description">${insight.description}</div>
            ${insight.action ? `
                <button class="btn btn-sm btn-primary mt-15" onclick="${insight.action}">
                    ${insight.actionText}
                </button>
            ` : ''}
        </div>
    `).join('');
}

function generateAdvancedInsights() {
    const monthStart = DateTime.now().startOf('month').toISODate();
    const monthEnd = DateTime.now().endOf('month').toISODate();
    
    const monthTransactions = AppState.transactions.filter(t => 
        t.date >= monthStart && t.date <= monthEnd
    );
    
    const monthIncome = monthTransactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const monthExpense = monthTransactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const savings = monthIncome - monthExpense;
    const savingsRate = monthIncome > 0 ? (savings / monthIncome * 100) : 0;
    
    // Agrupa gastos por categoria
    const categoryTotals = {};
    monthTransactions
        .filter(t => t.type === 'expense')
        .forEach(t => {
            categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
        });
    
    // Encontra categoria com maior gasto
    let maxCategory = null;
    let maxAmount = 0;
    for (const [category, amount] of Object.entries(categoryTotals)) {
        if (amount > maxAmount) {
            maxCategory = category;
            maxAmount = amount;
        }
    }
    
    const insights = [
        {
            icon: 'fa-chart-line',
            color:
            'var(--success)',
            title: 'Taxa de Economia',
            description: savingsRate >= 20 ? 
                `Excelente! Você está economizando ${savingsRate.toFixed(1)}% da sua renda. Continue assim!` :
                savingsRate >= 10 ?
                `Bom! Você economiza ${savingsRate.toFixed(1)}%. Meta: atingir 20% para segurança financeira.` :
                `Atenção! Economia de apenas ${savingsRate.toFixed(1)}%. Recomendo cortar gastos não essenciais.`,
            action: 'showSavingsTips()',
            actionText: 'Ver Dicas'
        },
        {
            icon: 'fa-exclamation-triangle',
            color: 'var(--warning)',
            title: 'Categoria de Alto Gasto',
            description: maxCategory ? 
                `${maxCategory} é sua maior despesa (${formatCurrency(maxAmount)}). Considere revisar gastos nesta área.` :
                'Adicione mais transações para análise de categorias.',
            action: maxCategory ? `loadCategoryAnalysis('${maxCategory}')` : null,
            actionText: 'Analisar Categoria'
        },
        {
            icon: 'fa-calendar-check',
            color: 'var(--info)',
            title: 'Consistência de Gastos',
            description: calculateSpendingConsistency(),
            action: 'showConsistencyReport()',
            actionText: 'Ver Relatório'
        },
        {
            icon: 'fa-bullseye',
            color: 'var(--primary)',
            title: 'Progresso de Metas',
            description: AppState.goals.length > 0 ?
                `${AppState.goals.length} metas ativas. Progresso médio: ${calculateAverageGoalProgress()}%` :
                'Crie metas para a IA acompanhar seu progresso!',
            action: 'loadSection("goals")',
            actionText: 'Ver Metas'
        },
        {
            icon: 'fa-credit-card',
            color: 'var(--danger)',
            title: 'Uso do Cartão de Crédito',
            description: analyzeCreditCardUsage(),
            action: 'loadSection("credit-cards")',
            actionText: 'Ver Cartões'
        },
        {
            icon: 'fa-chart-pie',
            color: 'var(--primary-light)',
            title: 'Distribuição Financeira',
            description: `Renda: ${formatCurrency(monthIncome)} | Gastos: ${formatCurrency(monthExpense)} | Economia: ${formatCurrency(savings)}`,
            action: 'generateFinancialDistribution()',
            actionText: 'Ver Gráfico'
        }
    ];
    
    return insights;
}

function calculateSpendingConsistency() {
    const last30Days = AppState.transactions.filter(t => 
        t.type === 'expense' && 
        DateTime.fromISO(t.date) >= DateTime.now().minus({days: 30})
    );
    
    if (last30Days.length < 5) {
        return 'Dados insuficientes para análise de consistência.';
    }
    
    // Agrupa por dia
    const dailyTotals = {};
    last30Days.forEach(t => {
        dailyTotals[t.date] = (dailyTotals[t.date] || 0) + t.amount;
    });
    
    const daysWithSpending = Object.keys(dailyTotals).length;
    const consistency = (daysWithSpending / 30 * 100).toFixed(1);
    
    if (consistency > 70) {
        return 'Gastos muito frequentes. Considere agrupar compras para otimizar tempo e dinheiro.';
    } else if (consistency > 40) {
        return 'Frequência de gastos moderada. Padrão saudável.';
    } else {
        return 'Gastos esporádicos. Bom controle financeiro!';
    }
}

function calculateAverageGoalProgress() {
    if (AppState.goals.length === 0) return 0;
    
    const totalProgress = AppState.goals.reduce((sum, goal) => {
        return sum + (goal.current / goal.target * 100);
    }, 0);
    
    return (totalProgress / AppState.goals.length).toFixed(1);
}

function analyzeCreditCardUsage() {
    if (AppState.creditCards.length === 0) {
        return 'Nenhum cartão cadastrado. Adicione para análise.';
    }
    
    const totalLimit = AppState.creditCards.reduce((sum, card) => sum + card.limit, 0);
    const totalUsed = AppState.creditCards.reduce((sum, card) => sum + card.current, 0);
    const usagePercentage = (totalUsed / totalLimit * 100).toFixed(1);
    
    if (usagePercentage > 80) {
        return `Uso elevado: ${usagePercentage}% do limite. Risco de endividamento.`;
    } else if (usagePercentage > 50) {
        return `Uso moderado: ${usagePercentage}% do limite. Mantenha controle.`;
    } else {
        return `Uso saudável: ${usagePercentage}% do limite. Bom trabalho!`;
    }
}

function loadTrendsAnalysis() {
    const container = document.getElementById('trends-analysis');
    if (!container) return;
    
    // Análise de tendências dos últimos 3 meses
    const trends = analyzeTrends();
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            ${trends.map(trend => `
                <div style="background: var(--card-bg); padding: 15px; border-radius: var(--radius-md); border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="font-weight: 600;">${trend.category}</div>
                        <div style="font-size: 12px; color: ${trend.change >= 0 ? 'var(--success)' : 'var(--danger)'};">
                            ${trend.change >= 0 ? '+' : ''}${trend.change.toFixed(1)}%
                        </div>
                    </div>
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">
                        ${trend.description}
                    </div>
                    <div class="goal-progress">
                        <div class="goal-progress-bar" style="width: ${Math.min(Math.abs(trend.change), 100)}%; background: ${trend.change >= 0 ? 'var(--success)' : 'var(--danger)'};"></div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function analyzeTrends() {
    const trends = [];
    const categories = [...new Set(AppState.transactions.map(t => t.category))];
    
    categories.forEach(category => {
        const lastMonth = DateTime.now().minus({months: 1});
        const currentMonth = DateTime.now();
        
        const lastMonthTransactions = AppState.transactions.filter(t => 
            t.category === category && 
            DateTime.fromISO(t.date).month === lastMonth.month
        );
        
        const currentMonthTransactions = AppState.transactions.filter(t => 
            t.category === category && 
            DateTime.fromISO(t.date).month === currentMonth.month
        );
        
        const lastMonthTotal = lastMonthTransactions.reduce((sum, t) => sum + t.amount, 0);
        const currentMonthTotal = currentMonthTransactions.reduce((sum, t) => sum + t.amount, 0);
        
        if (lastMonthTotal > 0 && currentMonthTotal > 0) {
            const change = ((currentMonthTotal - lastMonthTotal) / lastMonthTotal * 100);
            
            let description = '';
            if (change > 20) {
                description = 'Aumento significativo este mês';
            } else if (change > 5) {
                description = 'Leve aumento';
            } else if (change < -20) {
                description = 'Redução significativa';
            } else if (change < -5) {
                description = 'Leve redução';
            } else {
                description = 'Estável em relação ao mês anterior';
            }
            
            if (Math.abs(change) > 5) { // Só mostra mudanças relevantes
                trends.push({
                    category,
                    change,
                    description
                });
            }
        }
    });
    
    return trends.slice(0, 4); // Retorna no máximo 4 tendências
}

function generateDeepAnalysis() {
    showNotification('Iniciando análise profunda da IA...', 'info');
    
    setTimeout(() => {
        const analysis = performDeepAnalysis();
        openSettingsSheet("An\u00e1lise Profunda", `<div class="sheet-section"><pre style="white-space:pre-wrap;line-height:1.35;margin:0">${`ANÁLISE PROFUNDA DA IA\n\n${analysis}`}</pre></div>`);}, 1000);
}

function generateForecast() {
    showNotification('Gerando previsão financeira...', 'info');
    
    setTimeout(() => {
        const forecast = generateFinancialForecast();
        openSettingsSheet("Previs\u00e3o Financeira (pr\u00f3ximos 3 meses)", `<div class="sheet-section"><pre style="white-space:pre-wrap;line-height:1.35;margin:0">${`PREVISÃO FINANCEIRA (PRÓXIMOS 3 MESES)\n\n${forecast}`}</pre></div>`);}, 1500);
}

function performDeepAnalysis() {
    let analysis = "=== ANÁLISE PROFUNDA DA IA ===\n\n";
    
    // 1. Análise de Renda
    const monthlyIncomes = calculateMonthlyAverages('income');
    analysis += `1. RENDA MENSAL MÉDIA: ${formatCurrency(monthlyIncomes.average)}\n`;
    analysis += `   Tendência: ${monthlyIncomes.trend}\n\n`;
    
    // 2. Análise de Gastos
    const monthlyExpenses = calculateMonthlyAverages('expense');
    analysis += `2. GASTOS MENSAL MÉDIO: ${formatCurrency(monthlyExpenses.average)}\n`;
    analysis += `   Tendência: ${monthlyExpenses.trend}\n\n`;
    
    // 3. Análise de Economia
    const savingsRate = calculateSavingsRate();
    analysis += `3. TAXA DE ECONOMIA: ${savingsRate}%\n`;
    analysis += `   ${getSavingsRating(savingsRate)}\n\n`;
    
    // 4. Análise de Categorias
    analysis += "4. TOP 3 CATEGORIAS DE GASTO:\n";
    const topCategories = getTopSpendingCategories();
    topCategories.forEach((cat, index) => {
        analysis += `   ${index + 1}. ${cat.category}: ${formatCurrency(cat.amount)} (${cat.percentage}%)\n`;
    });
    analysis += "\n";
    
    // 5. Recomendações
    analysis += "5. RECOMENDAÇÕES DA IA:\n";
    const recommendations = generateRecommendations();
    recommendations.forEach((rec, index) => {
        analysis += `   • ${rec}\n`;
    });
    
    return analysis;
}

function calculateMonthlyAverages(type) {
    const last6Months = [];
    const now = DateTime.now();
    
    for (let i = 0; i < 6; i++) {
        const month = now.minus({months: i});
        const monthStart = month.startOf('month').toISODate();
        const monthEnd = month.endOf('month').toISODate();
        
        const monthTransactions = AppState.transactions.filter(t => 
            t.type === type && 
            t.date >= monthStart && 
            t.date <= monthEnd
        );
        
        const total = monthTransactions.reduce((sum, t) => sum + t.amount, 0);
        last6Months.push(total);
    }
    
    const average = last6Months.reduce((sum, val) => sum + val, 0) / 6;
    
    // Calcula tendência (últimos 3 meses vs anteriores)
    const recent = last6Months.slice(0, 3).reduce((a, b) => a + b, 0) / 3;
    const previous = last6Months.slice(3, 6).reduce((a, b) => a + b, 0) / 3;
    
    let trend = "estável";
    if (previous > 0) {
        const change = ((recent - previous) / previous * 100);
        if (change > 10) trend = "em alta";
        else if (change < -10) trend = "em queda";
    }
    
    return { average, trend };
}

function calculateSavingsRate() {
    const monthlyIncomes = calculateMonthlyAverages('income');
    const monthlyExpenses = calculateMonthlyAverages('expense');
    
    if (monthlyIncomes.average === 0) return 0;
    
    const savings = monthlyIncomes.average - monthlyExpenses.average;
    return ((savings / monthlyIncomes.average) * 100).toFixed(1);
}

function getSavingsRating(rate) {
    const numRate = parseFloat(rate);
    if (numRate >= 20) return "Excelente! Você segue a regra dos 20% para investimentos.";
    if (numRate >= 15) return "Bom, mas pode melhorar. Meta: 20% para segurança financeira.";
    if (numRate >= 10) return "Razoável. Considere reduzir gastos não essenciais.";
    if (numRate >= 5) return "Baixa. Atenção ao padrão de vida.";
    return "Crítico. Recomendo revisão urgente das finanças.";
}

function getTopSpendingCategories() {
    const monthStart = DateTime.now().startOf('month').toISODate();
    const monthEnd = DateTime.now().endOf('month').toISODate();
    
    const monthExpenses = AppState.transactions.filter(t => 
        t.type === 'expense' && 
        t.date >= monthStart && 
        t.date <= monthEnd
    );
    
    const categoryTotals = {};
    monthExpenses.forEach(t => {
        categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
    });
    
    const totalExpenses = monthExpenses.reduce((sum, t) => sum + t.amount, 0);
    
    return Object.entries(categoryTotals)
        .map(([category, amount]) => ({
            category,
            amount,
            percentage: totalExpenses > 0 ? ((amount / totalExpenses) * 100).toFixed(1) : 0
        }))
        .sort((a, b) => b.amount - a.amount)
        .slice(0, 3);
}

function generateRecommendations() {
    const recommendations = [];
    const savingsRate = parseFloat(calculateSavingsRate());
    
    if (savingsRate < 10) {
        recommendations.push("Aumente sua taxa de economia para pelo menos 10% da renda");
    }
    
    const topCategories = getTopSpendingCategories();
    if (topCategories[0] && topCategories[0].percentage > 40) {
        recommendations.push(`Reduza gastos com ${topCategories[0].category} (atualmente ${topCategories[0].percentage}% dos gastos)`);
    }
    
    const creditUsage = analyzeCreditCardUsage();
    if (creditUsage.includes("elevado") || creditUsage.includes("risco")) {
        recommendations.push("Reduza utilização do cartão de crédito para abaixo de 50% do limite");
    }
    
    if (AppState.goals.length === 0) {
        recommendations.push("Crie objetivos financeiros para ter direção clara");
    }
    
    if (recommendations.length === 0) {
        recommendations.push("Continue com o bom trabalho! Suas finanças estão saudáveis.");
        recommendations.push("Considere aumentar investimentos para multiplicar seu patrimônio");
    }
    
    return recommendations.slice(0, 3);
}

function generateFinancialForecast() {
    const monthlyIncomes = calculateMonthlyAverages('income');
    const monthlyExpenses = calculateMonthlyAverages('expense');
    const savingsRate = parseFloat(calculateSavingsRate()) / 100;
    
    let forecast = "=== PREVISÃO PARA OS PRÓXIMOS 3 MESES ===\n\n";
    
    for (let i = 1; i <= 3; i++) {
        const monthName = DateTime.now().plus({months: i}).toFormat('MMMM');
        const projectedIncome = monthlyIncomes.average * (1 + (0.02 * i)); // Crescimento de 2% ao mês
        const projectedExpenses = monthlyExpenses.average * (1 + (0.015 * i)); // Crescimento de 1.5% ao mês
        const projectedSavings = projectedIncome - projectedExpenses;
        
        forecast += `${monthName.toUpperCase()}:\n`;
        forecast += `  Receita Prevista: ${formatCurrency(projectedIncome)}\n`;
        forecast += `  Despesa Prevista: ${formatCurrency(projectedExpenses)}\n`;
        forecast += `  Economia Prevista: ${formatCurrency(projectedSavings)}\n`;
        forecast += `  Taxa de Economia: ${((projectedSavings / projectedIncome) * 100).toFixed(1)}%\n\n`;
    }
    
    // Adiciona análise
    forecast += "ANÁLISE DA IA:\n";
    const projectedSavingsRate = savingsRate * 100;
    
    if (projectedSavingsRate > 20) {
        forecast += "✓ Projeção excelente! Mantenha o ritmo.\n";
        forecast += "✓ Considere investir parte da economia em ativos de maior retorno.\n";
    } else if (projectedSavingsRate > 10) {
        forecast += "✓ Projeção boa. Continue otimizando seus gastos.\n";
        forecast += "✓ Tente identificar mais oportunidades de economia.\n";
    } else {
        forecast += "⚠ Atenção: Projeção indica baixa margem de segurança.\n";
        forecast += "⚠ Recomendo revisar gastos fixos e variáveis.\n";
    }
    
    return forecast;
}

// ========== CONFIGURAÇÕES ==========
function getSettingsHTML() {
    return `
        <h3 class="section-title">
            <i class="fas fa-cog"></i> Configurações do Sistema
        </h3>
        
        <div class="features-grid mb-25">
            <div class="feature-card" onclick="loadSection('accounts')">
                <div class="feature-icon">
                    <i class="fas fa-university"></i>
                </div>
                <div class="feature-title">Contas Bancárias</div>
                <div class="feature-description">Gerencie suas contas e conexões bancárias</div>
            </div>
            
            <div class="feature-card" onclick="showBackupSettings()">
                <div class="feature-icon">
                    <i class="fas fa-database"></i>
                </div>
                <div class="feature-title">Backup & Restauração</div>
                <div class="feature-description">Faça backup dos seus dados ou restaure de arquivos</div>
            </div>
            
            <div class="feature-card" onclick="showNotificationSettings()">
                <div class="feature-icon">
                    <i class="fas fa-bell"></i>
                </div>
                <div class="feature-title">Notificações</div>
                <div class="feature-description">Configure alertas e lembretes</div>
            </div>
            
            <div class="feature-card" onclick="showExportSettings()">
                <div class="feature-icon">
                    <i class="fas fa-file-export"></i>
                </div>
                <div class="feature-title">Exportação</div>
                <div class="feature-description">Exporte dados em vários formatos</div>
            </div>
        </div>
        
        <h4 class="section-title">
            <i class="fas fa-user-cog"></i> Preferências
        </h4>
        
        <div style="background: var(--card-bg); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border);">
            <div class="form-group">
                <label class="form-label" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Tema Escuro</span>
                    <label class="switch">
                        <input type="checkbox" id="dark-theme" ${AppState.settings.theme === 'dark' ? 'checked' : ''} onchange="toggleTheme(this.checked)">
                        <span class="slider"></span>
                    </label>
                </label>
            </div>
            
            <div class="form-group">
                <label class="form-label" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>IA Ativada</span>
                    <label class="switch">
                        <input type="checkbox" id="ai-enabled" ${AppState.settings.aiEnabled ? 'checked' : ''} onchange="toggleAI(this.checked)">
                        <span class="slider"></span>
                    </label>
                </label>
                <div style="font-size: 12px; color: var(--text-tertiary);">
                    ${hasPremiumAccess() ? 'Análises e recomendações inteligentes ativas' : 'Requer conta Premium'}
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Controle por Voz</span>
                    <label class="switch">
                        <input type="checkbox" id="voice-control" ${AppState.settings.voiceControl ? 'checked' : ''} onchange="toggleVoiceControl(this.checked)">
                        <span class="slider"></span>
                    </label>
                </label>
            </div>
            
            <div class="form-group">
                <label class="form-label" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Categorização Automática</span>
                    <label class="switch">
                        <input type="checkbox" id="auto-categorization" ${AppState.settings.autoCategorization ? 'checked' : ''} onchange="toggleAutoCategorization(this.checked)">
                        <span class="slider"></span>
                    </label>
                </label>
            </div>
            
            <div class="form-group">
                <label class="form-label" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Notificações</span>
                    <label class="switch">
                        <input type="checkbox" id="notifications" ${AppState.settings.notifications ? 'checked' : ''} onchange="toggleNotifications(this.checked)">
                        <span class="slider"></span>
                    </label>
                </label>
            </div>
            
            <div class="form-group">
                <label class="form-label" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Sintetizador de Voz (TTS)</span>
                    <label class="switch">
                        <input type="checkbox" id="tts-enabled" ${AppState.settings.ttsEnabled ? 'checked' : ''} onchange="toggleTTS(this.checked)" ${hasPremiumAccess() ? '' : 'disabled'}>
                        <span class="slider"></span>
                    </label>
                </label>
                <div style="font-size: 12px; color: var(--text-tertiary);">
                    ${hasPremiumAccess() ? 'A IA fala as respostas em voz alta' : 'Recurso Premium'}
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Análises Avançadas</span>
                    <label class="switch">
                        <input type="checkbox" id="advanced-analytics" ${AppState.settings.advancedAnalytics ? 'checked' : ''} onchange="toggleAdvancedAnalytics(this.checked)" ${hasPremiumAccess() ? '' : 'disabled'}>
                        <span class="slider"></span>
                    </label>
                </label>
                <div style="font-size: 12px; color: var(--text-tertiary);">
                    ${hasPremiumAccess() ? 'Gráficos e estatísticas detalhadas' : 'Recurso Premium'}
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Moeda</label>
                <select class="form-select" id="currency" onchange="changeCurrency(this.value)">
                    <option value="BRL" ${AppState.settings.currency === 'BRL' ? 'selected' : ''}>Real Brasileiro (R$)</option>
                    <option value="USD" ${AppState.settings.currency === 'USD' ? 'selected' : ''}>Dólar Americano ($)</option>
                    <option value="EUR" ${AppState.settings.currency === 'EUR' ? 'selected' : ''}>Euro (€)</option>
                    <option value="GBP" ${AppState.settings.currency === 'GBP' ? 'selected' : ''}>Libra Esterlina (£)</option>
                </select>
            </div>
            
            <div class="form-actions" style="margin-top: 25px;">
                <button class="btn btn-secondary" onclick="resetSettings()">
                    <i class="fas fa-undo"></i> Restaurar Padrões
                </button>
                <button class="btn btn-primary" onclick="saveSettings()">
                    <i class="fas fa-save"></i> Salvar Configurações
                </button>
            </div>
        </div>
        
        <h4 class="section-title mt-25">
            <i class="fas fa-shield-alt"></i> Segurança e Privacidade
        </h4>
        
        <div style="background: var(--card-bg); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border);">
            <div class="form-group">
                <label class="form-label">Bloquear App</label>
                <button class="btn btn-secondary" style="width: 100%;" onclick="setupAppLock()">
                    <i class="fas fa-lock"></i> Configurar Bloqueio por Senha
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Excluir Dados</label>
                <div class="form-row">
                    <button class="btn btn-danger" onclick="clearAllData()">
                        <i class="fas fa-trash"></i> Limpar Todos os Dados
                    </button>
                    <button class="btn btn-secondary" onclick="exportAllData()">
                        <i class="fas fa-download"></i> Exportar Backup
                    </button>
                </div>
                <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 10px;">
                    Atenção: A exclusão de dados é permanente e irreversível.
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Versão do Sistema</label>
                <div style="padding: 10px; background: var(--glass); border-radius: var(--radius-md);">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Finanças IA Pro Premium</span>
                        <span>v2.5.1</span>
                    </div>
                    <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 5px;">
                        Última atualização: ${DateTime.now().toFormat('dd/MM/yyyy')}
                    </div>
                </div>
            </div>
        </div>
        
        <style>
            .switch {
                position: relative;
                display: inline-block;
                width: 50px;
                height: 24px;
            }
            
            .switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            
            .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: var(--border);
                transition: .4s;
                border-radius: 34px;
            }
            
            .slider:before {
                position: absolute;
                content: "";
                height: 16px;
                width: 16px;
                left: 4px;
                bottom: 4px;
                background-color: white;
                transition: .4s;
                border-radius: 50%;
            }
            
            input:checked + .slider {
                background-color: var(--primary);
            }
            
            input:checked + .slider:before {
                transform: translateX(26px);
            }
        
/* ===== K-DEV RESPONSIVE PREMIUM CHART PATCH ===== */
.chart-wrapper {
  height: auto !important;
  min-height: 180px;
  max-height: 320px;
}
.chart-wrapper canvas {
  width: 100% !important;
  height: auto !important;
  max-height: 320px !important;
}
/* ===== END PATCH ===== */

</style>
    `;
}

function initSettings() {
    // PATCH: sincroniza UI de Configurações com AppState
    const setChecked = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.checked = !!val;
    };
    const setValue = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.value = val;
    };

    setChecked('dark-theme', (AppState.settings.theme || 'dark') === 'dark');
    setChecked('ai-enabled', !!AppState.settings.aiEnabled);
    setChecked('voice-control', !!AppState.settings.voiceControl);
    setChecked('auto-categorization', !!AppState.settings.autoCategorization);
    setChecked('notifications', !!AppState.settings.notifications);
    setChecked('tts-enabled', !!AppState.settings.ttsEnabled);
    setChecked('advanced-analytics', !!AppState.settings.advancedAnalytics);
    setValue('currency', AppState.settings.currency || 'BRL');
}
function toggleTheme(isDark) {
    AppState.settings.theme = isDark ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', AppState.settings.theme);
    saveAppData();
}

function toggleAI(enabled) {
    if (!hasPremiumAccess() && enabled) {
        showNotification('Recurso disponível apenas para contas Premium', 'warning');
        document.getElementById('ai-enabled').checked = false;
        return;
    }
    
    AppState.settings.aiEnabled = enabled;
    saveAppData();
    showNotification(`IA ${enabled ? 'ativada' : 'desativada'}`, 'info');
}

function toggleVoiceControl(enabled) {
    AppState.settings.voiceControl = enabled;
    saveAppData();
    showNotification(`Controle por voz ${enabled ? 'ativado' : 'desativado'}`, 'info');
}

function toggleAutoCategorization(enabled) {
    AppState.settings.autoCategorization = enabled;
    saveAppData();
    showNotification(`Categorização automática ${enabled ? 'ativada' : 'desativada'}`, 'info');
}

function toggleNotifications(enabled) {
    AppState.settings.notifications = enabled;
    saveAppData();
    showNotification(`Notificações ${enabled ? 'ativadas' : 'desativadas'}`, 'info');
}

function toggleTTS(enabled) {
    if (!hasPremiumAccess()) {
        showNotification('Recurso disponível apenas para contas Premium', 'warning');
        document.getElementById('tts-enabled').checked = false;
        return;
    }
    
    AppState.settings.ttsEnabled = enabled;
    saveAppData();
    showNotification(`Sintetizador de voz ${enabled ? 'ativado' : 'desativado'}`, 'info');
}

function toggleAdvancedAnalytics(enabled) {
    if (!hasPremiumAccess()) {
        showNotification('Recurso disponível apenas para contas Premium', 'warning');
        document.getElementById('advanced-analytics').checked = false;
        return;
    }
    
    AppState.settings.advancedAnalytics = enabled;
    saveAppData();
    showNotification(`Análises avançadas ${enabled ? 'ativadas' : 'desativadas'}`, 'info');
}

function changeCurrency(currency) {
    AppState.settings.currency = currency;
    saveAppData();
    showNotification(`Moeda alterada para ${getCurrencyName(currency)}`, 'info');
    loadSection(AppState.currentSection); // Recarrega a seção atual para atualizar valores
}

function getCurrencyName(code) {
    const currencies = {
        'BRL': 'Real Brasileiro',
        'USD': 'Dólar Americano',
        'EUR': 'Euro',
        'GBP': 'Libra Esterlina'
    };
    return currencies[code] || code;
}

function resetSettings() {
    if (confirm('Restaurar configurações padrão? Suas preferências serão perdidas.')) {
        AppState.settings = {
            theme: "dark",
            currency: "BRL",
            aiEnabled: hasPremiumAccess(), // Mantém o status da IA baseado no tipo de conta
            voiceControl: true,
            autoCategorization: true,
            notifications: true,
            accountType: AppState.settings.accountType, // Mantém tipo de conta
            ttsEnabled: hasPremiumAccess() ? true : false,
            advancedAnalytics: hasPremiumAccess() ? true : false
        };
        
        saveAppData();
        loadSection('settings');
        showNotification('Configurações restauradas com sucesso', 'success');
    }
}

function saveSettings() {
    // PATCH: aplica e salva configurações
    try {
        // força premium
        fp_applyUserPlanToAppState();
        // aplica tema
        document.documentElement.setAttribute('data-theme', AppState.settings.theme || 'dark');
        updateAccountTypeUI();
        saveAppData();
        showNotification('Configurações salvas com sucesso', 'success');
    } catch (e) {
        console.error(e);
        showNotification('Erro ao salvar configurações', 'error');
    }
}


function showBackupSettings() {
    openSettingsSheet('Backup & Restauração', `
        <div class="sheet-section">
            <p style="margin:0 0 12px 0; color: var(--text-secondary);">Faça backup completo do app (JSON) e restaure quando precisar.</p>
            <button class="btn" style="width:100%; margin-bottom:10px;" onclick="exportAllData()">Exportar Backup (JSON)</button>
            <label class="btn" style="width:100%; display:flex; justify-content:center; gap:10px; align-items:center; margin-bottom:10px; cursor:pointer;">
                <i class="fas fa-upload"></i> Importar Backup (JSON)
                <input type="file" id="backup-import-file" accept=".json,application/json" style="display:none" onchange="importAllDataFromFile(event)">
            </label>
            <button class="btn btn-danger" style="width:100%;" onclick="clearAllData()">Limpar Todos os Dados</button>
            <div style="margin-top:10px; font-size:12px; color: var(--text-tertiary);">Atenção: a importação substitui os dados atuais.</div>
        </div>
    `);
}
function showNotificationSettings() {
    openSettingsSheet('Notificações', `
        <div class="sheet-row">
            <div>
                <div style="font-weight:600;">Ativar Notificações</div>
                <div style="font-size:12px; color: var(--text-tertiary);">Alertas e lembretes do sistema</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="sheet-notifications" ${AppState.settings.notifications ? 'checked' : ''} onchange="toggleNotifications(this.checked); syncSettingsToggles();">
                <span class="slider"></span>
            </label>
        </div>
        <button class="btn" style="width:100%; margin-top:12px;" onclick="showNotification('Notificação de teste ✅', 'success')">Enviar Notificação de Teste</button>
    `);
}
function showExportSettings() {
    openSettingsSheet('Exportação', `
        <div class="sheet-section">
            <p style="margin:0 0 12px 0; color: var(--text-secondary);">Exporte seus dados para análise externa.</p>
            <button class="btn" style="width:100%; margin-bottom:10px;" onclick="exportAllData()">Exportar JSON Completo</button>
            <button class="btn" style="width:100%; margin-bottom:10px;" onclick="exportTransactionsCSV()">Exportar Transações (CSV)</button>
            <button class="btn" style="width:100%;" onclick="exportBudgetsCSV()">Exportar Orçamentos (CSV)</button>
        </div>
    `);
}
function setupAppLock() {
    const password = prompt('Digite uma senha para bloquear o aplicativo:');
    if (password) {
        localStorage.setItem('app_lock', btoa(password));
        showNotification('Bloqueio por senha configurado com sucesso', 'success');
    }
}

function clearAllData() {
    if (confirm('Tem certeza que deseja EXCLUIR TODOS os dados?\nEsta ação é irreversível!')) {
        localStorage.clear();
        location.reload();
    }
}

function exportAllData() {
    const dataStr = JSON.stringify(AppState, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `backup_financas_ia_${DateTime.now().toFormat('yyyy-MM-dd')}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showNotification('Backup exportado com sucesso', 'success');
}

// ========== FORMULÁRIOS ==========
function initForms() {
    // Configura botões de tipo de transação
    document.querySelectorAll('#transaction-form [data-type]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#transaction-form [data-type]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // Configura botões de pagamento
    document.querySelectorAll('[data-payment]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-payment]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // Configura botões de parcela
    document.querySelectorAll('[data-installment]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-installment]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const isInstallment = this.dataset.installment === 'installment';
            document.getElementById('installment-section').style.display = isInstallment ? 'block' : 'none';
            
            if (isInstallment) {
                updateInstallmentTotal();
            }
        });
    });
    
    // Configura opções de recorrência
    document.querySelectorAll('.recurrence-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.recurrence-option').forEach(o => o.classList.remove('active'));
            this.classList.add('active');
            
            const hasRecurrence = this.dataset.recurrence !== 'none';
            document.getElementById('recurrence-details').style.display = hasRecurrence ? 'block' : 'none';
        });
    });
    
    // Atualiza total das parcelas
    const amountInput = document.getElementById('amount');
    const installmentCount = document.getElementById('installment-count');
    
    if (amountInput && installmentCount) {
        amountInput.addEventListener('input', updateInstallmentTotal);
        installmentCount.addEventListener('input', updateInstallmentTotal);
    }
    
    // Botão hoje
    const todayBtn = document.getElementById('date-today');
    if (todayBtn) {
        todayBtn.addEventListener('click', () => {
            document.getElementById('date').value = DateTime.now().toISODate();
        });
    }
    
    // Fecha formulários
    document.querySelectorAll('.form-close').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.form-overlay').classList.remove('active');
        });
    });
    
    // Submissão do formulário
    const transactionForm = document.getElementById('transaction-form-data');
    if (transactionForm) {
        transactionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            saveTransaction();
        });
    }
    
    // Botão duplicar transação
    const duplicateBtn = document.getElementById('duplicate-transaction');
    if (duplicateBtn) {
        duplicateBtn.addEventListener('click', duplicateCurrentForm);
    }
    
    // Carrega categorias
    loadCategoriesToForm();
    loadAccountsToForm();
    loadMembersToForm();
}

function loadCategoriesToForm() {
    const categorySelect = document.getElementById('category');
    const subcategorySelect = document.getElementById('subcategory');
    
    if (!categorySelect || !subcategorySelect) return;
    
    // Limpa opções
    categorySelect.innerHTML = '<option value="">Selecione uma categoria</option>';
    subcategorySelect.innerHTML = '<option value="">Opcional</option>';
    
    // Adiciona categorias de despesas
    AppState.categories.expenses.forEach(category => {
        const option = document.createElement('option');
        option.value = category.name;
        option.textContent = category.name;
        option.dataset.type = 'expense';
        categorySelect.appendChild(option);
    });
    
    // Adiciona categorias de receitas
    AppState.categories.income.forEach(category => {
        const option = document.createElement('option');
        option.value = category.name;
        option.textContent = category.name;
        option.dataset.type = 'income';
        categorySelect.appendChild(option);
    });
    
    // Atualiza subcategorias quando categoria muda
    categorySelect.addEventListener('change', function() {
        const selectedCategory = this.value;
        const allCategories = [...AppState.categories.expenses, ...AppState.categories.income];
        const category = allCategories.find(c => c.name === selectedCategory);
        
        // Limpa subcategorias
        subcategorySelect.innerHTML = '<option value="">Opcional</option>';
        
        // Adiciona subcategorias se existirem
        if (category && category.subcategories) {
            category.subcategories.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                subcategorySelect.appendChild(option);
            });
        }
    });
}

function loadAccountsToForm() {
    const accountSelect = document.getElementById('account');
    if (!accountSelect) return;
    
    // Limpa opções
    accountSelect.innerHTML = '<option value="">Selecione uma conta</option>';
    
    // Adiciona contas
    AppState.accounts.forEach(account => {
        const option = document.createElement('option');
        option.value = account.name;
        option.textContent = `${account.name} (${formatCurrency(account.balance)})`;
        accountSelect.appendChild(option);
    });
}

function loadMembersToForm() {
    const memberSelect = document.getElementById('member');
    if (!memberSelect) return;
    
    // Limpa opções
    memberSelect.innerHTML = '<option value="">Escolher membro</option>';
    
    // Adiciona membros
    AppState.members.forEach(member => {
        const option = document.createElement('option');
        option.value = member.name;
        option.textContent = member.name;
        memberSelect.appendChild(option);
    });
}

function updateInstallmentTotal() {
    const amount = parseFloat(document.getElementById('amount').value) || 0;
    const count = parseInt(document.getElementById('installment-count').value) || 1;
    const total = amount * count;
    
    document.getElementById('installment-total').textContent = formatCurrency(total);
}

function openTransactionForm(type) {
    const form = document.getElementById('transaction-form');
    if (!form) return;
    
    // Reseta formulário
    document.getElementById('transaction-form-data').reset();
    
    // Define tipo padrão
    document.querySelectorAll('[data-type]').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.type === type) {
            btn.classList.add('active');
        }
    });
    
    // Mostra formulário
    form.classList.add('active');
    
    // Foca no campo de valor
    setTimeout(() => {
        document.getElementById('amount').focus();
    }, 300);
}

function saveTransaction() {
    // Coleta dados do formulário
    const type = document.querySelector('#transaction-form [data-type].active')?.dataset.type || 'expense';
    const amount = parseFloat(document.getElementById('amount').value);
    const description = document.getElementById('description').value;
    const category = document.getElementById('category').value;
    const subcategory = document.getElementById('subcategory').value;
    const account = document.getElementById('account').value;
    const date = document.getElementById('date').value;
    const paymentMethod = document.querySelector('[data-payment].active')?.dataset.payment || 'debit';
    const isInstallment = document.querySelector('[data-installment].active')?.dataset.installment === 'installment';
    const installmentCount = isInstallment ? parseInt(document.getElementById('installment-count').value) || 1 : 1;
    const recurrence = document.querySelector('.recurrence-option.active')?.dataset.recurrence || 'none';
    const member = document.getElementById('member').value || null;
    const notes = document.getElementById('notes').value;
    const paid = document.getElementById('paid').checked;
    
    // Validação básica
    if (!amount || amount <= 0) {
        showNotification('Digite um valor válido', 'error');
        return;
    }
    
    if (!description.trim()) {
        showNotification('Digite uma descrição', 'error');
        return;
    }
    
    if (!category) {
        showNotification('Selecione uma categoria', 'error');
        return;
    }
    
    if (!account) {
        showNotification('Selecione uma conta', 'error');
        return;
    }
    
    if (!date) {
        showNotification('Selecione uma data', 'error');
        return;
    }
    
    // Cria nova transação
    const newTransaction = {
        id: Date.now(),
        date,
        type,
        amount,
        category,
        subcategory: subcategory || null,
        description,
        account,
        paymentMethod,
        installments: installmentCount,
        paid,
        member,
        notes,
        recurrence
    };
    
    // Adiciona ao estado
    AppState.transactions.push(newTransaction);
    
    // Atualiza saldo da conta
    if (paid) {
        const accountObj = AppState.accounts.find(a => a.name === account);
        if (accountObj) {
            if (type === 'income') {
                accountObj.balance += amount;
            } else if (type === 'expense') {
                accountObj.balance -= amount;
            }
        }
    }
    
    // Salva dados
    saveAppData();
    
    // Fecha formulário
    document.getElementById('transaction-form').classList.remove('active');
    
    // Mostra confirmação
    showNotification(`${type === 'income' ? 'Receita' : 'Despesa'} registrada com sucesso!`, 'success');
    
    // Recarrega seção atual
    loadSection(AppState.currentSection);
}

function duplicateTransaction(id) {
    const transaction = AppState.transactions.find(t => t.id === id);
    if (!transaction) return;
    
    // Abre formulário com dados da transação
    openTransactionForm(transaction.type);
    
    // Preenche formulário (aguarda um pouco para o formulário abrir)
    setTimeout(() => {
        document.getElementById('amount').value = transaction.amount;
        document.getElementById('description').value = `${transaction.description} (cópia)`;
        document.getElementById('category').value = transaction.category;
        document.getElementById('account').value = transaction.account;
        document.getElementById('date').value = DateTime.now().toISODate();
        
        // Atualiza subcategorias se necessário
        const categorySelect = document.getElementById('category');
        if (categorySelect) {
            categorySelect.dispatchEvent(new Event('change'));
            setTimeout(() => {
                if (transaction.subcategory) {
                    document.getElementById('subcategory').value = transaction.subcategory;
                }
            }, 100);
        }
    }, 500);
}

function duplicateCurrentForm() {
    const amount = document.getElementById('amount').value;
    const description = document.getElementById('description').value;
    
    if (!amount || !description) {
        showNotification('Preencha os campos principais primeiro', 'warning');
        return;
    }
    
    document.getElementById('description').value = `${description} (cópia)`;
    showNotification('Formulário duplicado para edição', 'info');
}

function editTransaction(id) {
    showNotification('Edição de transação em desenvolvimento', 'info');
}

function deleteTransaction(id) {
    if (confirm('Tem certeza que deseja excluir esta transação?')) {
        const transaction = AppState.transactions.find(t => t.id === id);
        
        // Remove do array
        AppState.transactions = AppState.transactions.filter(t => t.id !== id);
        
        // Ajusta saldo da conta
        if (transaction && transaction.paid) {
            const accountObj = AppState.accounts.find(a => a.name === transaction.account);
            if (accountObj) {
                if (transaction.type === 'income') {
                    accountObj.balance -= transaction.amount;
                } else if (transaction.type === 'expense') {
                    accountObj.balance += transaction.amount;
                }
            }
        }
        
        saveAppData();
        showNotification('Transação excluída com sucesso', 'success');
        loadSection(AppState.currentSection);
    }
}

// ========== IA AVANÇADA ==========
function initAdvancedAI() {
    const aiButton = document.getElementById('ai-button');
    if (!aiButton) return;
    
    aiButton.addEventListener('click', openAIPanel);
    
    // Configura IA por voz se disponível
    if (AppState.settings.voiceControl) {
        initVoiceRecognition();
    }
}

function openAIPanel() {
    if (!hasPremiumAccess()) {
        showNotification('Assistente IA disponível apenas para contas Premium', 'warning');
        return;
    }
    
    const panel = document.getElementById('ai-panel');
    if (!panel) return;
    
    panel.classList.add('active');
    
    // Foca no campo de entrada
    setTimeout(() => {
        document.getElementById('ai-question').focus();
    }, 300);
}

function initVoiceRecognition() {
    // Verifica se o navegador suporta reconhecimento de voz
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        console.log('Reconhecimento de voz não suportado');
        return;
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'pt-BR';
    recognition.continuous = false;
    recognition.interimResults = false;
    
    // Botão de voz no painel da IA
    const voiceButton = document.getElementById('ai-voice-input');
    if (voiceButton) {
        voiceButton.addEventListener('click', () => {
            recognition.start();
            voiceButton.classList.add('listening');
        });
    }
    
    // Botão de voz principal
    const aiVoiceStart = document.getElementById('ai-voice-start');
    if (aiVoiceStart) {
        aiVoiceStart.addEventListener('click', () => {
            recognition.start();
            aiVoiceStart.classList.add('listening');
        });
    }
    
    // Resultados do reconhecimento
    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        const aiQuestion = document.getElementById('ai-question');
        
        if (aiQuestion) {
            aiQuestion.value = transcript;
            processAICommand(transcript);
        }
        
        // Remove classe de listening
        document.querySelectorAll('.listening').forEach(el => {
            el.classList.remove('listening');
        });
    };
    
    recognition.onerror = function(event) {
        console.error('Erro no reconhecimento de voz:', event.error);
        document.querySelectorAll('.listening').forEach(el => {
            el.classList.remove('listening');
        });
    };
    
    recognition.onend = function() {
        document.querySelectorAll('.listening').forEach(el => {
            el.classList.remove('listening');
        });
    };
}

function processAICommand(command) {
    if (!hasPremiumAccess()) {
        addAIMessage('Este recurso requer conta Premium. Ative a conta para usar a IA completa.', true);
        return;
    }
    
    command = command.toLowerCase();
    addAIMessage(`Você: ${command}`, false);
    
    // Respostas pré-definidas baseadas em comandos comuns
    let response = "Entendi seu comando. ";
    
    if (command.includes('saldo') || command.includes('quanto tenho')) {
        const totalBalance = AppState.accounts.reduce((sum, acc) => sum + acc.balance, 0);
        response = `Seu saldo total é ${formatCurrency(totalBalance)}. `;
        
        // Detalha por conta
        response += "Detalhes por conta: ";
        AppState.accounts.forEach(acc => {
            response += `${acc.name}: ${formatCurrency(acc.balance)}. `;
        });
    }
    else if (command.includes('gastei este mês') || command.includes('gasto do mês')) {
        const monthStart = DateTime.now().startOf('month').toISODate();
        const monthEnd = DateTime.now().endOf('month').toISODate();
        
        const monthExpense = AppState.transactions
            .filter(t => t.type === 'expense' && t.date >= monthStart && t.date <= monthEnd)
            .reduce((sum, t) => sum + t.amount, 0);
        
        response = `Este mês você gastou ${formatCurrency(monthExpense)}. `;
        
        // Adiciona análise
        const dailyAvg = (monthExpense / DateTime.now().day).toFixed(2);
        response += `Isso dá uma média de ${formatCurrency(dailyAvg)} por dia. `;
        
        if (monthExpense > 0) {
            const daysInMonth = DateTime.now().daysInMonth;
            const projected = monthExpense / DateTime.now().day * daysInMonth;
            response += `Projeção para fim do mês: ${formatCurrency(projected)}.`;
        }
    }
    else if (command.includes('receita') || command.includes('ganhei')) {
        const monthStart = DateTime.now().startOf('month').toISODate();
        const monthEnd = DateTime.now().endOf('month').toISODate();
        
        const monthIncome = AppState.transactions
            .filter(t => t.type === 'income' && t.date >= monthStart && t.date <= monthEnd)
            .reduce((sum, t) => sum + t.amount, 0);
        
        response = `Este mês você recebeu ${formatCurrency(monthIncome)}. `;
    }
    else if (command.includes('economia') || command.includes('poupança')) {
        const monthStart = DateTime.now().startOf('month').toISODate();
        const monthEnd = DateTime.now().endOf('month').toISODate();
        
        const monthIncome = AppState.transactions
            .filter(t => t.type === 'income' && t.date >= monthStart && t.date <= monthEnd)
            .reduce((sum, t) => sum + t.amount, 0);
        
        const monthExpense = AppState.transactions
            .filter(t => t.type === 'expense' && t.date >= monthStart && t.date <= monthEnd)
            .reduce((sum, t) => sum + t.amount, 0);
        
        const savings = monthIncome - monthExpense;
        const savingsRate = monthIncome > 0 ? (savings / monthIncome * 100).toFixed(1) : 0;
        
        response = `Sua economia deste mês é ${formatCurrency(savings)} (${savingsRate}% da renda). `;
        
        if (savingsRate < 10) {
            response += "Sua taxa de economia está baixa. Recomendo cortar gastos não essenciais.";
        } else if (savingsRate < 20) {
            response += "Bom trabalho! Mas tente atingir 20% para maior segurança financeira.";
        } else {
            response += "Excelente! Você segue a regra dos 20% para investimentos. Continue assim!";
        }
    }
    else if (command.includes('categoria') && (command.includes('mais') || command.includes('gasto'))) {
        const monthStart = DateTime.now().startOf('month').toISODate();
        const monthEnd = DateTime.now().endOf('month').toISODate();
        
        const monthExpenses = AppState.transactions.filter(t => 
            t.type === 'expense' && t.date >= monthStart && t.date <= monthEnd
        );
        
        const categoryTotals = {};
        monthExpenses.forEach(t => {
            categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
        });
        
        const maxCategory = Object.entries(categoryTotals).reduce((a, b) => a[1] > b[1] ? a : b, ['Nenhuma', 0]);
        
        response = `Sua categoria com maior gasto este mês é ${maxCategory[0]} com ${formatCurrency(maxCategory[1])}. `;
        
        // Sugere redução se for muito alta
        const totalExpenses = monthExpenses.reduce((sum, t) => sum + t.amount, 0);
        if (totalExpenses > 0) {
            const percentage = (maxCategory[1] / totalExpenses * 100).toFixed(1);
            response += `Isso representa ${percentage}% de todos os seus gastos. `;
            
            if (percentage > 40) {
                response += "Essa porcentagem está alta. Considere reduzir gastos nesta categoria.";
            }
        }
    }
    else if (command.includes('cartão') || command.includes('crédito')) {
        if (AppState.creditCards.length === 0) {
            response = "Você não tem cartões de crédito cadastrados. Adicione cartões para análise.";
        } else {
            const totalLimit = AppState.creditCards.reduce((sum, card) => sum + card.limit, 0);
            const totalUsed = AppState.creditCards.reduce((sum, card) => sum + card.current, 0);
            const usagePercentage = (totalUsed / totalLimit * 100).toFixed(1);
            
            response = `Você tem ${AppState.creditCards.length} cartões com limite total de ${formatCurrency(totalLimit)}. `;
            response += `Está usando ${formatCurrency(totalUsed)} (${usagePercentage}%). `;
            
            if (usagePercentage > 80) {
                response += "CUIDADO: Uso muito elevado! Risco de endividamento.";
            } else if (usagePercentage > 50) {
                response += "Uso moderado, mas mantenha controle para não aumentar.";
            } else {
                response += "Uso saudável. Continue controlando seus gastos.";
            }
        }
    }
    else if (command.includes('meta') || command.includes('objetivo')) {
        if (AppState.goals.length === 0) {
            response = "Você não tem metas financeiras cadastradas. Crie metas para eu acompanhar seu progresso!";
        } else {
            response = `Você tem ${AppState.goals.length} metas ativas. `;
            
            const totalTarget = AppState.goals.reduce((sum, g) => sum + g.target, 0);
            const totalCurrent = AppState.goals.reduce((sum, g) => sum + g.current, 0);
            const totalProgress = (totalCurrent / totalTarget * 100).toFixed(1);
            
            response += `Progresso total: ${totalProgress}% (${formatCurrency(totalCurrent)} de ${formatCurrency(totalTarget)}). `;
            
            // Metas próximas de vencer
            const now = DateTime.now();
            const upcomingGoals = AppState.goals.filter(g => {
                const deadline = DateTime.fromISO(g.deadline);
                const daysRemaining = Math.ceil(deadline.diff(now, 'days').days);
                return daysRemaining > 0 && daysRemaining <= 30;
            });
            
            if (upcomingGoals.length > 0) {
                response += `${upcomingGoals.length} meta(s) vence(m) nos próximos 30 dias. `;
            }
        }
    }
    else if (command.includes('ajuda') || command.includes('comandos')) {
        response = "Posso ajudar com:\n";
        response += "• 'Quanto tenho de saldo?'\n";
        response += "• 'Quanto gastei este mês?'\n";
        response += "• 'Qual minha receita do mês?'\n";
        response += "• 'Como está minha economia?'\n";
        response += "• 'Qual categoria gasto mais?'\n";
        response += "• 'Como estão meus cartões?'\n";
        response += "• 'Como estão minhas metas?'\n";
        response += "• 'Sugira economia' (IA analisa e sugere)\n";
        response += "• 'Crie orçamento' (IA cria orçamento personalizado)";
    }
    else if (command.includes('sugira') || command.includes('economizar') || command.includes('dica')) {
        response = generateMoneySavingTip();
    }
    else if (command.includes('orçamento') && command.includes('criar')) {
        response = "Para criar um orçamento personalizado, vou analisar seus gastos dos últimos meses. ";
        response += "Com base nos seus padrões, sugiro:\n\n";
        
        const suggestions = generateBudgetSuggestions();
        response += suggestions;
    }
    else {
        response = "Entendi seu comando. Para uma resposta mais específica, tente perguntar sobre:\n";
        response += "• Seus saldos e contas\n";
        response += "• Gastos e receitas do mês\n";
        response += "• Cartões de crédito\n";
        response += "• Metas financeiras\n";
        response += "• Dicas para economizar\n";
        response += "• Criação de orçamento\n\n";
        response += "Ou diga 'ajuda' para ver todos os comandos disponíveis.";
    }
    
    // Adiciona resposta da IA
    addAIMessage(response, true);
    
    // Usa TTS se habilitado
    if (AppState.settings.ttsEnabled && 'speechSynthesis' in window) {
        speakText(response);
    }
}

function addAIMessage(message, isAI = true) {
    const aiChat = document.getElementById('ai-chat');
    if (!aiChat) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'ai-message';
    messageDiv.style.marginBottom = '15px';
    messageDiv.style.padding = '10px';
    messageDiv.style.background = isAI ? 'rgba(0, 212, 170, 0.1)' : 'var(--glass)';
    messageDiv.style.borderRadius = 'var(--radius-md)';
    messageDiv.style.border = `1px solid ${isAI ? 'rgba(0, 212, 170, 0.3)' : 'var(--border)'}`;
    
    messageDiv.innerHTML = `
        <div style="font-weight: 600; color: ${isAI ? 'var(--primary)' : 'var(--text-secondary)'}; margin-bottom: 5px;">
            ${isAI ? 'Assistente IA:' : 'Você:'}
        </div>
        <div style="white-space: pre-line;">${message}</div>
    `;
    
    aiChat.appendChild(messageDiv);
    
    // Scroll para baixo
    aiChat.scrollTop = aiChat.scrollHeight;
}

function speakText(text) {
    if (!('speechSynthesis' in window)) return;
    
    const speech = new SpeechSynthesisUtterance();
    speech.text = text;
    speech.lang = 'pt-BR';
    speech.rate = 1.0;
    speech.pitch = 1.0;
    speech.volume = 1.0;
    
    window.speechSynthesis.speak(speech);
}

function generateMoneySavingTip() {
    const tips = [
        "Analisei seus gastos. Recomendo fazer uma 'dieta financeira' por uma semana: anote cada centavo gasto. Você vai se surpreender com os pequenos gastos que somam!",
        "Sugiro revisar assinaturas recorrentes. Muitas pessoas pagam por serviços que não usam. Cancele pelo menos uma este mês.",
        "Tente o método 50-30-20: 50% da renda para necessidades, 30% para desejos, 20% para poupança. É uma regra de ouro!",
        "Antes de comprar algo, espere 24 horas. Muitas compras por impulso são evitadas com este simples hábito.",
        "Use a regra dos 10 segundos: antes de comprar algo não essencial, pergunte-se se realmente precisa. 90% das vezes a resposta é não.",
        "Compare preços online antes de comprar. Use aplicativos de cashback e cupons. Pequenas economias somam muito no final do ano!",
        "Faça uma lista de compras no supermercado e NUNCA vá com fome. Você economizará até 30% nas compras.",
        "Considere comprar produtos genéricos em vez de marcas famosas. A qualidade é similar e o preço bem menor.",
        "Desafio: tente um 'mês sem comer fora'. Cozinhar em casa é mais saudável e pode economizar centenas de reais.",
        "Revise seus planos de celular e internet. Muitas vezes você paga por mais dados do que realmente usa."
    ];
    
    // Escolhe uma dica aleatória
    return tips[Math.floor(Math.random() * tips.length)];
}

function generateBudgetSuggestions() {
    const monthStart = DateTime.now().startOf('month').toISODate();
    const monthEnd = DateTime.now().endOf('month').toISODate();
    
    const monthExpenses = AppState.transactions.filter(t => 
        t.type === 'expense' && t.date >= monthStart && t.date <= monthEnd
    );
    
    const categoryTotals = {};
    monthExpenses.forEach(t => {
        categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
    });
    
    const totalExpenses = monthExpenses.reduce((sum, t) => sum + t.amount, 0);
    
    let suggestions = "SUGESTÃO DE ORÇAMENTO DA IA:\n\n";
    
    // Para cada categoria com gastos, sugere um limite
    Object.entries(categoryTotals).forEach(([category, amount]) => {
        const percentage = totalExpenses > 0 ? (amount / totalExpenses * 100).toFixed(1) : 0;
        
        // Sugere redução se a categoria for muito dominante
        let suggestedLimit = amount;
        if (percentage > 40) {
            suggestedLimit = amount * 0.8; // Reduz 20%
            suggestions += `${category}: Atual ${formatCurrency(amount)} → Sugiro ${formatCurrency(suggestedLimit)} (redução de 20%)\n`;
        } else if (percentage > 25) {
            suggestedLimit = amount * 0.9; // Reduz 10%
            suggestions += `${category}: Atual ${formatCurrency(amount)} → Sugiro ${formatCurrency(suggestedLimit)} (redução de 10%)\n`;
        } else {
            suggestions += `${category}: Mantenha em ${formatCurrency(amount)} (bom controle)\n`;
        }
    });
    
    suggestions += "\nDICA EXTRA: Reserve 10% do orçamento para 'imprevistos'. Sempre surgem!";
    
    return suggestions;
}

// ========== UTILIDADES ==========
function formatCurrency(amount) {
    if (amount === undefined || amount === null) return 'R$ 0,00';
    
    const currency = AppState.settings.currency;
    const symbols = {
        'BRL': 'R$',
        'USD': '$',
        'EUR': '€',
        'GBP': '£'
    }

function escapeHtml(str){
    return String(str ?? '').replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}
;
    
    const symbol = symbols[currency] || currency;
    
    // Formatação para diferentes moedas
    const formatter = new Intl.NumberFormat(currency === 'BRL' ? 'pt-BR' : 'en-US', {
        style: 'currency',
        currency: currency,
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    
    return formatter.format(amount).replace(currency, symbol);
}

function formatDate(dateString) {
    if (!dateString) return '';
    
    const date = DateTime.fromISO(dateString);
    const today = DateTime.now().startOf('day');
    const yesterday = today.minus({days: 1});
    
    if (date.hasSame(today, 'day')) {
        return 'Hoje';
    } else if (date.hasSame(yesterday, 'day')) {
        return 'Ontem';
    } else if (date > today.minus({days: 7})) {
        return date.toFormat('cccc'); // Nome do dia da semana
    } else {
        return date.toFormat('dd/MM/yyyy');
    }
}

function showNotification(message, type = 'info') {
    // Cria notificação
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: ${type === 'success' ? 'var(--success)' : 
                     type === 'error' ? 'var(--danger)' : 
                     type === 'warning' ? 'var(--warning)' : 
                     'var(--info)'};
        color: white;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow);
        z-index: 10000;
        animation: fadeIn 0.3s ease;
        max-width: 350px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 10px;
    `;
    
    const icon = type === 'success' ? 'fa-check-circle' :
                 type === 'error' ? 'fa-exclamation-circle' :
                 type === 'warning' ? 'fa-exclamation-triangle' :
                 'fa-info-circle';
    
    notification.innerHTML = `
        <i class="fas ${icon}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    // Remove após 3 segundos
    setTimeout(() => {
        notification.style.animation = 'fadeIn 0.3s ease reverse';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// ========== EVENT LISTENERS ==========
// Tema
document.getElementById('theme-toggle')?.addEventListener('click', () => {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    AppState.settings.theme = newTheme;
    saveAppData();
    
    const icon = document.querySelector('#theme-toggle i');
    icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    
    showNotification(`Tema ${newTheme === 'dark' ? 'escuro' : 'claro'} ativado`, 'info');
});

// Notificações
document.getElementById('notification-btn')?.addEventListener('click', (e) => {
    e.stopPropagation();
});

// Botão adicionar transação
document.getElementById('add-transaction-btn')?.addEventListener('click', () => {
    openTransactionForm('expense');
});

// Enviar mensagem para IA
document.getElementById('ai-send')?.addEventListener('click', () => {
    const input = document.getElementById('ai-question');
    if (input.value.trim()) {
        processAICommand(input.value);
        input.value = '';
    }
});

// Tecla Enter no campo da IA
document.getElementById('ai-question')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('ai-send').click();
    }
});

// Análise profunda
document.getElementById('ai-analyze-deep')?.addEventListener('click', () => {
    generateDeepAnalysis();
});

// Sugerir orçamento
document.getElementById('ai-suggest-budget')?.addEventListener('click', () => {
    const suggestions = generateBudgetSuggestions();
    addAIMessage(suggestions, true);
});

// Previsão
document.getElementById('ai-forecast')?.addEventListener('click', () => {
    generateForecast();
});

// ========== INICIALIZAÇÃO FINAL ==========
// Verifica se há bloqueio por senha
if (localStorage.getItem('app_lock')) {
    const password = prompt('Digite a senha para acessar o aplicativo:');
    if (btoa(password) !== localStorage.getItem('app_lock')) {
        alert('Senha incorreta!');
        window.close();
    }
}

// Fecha menus ao clicar fora
document.addEventListener('click', (e) => {
    // Fecha dropdowns
    if (!e.target.closest('.dropdown')) {
        document.querySelectorAll('.dropdown-content').forEach(dropdown => {
            dropdown.style.display = 'none';
        });
    }
    
    // Fecha menu lateral se clicar fora (apenas no mobile)
    if (window.innerWidth < 768 && 
        !e.target.closest('.side-menu') && 
        !e.target.closest('.menu-toggle')) {
        document.getElementById('side-menu')?.classList.remove('active');
    }
});

// Fecha menu ao pressionar ESC
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        document.querySelectorAll('.form-overlay.active').forEach(overlay => {
            overlay.classList.remove('active');
        });
        
        document.getElementById('side-menu')?.classList.remove('active');
    }
});

// Sistema 100% funcional e pronto para uso!
console.log('🎉 Sistema Finanças IA Pro Premium totalmente carregado e funcional!');
console.log('✨ Recursos Premium/Básico implementados');
console.log('🤖 IA Avançada com análise inteligente');
console.log('📊 Dashboard com gráficos e insights');
console.log('💾 Sistema de persistência de dados local');
console.log('🎨 Interface moderna com tema claro/escuro');
console.log('🎤 Controle por voz integrado');
console.log('🔔 Sistema de notificações inteligentes');

// Exporta funções para uso no console (para debug)
window.AppState = AppState;
window.saveAppData = saveAppData;
window.loadSection = loadSection;
window.openTransactionForm = openTransactionForm;
window.openAIPanel = openAIPanel;
window.toggleAccountType = toggleAccountType;


/* ================= FIX: SETTINGS SHEET + BACKUP/EXPORT + REPORTS + ACCOUNTS + LOCK ================= */
(function(){
  // ---------- Bottom sheet (used by Configurações / Relatórios etc.)
  function openSettingsSheet(title, innerHtml){
    closeSettingsSheet();
    const overlay = document.createElement('div');
    overlay.id = 'settings-sheet-overlay';
    overlay.innerHTML = `
      <div class="settings-sheet" role="dialog" aria-modal="true">
        <div class="settings-sheet-header">
          <div class="settings-sheet-title">${title}</div>
          <button class="settings-sheet-close" type="button" onclick="closeSettingsSheet()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="settings-sheet-body">${innerHtml}</div>
      </div>
    `;
    overlay.addEventListener('click', (e)=>{ if(e.target && e.target.id === 'settings-sheet-overlay') closeSettingsSheet(); });
    document.addEventListener('keydown', escCloseSettingsSheet);
    document.body.appendChild(overlay);
    document.body.style.overflow = 'hidden';
  }

  function escCloseSettingsSheet(e){ if(e.key === 'Escape') closeSettingsSheet(); }

  
function safeDestroyChart(key){
  try{
    window.__charts = window.__charts || {};
    const c = window.__charts[key];
    if (c && typeof c.destroy === "function") c.destroy();
    window.__charts[key] = null;
  }catch(e){}
}
function closeSettingsSheet(){
    const existing = document.getElementById('settings-sheet-overlay');
    if(existing) existing.remove();
    document.body.style.overflow = '';
    document.removeEventListener('keydown', escCloseSettingsSheet);
  }

  // Make globally available (Configurações already calls these)
  window.openSettingsSheet = openSettingsSheet;
  window.closeSettingsSheet = closeSettingsSheet;

  // ---------- Helpers
  function ensureSettings(){
    AppState.settings = AppState.settings || {};
    if(!AppState.settings.theme) AppState.settings.theme = document.documentElement.getAttribute('data-theme') || 'dark';
    if(typeof AppState.settings.notifications !== 'boolean') AppState.settings.notifications = true;
    if(!AppState.settings.currency) AppState.settings.currency = 'USD';
    if(!AppState.settings.accountType) fp_applyUserPlanToAppState();
  }

  function safeNumber(v, fallback=0){
    const n = typeof v === 'number' ? v : parseFloat(String(v).replace(',', '.'));
    return Number.isFinite(n) ? n : fallback;
  }

  // Keep main Settings screen toggles in sync (if open)
  window.syncSettingsToggles = function(){
    try{
      ensureSettings();
      const mainNoti = document.getElementById('notifications-toggle');
      if(mainNoti) mainNoti.checked = !!AppState.settings.notifications;
    }catch(e){}
  };

  // ---------- Notifications
  window.toggleNotifications = function(enabled){
    ensureSettings();
    AppState.settings.notifications = !!enabled;
    saveAppData();
    if(enabled && ('Notification' in window)){
      try{
        if(Notification.permission === 'default'){
          Notification.requestPermission().catch(()=>{});
        }
      }catch(e){}
    }
  };

  // ---------- Backup / Restore
  window.importAllDataFromFile = function(event){
    const file = event && event.target && event.target.files && event.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(reader.result);
        if(!parsed || typeof parsed !== 'object') throw new Error('Arquivo inválido');
        // minimal validation + defaults
        const next = Object.assign({}, AppState, parsed);
        next.accounts = Array.isArray(next.accounts) ? next.accounts : [];
        next.transactions = Array.isArray(next.transactions) ? next.transactions : [];
        next.budgets = Array.isArray(next.budgets) ? next.budgets : [];
        next.creditCards = Array.isArray(next.creditCards) ? next.creditCards : [];
        next.categories = next.categories || AppState.categories || {};
        next.settings = Object.assign({}, AppState.settings || {}, parsed.settings || {});
        AppState = next;
        ensureSettings();
        saveAppData();
        document.documentElement.setAttribute('data-theme', AppState.settings.theme || 'dark');
        updateAccountTypeUI && updateAccountTypeUI();
        // reload current section if possible
        try{ if(AppState.currentSection) loadSection(AppState.currentSection); }catch(e){}
        showNotification('Backup importado com sucesso', 'success');
        closeSettingsSheet();
      }catch(err){
        console.error(err);
        showNotification('Falha ao importar backup (JSON inválido)', 'error');
      }finally{
        try{ event.target.value=''; }catch(e){}
      }
    };
    reader.readAsText(file);
  };

  // ---------- CSV Exports
  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }

  window.exportTransactionsCSV = function(){
    const rows = [];
    rows.push(['Data','Tipo','Valor','Categoria','Subcategoria','Descrição','Conta'].join(','));
    const accountsById = {};
    (AppState.accounts||[]).forEach(a=>accountsById[a.id]=a);
    (AppState.transactions||[]).forEach(t=>{
      const acc = accountsById[t.accountId] ? accountsById[t.accountId].name : '';
      const cols = [
        t.date || '',
        t.type || '',
        safeNumber(t.amount,0).toFixed(2),
        (t.category||'').replaceAll(',',' '),
        (t.subcategory||'').replaceAll(',',' '),
        (t.description||'').replaceAll(',',' '),
        acc.replaceAll(',',' ')
      ];
      rows.push(cols.join(','));
    });
    downloadBlob(new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8'}), `transacoes_${DateTime.now().toFormat('yyyy-MM-dd')}.csv`);
    showNotification('CSV de transações exportado', 'success');
  };

  window.exportBudgetsCSV = function(){
    const rows = [];
    rows.push(['Categoria','Limite','Período'].join(','));
    (AppState.budgets||[]).forEach(b=>{
      rows.push([
        (b.category||'').replaceAll(',',' '),
        safeNumber(b.limit,0).toFixed(2),
        (b.period||'mensal').replaceAll(',',' ')
      ].join(','));
    });
    downloadBlob(new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8'}), `orcamentos_${DateTime.now().toFormat('yyyy-MM-dd')}.csv`);
    showNotification('CSV de orçamentos exportado', 'success');
  };

  window.exportAccountsCSV = function(){
    const rows = [];
    rows.push(['Conta','Banco','Tipo','Saldo'].join(','));
    (AppState.accounts||[]).forEach(a=>{
      rows.push([
        (a.name||'').replaceAll(',',' '),
        (a.bank||'').replaceAll(',',' '),
        (a.type||'').replaceAll(',',' '),
        safeNumber(a.balance,0).toFixed(2)
      ].join(','));
    });
    downloadBlob(new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8'}), `contas_${DateTime.now().toFormat('yyyy-MM-dd')}.csv`);
    showNotification('CSV de contas exportado', 'success');
  };

  // ---------- Accounts CRUD (Contas Bancárias)
  function getNextId(list){
    const max = (list||[]).reduce((m,x)=>Math.max(m, safeNumber(x.id,0)), 0);
    return max + 1;
  }

  window.openAccountForm = function(accountId){
    ensureSettings();
    const editing = !!accountId;
    const acc = editing ? (AppState.accounts||[]).find(a=>a.id===accountId) : null;
    const init = acc || {name:'', bank:'', type:'checking', balance:0, manual:true, color:'#00D4AA'};
    openSettingsSheet(editing ? 'Editar Conta' : 'Adicionar Conta', `
      <div class="sheet-section">
        <div class="form-group">
          <label class="form-label">Nome da Conta</label>
          <input class="form-input" id="acc-name" placeholder="Ex: Banco Inter" value="${(init.name||'').replaceAll('"','&quot;')}">
        </div>
        <div class="form-group">
          <label class="form-label">Instituição / Banco</label>
          <input class="form-input" id="acc-bank" placeholder="Ex: Banco Inter S.A." value="${(init.bank||'').replaceAll('"','&quot;')}">
        </div>
        <div class="form-group">
          <label class="form-label">Tipo</label>
          <select class="form-select" id="acc-type">
            <option value="checking" ${init.type==='checking'?'selected':''}>Conta Corrente</option>
            <option value="savings" ${init.type==='savings'?'selected':''}>Poupança</option>
            <option value="investment" ${init.type==='investment'?'selected':''}>Investimento</option>
            <option value="cash" ${init.type==='cash'?'selected':''}>Dinheiro (Cash)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Saldo</label>
          <input class="form-input" id="acc-balance" inputmode="decimal" placeholder="0.00" value="${safeNumber(init.balance,0)}">
        </div>
        <div class="form-group">
          <label class="form-label">Cor do Ícone</label>
          <input class="form-input" id="acc-color" type="color" value="${init.color || '#00D4AA'}" style="height:46px; padding:6px;">
        </div>

        <div class="form-row" style="gap:10px;">
          ${editing ? `<button class="btn btn-danger" style="flex:1;" onclick="deleteAccount(${accountId})"><i class="fas fa-trash"></i> Excluir</button>` : ``}
          <button class="btn btn-primary" style="flex:1;" onclick="saveAccountFromSheet(${editing?accountId:'null'})"><i class="fas fa-save"></i> Salvar</button>
        </div>
      </div>
    `);
  };

  window.saveAccountFromSheet = function(accountId){
    const name = (document.getElementById('acc-name')||{}).value || '';
    const bank = (document.getElementById('acc-bank')||{}).value || '';
    const type = (document.getElementById('acc-type')||{}).value || 'checking';
    const balance = safeNumber((document.getElementById('acc-balance')||{}).value, 0);
    const color = (document.getElementById('acc-color')||{}).value || '#00D4AA';
    if(!name.trim()){ showNotification('Informe o nome da conta', 'error'); return; }
    if(!bank.trim()){ showNotification('Informe o banco/instituição', 'error'); return; }

    const list = AppState.accounts || (AppState.accounts=[]);
    if(accountId){
      const idx = list.findIndex(a=>a.id===accountId);
      if(idx>=0){
        list[idx] = Object.assign({}, list[idx], {name:name.trim(), bank:bank.trim(), type, balance, color, manual:true});
      }
    }else{
      list.push({id:getNextId(list), name:name.trim(), bank:bank.trim(), type, balance, color, manual:true});
    }
    saveAppData();
    try{ loadAccounts(); }catch(e){}
    showNotification('Conta salva com sucesso', 'success');
    closeSettingsSheet();
  };

  window.deleteAccount = function(accountId){
    const list = AppState.accounts || [];
    const acc = list.find(a=>a.id===accountId);
    if(!acc) return;
    if(!confirm(`Excluir a conta "${acc.name}"?\nTransações serão movidas para Dinheiro (Cash).`)) return;

    const cash = (list.find(a=>a.type==='cash') || list[0] || null);
    const fallbackId = cash ? cash.id : null;

    (AppState.transactions||[]).forEach(t=>{
      if(t.accountId === accountId){
        t.accountId = fallbackId;
      }
    });

    AppState.accounts = list.filter(a=>a.id!==accountId);
    saveAppData();
    try{ loadAccounts(); }catch(e){}
    showNotification('Conta excluída', 'success');
    closeSettingsSheet();
  };

  window.viewAccountDetails = function(accountId){
    const acc = (AppState.accounts||[]).find(a=>a.id===accountId);
    if(!acc){ showNotification('Conta não encontrada', 'error'); return; }
    const tx = (AppState.transactions||[]).filter(t=>t.accountId===accountId).slice().sort((a,b)=>String(b.date).localeCompare(String(a.date))).slice(0,10);
    const txHtml = tx.length ? tx.map(t=>`
      <div class="sheet-row" style="align-items:flex-start;">
        <div style="flex:1;">
          <div style="font-weight:600;">${t.category || 'Sem categoria'} <span style="opacity:.7;">• ${t.date||''}</span></div>
          <div style="font-size:12px; color: var(--text-tertiary);">${(t.description||'').slice(0,60)}</div>
        </div>
        <div style="font-weight:700; white-space:nowrap;">${(t.type==='expense' ? '-' : '+')}${formatCurrency(safeNumber(t.amount,0))}</div>
      </div>
    `).join('') : `<div style="color:var(--text-tertiary); font-size:13px;">Nenhuma transação nesta conta.</div>`;

    openSettingsSheet('Detalhes da Conta', `
      <div class="sheet-section">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
          <div class="account-icon" style="width:42px; height:42px; border-radius:14px; display:flex; align-items:center; justify-content:center; background:${acc.color||'var(--glass)'};">
            <i class="fas ${getAccountIcon(acc.type)}"></i>
          </div>
          <div style="flex:1;">
            <div style="font-weight:800;">${acc.name}</div>
            <div style="font-size:12px; color: var(--text-tertiary);">${acc.bank} ${acc.manual ? '• Manual' : ''}</div>
          </div>
          <div style="font-weight:900;">${formatCurrency(safeNumber(acc.balance,0))}</div>
        </div>

        <div class="form-row" style="gap:10px;">
          <button class="btn btn-secondary" style="flex:1;" onclick="openAccountForm(${acc.id})"><i class="fas fa-edit"></i> Editar</button>
          <button class="btn btn-danger" style="flex:1;" onclick="deleteAccount(${acc.id})"><i class="fas fa-trash"></i> Excluir</button>
        </div>

        <h4 style="margin:16px 0 10px 0;">Últimas transações</h4>
        ${txHtml}
      </div>
    `);
  };

  // Override accounts list to include long-press/edit buttons without breaking UI
  const _origLoadAccounts = window.loadAccounts;
  window.loadAccounts = function(){
    const container = document.getElementById('accounts-list');
    if(!container) return _origLoadAccounts ? _origLoadAccounts() : undefined;

    const nonCash = (AppState.accounts||[]).filter(a=>a.type!=='cash');
    if(nonCash.length===0){
      container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-university"></i>
          <div>Nenhuma conta bancária adicionada</div>
        </div>`;
      return;
    }
    container.innerHTML = nonCash.map(a=>`
      <div class="account-card" data-id="${a.id}">
        <div class="account-info" onclick="viewAccountDetails(${a.id})">
          <div class="account-icon" style="background:${a.color || 'var(--glass)'}">
            <i class="fas ${getAccountIcon(a.type)}"></i>
          </div>
          <div class="account-details">
            <h3>${a.name}</h3>
            <p>${a.bank} ${a.manual ? '• Manual' : ''}</p>
          </div>
        </div>
        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px;">
          <div class="account-balance">${formatCurrency(safeNumber(a.balance,0))}</div>
          <div style="display:flex; gap:8px;">
            <button class="icon-btn" type="button" onclick="event.stopPropagation(); openAccountForm(${a.id})" title="Editar"><i class="fas fa-pen"></i></button>
            <button class="icon-btn" type="button" onclick="event.stopPropagation(); deleteAccount(${a.id})" title="Excluir"><i class="fas fa-trash"></i></button>
          </div>
        </div>
      </div>
    `).join('');
  };

  // ---------- Reports (REAL)
  function txInRange(startISO, endISO){
    const s = DateTime.fromISO(startISO).startOf('day');
    const e = DateTime.fromISO(endISO).endOf('day');
    return (AppState.transactions||[]).filter(t=>{
      if(!t.date) return false;
      const d = DateTime.fromISO(t.date);
      return d.isValid && d >= s && d <= e;
    });
  }

  function sumByType(tx, type){
    return tx.filter(t=>t.type===type).reduce((s,t)=>s+safeNumber(t.amount,0), 0);
  }

  function groupExpensesByCategory(tx){
    const map = {};
    tx.filter(t=>t.type==='expense').forEach(t=>{
      const k = t.category || 'Outros';
      map[k] = (map[k]||0) + safeNumber(t.amount,0);
    });
    const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]);
    return entries;
  }

  function renderChart(canvasId, cfg){
    setTimeout(()=>{
      const el = document.getElementById(canvasId);
      if(!el) return;
      // destroy if exists
      if(el._chart){ try{ el._chart.destroy(); }catch(e){} }
      const chart = new Chart(el.getContext('2d'), cfg);
      el._chart = chart;
    }, 50);
  }

  window.generateMonthlyReport = function(){
    const now = DateTime.now();
    const start = now.startOf('month').toISODate();
    const end = now.endOf('month').toISODate();
    const tx = txInRange(start,end);
    const income = sumByType(tx,'income');
    const expense = sumByType(tx,'expense');
    const net = income - expense;
    const top = groupExpensesByCategory(tx).slice(0,6);
    const canvasId = 'rep-monthly-cat';
    openSettingsSheet('Relatório Mensal', `
      <div class="sheet-section">
        <div class="kpi-grid" style="margin-bottom:14px;">
          <div class="kpi-card"><div class="kpi-label">Receitas</div><div class="kpi-value">${formatCurrency(income)}</div></div>
          <div class="kpi-card"><div class="kpi-label">Despesas</div><div class="kpi-value">${formatCurrency(expense)}</div></div>
          <div class="kpi-card"><div class="kpi-label">Saldo</div><div class="kpi-value">${formatCurrency(net)}</div></div>
        </div>

        <div style="font-weight:700; margin:10px 0 6px 0;">Top despesas por categoria</div>
        <canvas id="${canvasId}" ></canvas>

        <div class="form-row" style="gap:10px; margin-top:12px;">
          <button class="btn btn-secondary" style="flex:1;" onclick="printCurrentReport('Relatório Mensal', '${start}', '${end}')"><i class="fas fa-print"></i> Imprimir/PDF</button>
          <button class="btn btn-primary" style="flex:1;" onclick="closeSettingsSheet()"><i class="fas fa-check"></i> OK</button>
        </div>
      </div>
    `);

    renderChart(canvasId, {
      type:'doughnut',
      data:{
        labels: top.map(x=>x[0]),
        datasets:[{ data: top.map(x=>x[1]) }]
      },
      options:{ responsive:true, maintainAspectRatio: true, plugins:{ legend:{ position:'bottom' } } }
    });
  };

  window.generateCategoryReport = function(){
    const now = DateTime.now();
    const start = now.startOf('month').toISODate();
    const end = now.endOf('month').toISODate();
    const tx = txInRange(start,end);
    const entries = groupExpensesByCategory(tx);
    const canvasId = 'rep-cat';
    openSettingsSheet('Relatório por Categoria', `
      <div class="sheet-section">
        <div style="color:var(--text-tertiary); font-size:12px; margin-bottom:8px;">Período: ${start} → ${end}</div>
        <canvas id="${canvasId}" ></canvas>
        <div style="margin-top:12px;">
          ${entries.slice(0,10).map(([k,v])=>`
            <div class="sheet-row">
              <div style="font-weight:600;">${k}</div>
              <div style="font-weight:800;">${formatCurrency(v)}</div>
            </div>
          `).join('') || `<div style="color:var(--text-tertiary);">Sem despesas no período.</div>`}
        </div>
        <div class="form-row" style="gap:10px; margin-top:12px;">
          <button class="btn btn-secondary" style="flex:1;" onclick="printCurrentReport('Relatório por Categoria', '${start}', '${end}')"><i class="fas fa-print"></i> Imprimir/PDF</button>
          <button class="btn btn-primary" style="flex:1;" onclick="closeSettingsSheet()"><i class="fas fa-check"></i> OK</button>
        </div>
      </div>
    `);

    renderChart(canvasId, {
      type:'bar',
      data:{ labels: entries.slice(0,8).map(x=>x[0]), datasets:[{ data: entries.slice(0,8).map(x=>x[1]) }] },
      options:{ responsive:true, maintainAspectRatio: true, plugins:{ legend:{ display:false } } }
    });
  };

  window.generateAnnualReport = function(){
    const now = DateTime.now();
    const months = [];
    const income = [];
    const expense = [];
    for(let i=11;i>=0;i--){
      const m = now.minus({months:i});
      const s = m.startOf('month').toISODate();
      const e = m.endOf('month').toISODate();
      const tx = txInRange(s,e);
      months.push(m.toFormat('MMM/yy'));
      income.push(sumByType(tx,'income'));
      expense.push(sumByType(tx,'expense'));
    }
    const canvasId='rep-annual';
    openSettingsSheet('Relatório Anual', `
      <div class="sheet-section">
        <canvas id="${canvasId}" ></canvas>
        <div style="color:var(--text-tertiary); font-size:12px; margin-top:10px;">Receitas vs Despesas (últimos 12 meses)</div>
        <div class="form-row" style="gap:10px; margin-top:12px;">
          <button class="btn btn-secondary" style="flex:1;" onclick="printCurrentReport('Relatório Anual', '', '')"><i class="fas fa-print"></i> Imprimir/PDF</button>
          <button class="btn btn-primary" style="flex:1;" onclick="closeSettingsSheet()"><i class="fas fa-check"></i> OK</button>
        </div>
      </div>
    `);

    renderChart(canvasId,{
      type:'line',
      data:{ labels:months, datasets:[{label:'Receitas', data:income, tension:.35},{label:'Despesas', data:expense, tension:.35}] },
      options:{ responsive:true, maintainAspectRatio: true, plugins:{ legend:{ position:'bottom' } } }
    });
  };

  window.previewReport = function(){ generateMonthlyReport(); };
  window.generateExport = function(){ showExportSettings(); };

  window.generateCustomReport = function(){
    const startEl = document.getElementById('report-start');
    const endEl = document.getElementById('report-end');
    const typeEl = document.getElementById('report-type');
    const start = startEl ? startEl.value : DateTime.now().startOf('month').toISODate();
    const end = endEl ? endEl.value : DateTime.now().endOf('month').toISODate();
    const type = typeEl ? typeEl.value : 'complete';
    const tx = txInRange(start,end);
    const inc = sumByType(tx,'income');
    const exp = sumByType(tx,'expense');
    const net = inc-exp;

    if(type === 'category'){ return generateCategoryReport(); }
    if(type === 'income-expense'){ return generateMonthlyReport(); }

    openSettingsSheet('Relatório Personalizado', `
      <div class="sheet-section">
        <div style="color:var(--text-tertiary); font-size:12px; margin-bottom:8px;">Período: ${start} → ${end}</div>
        <div class="kpi-grid" style="margin-bottom:14px;">
          <div class="kpi-card"><div class="kpi-label">Receitas</div><div class="kpi-value">${formatCurrency(inc)}</div></div>
          <div class="kpi-card"><div class="kpi-label">Despesas</div><div class="kpi-value">${formatCurrency(exp)}</div></div>
          <div class="kpi-card"><div class="kpi-label">Saldo</div><div class="kpi-value">${formatCurrency(net)}</div></div>
        </div>
        <div style="font-weight:700; margin:10px 0 6px 0;">Resumo</div>
        <div style="color:var(--text-secondary); font-size:13px;">Transações no período: <b>${tx.length}</b></div>
        <div class="form-row" style="gap:10px; margin-top:12px;">
          <button class="btn btn-secondary" style="flex:1;" onclick="printCurrentReport('Relatório Personalizado', '${start}', '${end}')"><i class="fas fa-print"></i> Imprimir/PDF</button>
          <button class="btn btn-primary" style="flex:1;" onclick="closeSettingsSheet()"><i class="fas fa-check"></i> OK</button>
        </div>
      </div>
    `);
  };

  window.printCurrentReport = function(title, start, end){
    // Simple printable HTML (works offline). 
    const w = window.open('', '_blank');
    if(!w){ showNotification('Popup bloqueado. Permita popups para imprimir.', 'error'); return; }
    w.document.write(`
      <html><head><title>${title}</title>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <style>
        body{ font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial; padding:24px; }
        h1{ margin:0 0 8px 0; }
        .muted{ color:#666; margin-bottom:16px; }
        .grid{ display:flex; gap:12px; flex-wrap:wrap; margin-bottom:16px; }
        .card{ border:1px solid #ddd; border-radius:12px; padding:12px 14px; min-width:180px; }
        .label{ font-size:12px; color:#666; }
        .value{ font-size:20px; font-weight:800; margin-top:4px; }
      
/* ===== K-DEV RESPONSIVE PREMIUM CHART PATCH ===== */
.chart-wrapper {
  height: auto !important;
  min-height: 180px;
  max-height: 320px;
}
.chart-wrapper canvas {
  width: 100% !important;
  height: auto !important;
  max-height: 320px !important;
}
/* ===== END PATCH ===== */

</style></head><body>
      <h1>${title}</h1>
      ${start && end ? `<div class="muted">Período: ${start} → ${end}</div>` : ``}
      <div class="muted">Gerado em: ${DateTime.now().toFormat('yyyy-MM-dd HH:mm')}</div>
      <p>Use o menu do navegador para <b>Imprimir</b> e salvar como PDF.</p>
      </body></html>
    `);
    w.document.close();
    w.focus();
    setTimeout(()=>{ try{ w.print(); }catch(e){} }, 300);
  };

  // ---------- App Lock: enforce on startup + allow change
  function enforceAppLock(){
    const enc = localStorage.getItem('app_lock');
    if(!enc) return;
    let ok = false;
    for(let attempt=0; attempt<3; attempt++){
      const p = prompt('🔒 App bloqueado. Digite sua senha:');
      if(p === null) break;
      try{
        if(btoa(p) === enc){ ok = true; break; }
      }catch(e){}
      alert('Senha incorreta.');
    }
    if(!ok){
      document.body.innerHTML = `
        <div style="min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px; text-align:center; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto;">
          <div>
            <div style="font-size:34px; margin-bottom:10px;">🔒</div>
            <div style="font-size:18px; font-weight:800; margin-bottom:6px;">Aplicativo bloqueado</div>
            <div style="opacity:.75; margin-bottom:14px;">Recarregue a página para tentar novamente.</div>
          </div>
        </div>`;
      throw new Error('locked');
    }
  }

  // Patch setupAppLock to also allow remove/change
  const _origSetup = window.setupAppLock;
  window.setupAppLock = function(){
    const current = localStorage.getItem('app_lock');
    if(current){
      const action = prompt('Bloqueio já configurado.\nDigite:\n1 = Trocar senha\n2 = Remover bloqueio\n(ou Cancelar)');
      if(action === '2'){
        localStorage.removeItem('app_lock');
        showNotification('Bloqueio removido', 'success');
        return;
      }
      if(action !== '1') return;
    }
    const password = prompt('Digite uma senha para bloquear o aplicativo:');
    if(password){
      try{ localStorage.setItem('app_lock', btoa(password)); }catch(e){}
      showNotification('Bloqueio por senha configurado com sucesso', 'success');
    }
  };

  // Run lock check ASAP when DOM is ready (but before heavy init)
  document.addEventListener('DOMContentLoaded', ()=>{
    try{ enforceAppLock(); }catch(e){}
  }, {once:true});

})();

</script>
</body>
</html>


<script>document.addEventListener('DOMContentLoaded', ()=>{ fp_applyUserPlanToAppState(); if (typeof updateAccountTypeUI==='function') updateAccountTypeUI(); });</script>
