<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <meta name="theme-color" content="#0b8fa3"/>
  <title>K‚ÄëGenda ‚Ä¢ Assistente Pessoal com IA</title>
  <style>
    :root{
      --teal:#0aa6bf;
      --teal2:#0b8fa3;
      --bg:#f3f6f7;
      --card:#ffffff;
      --muted:#6b7a86;
      --text:#152029;
      --line:#e6edf1;
      --good:#2bb673;
      --warn:#ffb000;
      --bad:#ff3b30;
      --ai-purple:#8a2be2;
      --ai-blue:#4169e1;
      --shadow:0 14px 40px rgba(0,0,0,.10);
      --r:14px;
      --r2:18px;
      --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--font);
      background:linear-gradient(180deg,#eef6f7 0%, var(--bg) 38%, #eef3f4 100%);
      color:var(--text);
    }
    a{color:inherit}
    .app{min-height:100%; display:flex; flex-direction:column}
    .topbar{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(90deg,var(--teal2),var(--teal));
      color:#fff;
      padding:10px 12px;
      box-shadow:0 10px 26px rgba(0,0,0,.16);
    }
    .topbarRow{display:flex; align-items:center; gap:10px}
    .brand{display:flex; align-items:center; gap:10px; min-width:0}
    .logo{
      width:34px;height:34px;border-radius:10px;
      background:rgba(255,255,255,.18);
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.28);
      box-shadow:inset 0 0 0 1px rgba(0,0,0,.06);
      font-weight:900;
    }
    .titleWrap{min-width:0}
    .title{font-weight:900; letter-spacing:.2px; line-height:1}
    .subtitle{opacity:.92; font-size:12px; line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .topActions{margin-left:auto; display:flex; align-items:center; gap:10px; position:relative}
    .pill{
      border:1px solid rgba(255,255,255,.25);
      background:rgba(0,0,0,.08);
      padding:6px 10px; border-radius:999px;
      font-weight:800; font-size:12px;
      cursor:pointer;
    }
    .profileBtn{
      width:34px;height:34px;border-radius:999px;
      border:1px solid rgba(255,255,255,.30);
      background:rgba(255,255,255,.16);
      display:grid; place-items:center;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .menu{
      position:absolute; right:0; top:44px;
      background:#fff; color:var(--text);
      border-radius:14px; box-shadow:var(--shadow);
      border:1px solid var(--line);
      width:min(280px, calc(100vw - 24px));
      overflow:hidden;
      display:none;
      z-index:99;
    }
    .menu.open{display:block}
    .menu .mi{padding:12px 14px; display:flex; gap:10px; align-items:center; cursor:pointer}
    .menu .mi:hover{background:#f6fbfc}
    .menu .sep{height:1px;background:var(--line)}
    .mi small{color:var(--muted)}
    .tabs{
      display:flex;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.18);
      margin-top:10px;
      border-radius:14px;
      overflow:hidden;
    }
    .tab{
      flex:1;
      padding:10px 6px;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:6px;
      color:rgba(255,255,255,.92);
      opacity:.92;
      border-right:1px solid rgba(255,255,255,.16);
      cursor:pointer;
      user-select:none;
    }
    .tab:last-child{border-right:none}
    .tab.active{background:rgba(0,0,0,.18); opacity:1}
    .ic{width:22px;height:22px; display:block; filter:drop-shadow(0 2px 2px rgba(0,0,0,.12))}
    .tab span{font-size:12px; font-weight:900}
    main{flex:1; padding:14px 12px 94px}
    .page{display:none}
    .page.active{display:block}
    h1{margin:10px 0 12px; font-size:34px; letter-spacing:.2px; color:#66757f; font-weight:900}
    h2{margin:16px 0 10px; font-size:16px; color:#2b3b45}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r2);
      box-shadow:0 10px 26px rgba(0,0,0,.07);
      overflow:hidden;
    }
    .cardPad{padding:14px}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .col{flex:1; min-width:180px}
    label{display:block; font-size:12px; font-weight:900; color:#7b8a96; margin:12px 0 6px}
    .input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid #dbe6ec;
      background:#fff;
      font-size:16px;
      outline:none;
    }
    textarea{min-height:88px; resize:vertical}
    .input:focus, select:focus, textarea:focus{border-color:rgba(10,166,191,.55); box-shadow:0 0 0 4px rgba(10,166,191,.12)}
    .seg{display:flex; border:1px solid #dbe6ec; border-radius:12px; overflow:hidden; background:#fff}
    .seg button{flex:1; padding:10px 8px; border:none; background:transparent; cursor:pointer; font-weight:900; color:#5a6a76}
    .seg button.active{background:rgba(10,166,191,.16); color:#0b6c7a}
    .hint{
      margin-top:10px;
      border:1px solid rgba(10,166,191,.25);
      background:rgba(10,166,191,.08);
      border-radius:12px;
      padding:10px 12px;
      color:#2e6670;
      font-size:13px;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 14px; border-radius:14px;
      border:1px solid rgba(0,0,0,.08);
      background:#0d8ea2;
      color:#fff; font-weight:900;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(13,142,162,.22);
      text-decoration:none;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#ffffff; color:#0b6c7a; border-color:#cfe3ea; box-shadow:none}
    .btn.good{background:var(--good); box-shadow:0 10px 22px rgba(43,182,115,.20)}
    .btn.warn{background:var(--warn); box-shadow:0 10px 22px rgba(255,176,0,.20)}
    .btn.bad{background:var(--bad); box-shadow:0 10px 22px rgba(255,59,48,.18)}
    .btn.ai{background:linear-gradient(90deg, var(--ai-blue), var(--ai-purple)); box-shadow:0 10px 22px rgba(138,43,226,.20)}
    .btn.small{padding:9px 10px; border-radius:12px; font-size:13px}
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    .list{display:flex; flex-direction:column}
    .item{display:flex; gap:10px; align-items:flex-start; padding:12px 14px; border-top:1px solid var(--line)}
    .item:first-child{border-top:none}
    .tag{
      display:inline-flex; align-items:center; justify-content:center;
      padding:4px 8px; border-radius:999px;
      font-size:12px; font-weight:900;
      background:#eef7f9; color:#0b6c7a; border:1px solid #d4eef3;
      white-space:nowrap;
    }
    .tag.ai{background:#f0e8ff; color:var(--ai-purple); border-color:#e0d0ff}
    .muted{color:var(--muted)}
    .split{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .spacer{flex:1}
    .kpi{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    .kpi .k{padding:12px; border-radius:16px; border:1px solid var(--line); background:#fff}
    .k .n{font-weight:900; font-size:18px}
    .k .t{color:var(--muted); font-size:12px; font-weight:900}

    /* Profile Selector */
    .authWrap{
      position:fixed; inset:0;
      background:linear-gradient(135deg, #eef6f7 0%, #e0f0f5 100%);
      display:flex; align-items:center; justify-content:center;
      padding:20px;
      z-index:1000;
    }
    .authCard{
      background:#fff;
      border-radius:20px;
      box-shadow:0 20px 60px rgba(0,0,0,.15);
      border:1px solid var(--line);
      max-width:500px;
      width:100%;
      overflow:hidden;
    }
    .authHead{
      background:linear-gradient(90deg, var(--teal), var(--teal2));
      color:#fff;
      padding:24px 20px;
      text-align:center;
    }
    .authHead .big{
      font-size:32px; font-weight:900; margin-bottom:8px;
    }
    .authHead .sm{
      font-size:14px; opacity:.9;
    }
    .authBody{
      padding:24px;
    }
    .profiles{
      display:flex; flex-direction:column; gap:12px;
      margin:16px 0;
    }
    .profile-card{
      background:#fff;
      border-radius:14px;
      padding:16px;
      border:2px solid transparent;
      cursor:pointer;
      transition:all 0.2s;
      display:flex; align-items:center; gap:12px;
    }
    .profile-card:hover{
      border-color:var(--teal);
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(11,143,163,.12);
    }
    .profile-card.active{
      border-color:var(--teal);
      background:#f0f9fb;
    }
    .profile-icon{
      width:48px; height:48px;
      border-radius:50%;
      background:linear-gradient(135deg, var(--teal), var(--teal2));
      color:white;
      display:grid; place-items:center;
      font-weight:900; font-size:18px;
    }
    .profile-info{flex:1}
    .profile-name{font-weight:900; font-size:16px}
    .profile-email{font-size:13px; color:var(--muted)}
    .profile-stats{
      font-size:12px; color:var(--muted); margin-top:4px;
      display:flex; gap:8px;
    }
    .note{
      font-size:12px; color:var(--muted); text-align:center;
      margin-top:16px; padding:12px;
      background:#f8fbfc; border-radius:10px;
    }

    /* Calend√°rio corrigido */
    .calTop{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .calTop select{max-width:170px}
    .calNav{display:flex; align-items:center; gap:8px; margin-left:auto}
    .calNav .btn{padding:9px 10px}
    .calGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(7,1fr);
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      background:#fff;
    }
    .calCell, .calHeadCell{
      min-height:80px;
      border-right:1px solid var(--line);
      border-bottom:1px solid var(--line);
      padding:8px;
      position:relative;
      background:#fff;
      cursor:pointer;
      transition:all 0.2s;
    }
    .calCell:hover{
      background:#f8fbfc;
      transform:translateY(-1px);
    }
    .calCell.today{
      background:linear-gradient(135deg, #e8f7fa, #d4f0f5);
      border:2px solid var(--teal);
    }
    .calCell.selected{
      background:linear-gradient(135deg, #f0f7ff, #e6f0ff);
      border:2px solid var(--ai-blue);
    }
    .calCell.mutedDay .d{color:#b9c6cf}
    .calHeadCell{
      min-height:36px; cursor:default; background:#f7fbfc; 
      font-weight:900; color:#6b7a86; font-size:12px; 
      display:flex; align-items:center; justify-content:center;
    }
    .calCell:nth-child(7n), .calHeadCell:nth-child(7n){border-right:none}
    .calCell .d{
      font-weight:900; color:#2b3b45;
      font-size:14px;
    }
    .calEvents{
      margin-top:4px;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .calEvent{
      font-size:10px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      padding:2px 4px;
      border-radius:4px;
      background:rgba(255,255,255,0.9);
      border-left:2px solid var(--teal);
    }
    .calEvent.task{
      border-left-color:var(--warn);
      background:rgba(255,176,0,.08);
    }
    .calEventDot{
      width:6px; height:6px; border-radius:50%;
      display:inline-block; margin-right:3px;
    }

    /* Day Detail */
    .dayDetail{
      max-height:400px;
      overflow-y:auto;
      margin-top:12px;
    }
    .dayEventItem{
      padding:12px;
      border-radius:10px;
      border:1px solid var(--line);
      margin-bottom:8px;
      background:#fff;
      cursor:pointer;
      transition:all 0.2s;
    }
    .dayEventItem:hover{
      transform:translateX(2px);
      box-shadow:0 4px 12px rgba(0,0,0,.08);
    }
    .dayEventTime{
      font-size:12px;
      color:var(--teal);
      font-weight:900;
      display:inline-block;
      margin-right:8px;
    }
    .dayEventType{
      font-size:10px;
      padding:1px 6px;
      border-radius:10px;
      background:#f0f9fb;
      color:var(--teal2);
      display:inline-block;
      margin-right:6px;
    }

    /* Quick Add */
    .quick-add{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:8px;
      margin-top:12px;
    }
    .quick-add-btn{
      padding:12px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#fff;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:all 0.2s;
    }
    .quick-add-btn:hover{
      background:#f8fbfc;
      border-color:var(--teal);
    }
    .quick-add-btn svg{
      width:24px; height:24px;
      fill:var(--teal);
    }

    /* Integration badges */
    .integration-badges{
      display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;
    }
    .integration-badge{
      padding:4px 8px; border-radius:6px;
      font-size:11px; font-weight:900;
      display:flex; align-items:center; gap:4px;
    }
    .integration-badge.google{
      background:#f1f3f4; color:#5f6368;
      border:1px solid #dadce0;
    }
    .integration-badge.ios{
      background:#f2f2f7; color:#1d1d1f;
      border:1px solid #c7c7cc;
    }

    /* Floating AI Assistant */
    .fab{
      position:fixed; right:14px; bottom:18px;
      width:62px; height:62px;
      border-radius:999px;
      background:linear-gradient(135deg, var(--ai-blue), var(--ai-purple));
      box-shadow:0 16px 34px rgba(138,43,226,.30);
      border:1px solid rgba(255,255,255,.28);
      display:grid; place-items:center;
      cursor:pointer;
      z-index:60;
    }
    .fab svg{width:28px;height:28px; fill:#fff}
    .chat{
      position:fixed; right:14px; bottom:90px;
      width:min(420px, calc(100vw - 28px));
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
      display:none;
      z-index:61;
    }
    .chat.open{display:block}
    .chatHead{
      background:linear-gradient(90deg, var(--ai-blue), var(--ai-purple));
      color:#fff; padding:10px 12px;
      display:flex; align-items:center; gap:10px;
    }
    .chatHead strong{font-weight:900}
    .chatBody{padding:10px; max-height:48vh; overflow:auto; background:linear-gradient(180deg,#ffffff, #f7fbfc)}
    .bubble{
      max-width:88%;
      padding:10px 12px;
      border-radius:14px;
      margin:8px 0;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:0 8px 18px rgba(0,0,0,.06);
      font-size:14px;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .bubble.me{margin-left:auto; background:#eaf9fc; border-color:#cfeef4}
    .bubble.ai{margin-right:auto; background:#f5f0ff; border-color:#e6d9ff}
    .chatFoot{
      border-top:1px solid var(--line);
      padding:10px;
      display:flex; gap:10px;
      background:#fff;
    }
    .chatFoot input{
      flex:1;
      border-radius:12px;
      border:1px solid #dbe6ec;
      padding:12px 12px;
      font-size:15px;
      outline:none;
    }
    .chatFoot input:focus{border-color:rgba(10,166,191,.55); box-shadow:0 0 0 4px rgba(10,166,191,.12)}

    /* Toast */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:96px; z-index:80;
      background:#0f1720; color:#fff;
      padding:10px 12px;
      border-radius:12px;
      box-shadow:0 18px 40px rgba(0,0,0,.28);
      display:none;
      max-width:min(520px, calc(100vw - 24px));
      font-size:14px;
    }

    /* Modal */
    .backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.38);
      display:none; z-index:120;
      padding:16px;
      place-items:center;
    }
    .backdrop.open{display:grid}
    .modal{
      width:min(560px, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid var(--line);
      box-shadow:0 26px 70px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;
      background:#f7fbfc;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; gap:10px;
    }
    .modalHead strong{font-weight:900}
    .modalBody{padding:14px; max-height:70vh; overflow-y:auto}
    .modalFoot{
      padding:12px 14px;
      border-top:1px solid var(--line);
      display:flex; gap:10px;
      justify-content:flex-end;
      background:#fff;
    }

    /* Task List */
    .task-item{
      display:flex; align-items:center; gap:12px;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--line);
      margin-bottom:8px;
      background:#fff;
    }
    .task-check{
      width:20px; height:20px;
      border-radius:6px;
      border:2px solid var(--line);
      display:grid; place-items:center;
      cursor:pointer;
    }
    .task-check.checked{background:var(--good); border-color:var(--good)}
    .task-check.checked::after{content:"‚úì"; color:white; font-weight:900}
    .task-content{flex:1}
    .task-title{font-weight:900}
    .task-desc{font-size:13px; color:var(--muted); margin-top:2px}
    .task-due{font-size:12px; color:var(--warn); font-weight:900}
    .task-priority{
      padding:2px 8px;
      border-radius:999px;
      font-size:11px; font-weight:900;
      background:#f0f0f0;
    }
    .task-priority.high{background:#ffeaea; color:var(--bad)}
    .task-priority.medium{background:#fff4e6; color:var(--warn)}
    .task-priority.low{background:#f0f9ff; color:var(--teal)}

    /* AI Insights */
    .insight{
      border-radius:14px;
      padding:14px;
      margin:12px 0;
      border-left:4px solid var(--ai-blue);
      background:linear-gradient(90deg, #f8fbff, #f5f8ff);
    }
    .insight.warn{border-left-color:var(--warn); background:linear-gradient(90deg, #fffaf0, #fff8e6)}
    .insight.good{border-left-color:var(--good); background:linear-gradient(90deg, #f0fff8, #e6fff2)}
    .insight-header{display:flex; align-items:center; gap:10px; margin-bottom:8px}
    .insight-header svg{width:20px;height:20px; fill:var(--ai-blue)}
    .insight-header.warn svg{fill:var(--warn)}
    .insight-header.good svg{fill:var(--good)}
    .insight-title{font-weight:900; font-size:15px}
    .insight-content{font-size:13px; line-height:1.4}

    @media (min-width: 980px){
      main{padding:20px 18px 94px; max-width:980px; width:100%; margin:0 auto}
    }
  </style>
</head>
<body>

<div id="toast" class="toast"></div>

<!-- PROFILE SELECTOR -->
<div id="profileSelector" class="authWrap">
  <div class="authCard">
    <div class="authHead">
      <div class="big">K‚ÄëGenda</div>
      <div class="sm">Assistente Pessoal com IA ‚Ä¢ Organize sua vida</div>
    </div>
    <div class="authBody">
      <h2 style="margin:0 0 16px">Selecione seu perfil</h2>
      <div class="profiles" id="profilesList">
        <!-- Profiles will be loaded here -->
      </div>
      <div class="btnRow" style="margin-top:20px">
        <button class="btn good" id="createProfileBtn" type="button">+ Criar Novo Perfil</button>
        <button class="btn secondary" id="quickStartBtn" type="button">Entrar como Visitante</button>
      </div>
      <div class="note">Os dados ficam no seu dispositivo. Voc√™ pode ter m√∫ltiplos perfis (pessoal, trabalho, fam√≠lia).</div>
    </div>
  </div>
</div>

<!-- CREATE PROFILE MODAL -->
<div class="backdrop" id="createProfileModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHead">
      <strong>Criar Novo Perfil</strong>
      <div class="spacer"></div>
      <button class="btn secondary small" id="closeProfileModal" type="button">‚úï</button>
    </div>
    <div class="modalBody">
      <label>Nome do Perfil</label>
      <input class="input" id="profileName" placeholder="Ex.: Pessoal, Trabalho, Fam√≠lia">
      <label>Seu Nome (opcional)</label>
      <input class="input" id="userName" placeholder="Como devo te chamar?">
      <label>Email (opcional)</label>
      <input class="input" id="userEmail" type="email" placeholder="para lembretes por email">
      <div class="hint" style="margin-top:12px">
        Dica: crie perfis separados para diferentes √°reas da sua vida. Voc√™ pode exportar/importar dados depois.
      </div>
    </div>
    <div class="modalFoot">
      <button class="btn secondary" id="cancelProfileBtn" type="button">Cancelar</button>
      <button class="btn good" id="saveProfileBtn" type="button">Criar Perfil</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="app" hidden>
  <header class="topbar">
    <div class="topbarRow">
      <div class="brand">
        <div class="logo">K</div>
        <div class="titleWrap">
          <div class="title">K‚ÄëGenda</div>
          <div class="subtitle" id="who">Assistente Pessoal com IA</div>
        </div>
      </div>
      <div class="topActions">
        <div class="pill" id="todayPill">Hoje</div>
        <div class="profileBtn" id="profileBtn">?</div>
        <div class="menu" id="menu">
          <!-- Menu ser√° preenchido dinamicamente -->
        </div>
      </div>
    </div>

    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="dashboard">
        <svg class="ic" viewBox="0 0 24 24"><path fill="white" d="M13 3v18h8V3zM3 13h8V3H3zm0 8h8v-6H3z"/></svg>
        <span>Dashboard</span>
      </div>
      <div class="tab" data-tab="customers">
        <svg class="ic" viewBox="0 0 24 24"><path fill="white" d="M12 12a4 4 0 1 0-4-4a4 4 0 0 0 4 4Zm0 2c-3.33 0-8 1.67-8 5v1h16v-1c0-3.33-4.67-5-8-5Z"/></svg>
        <span>Clientes</span>
      </div>
      <div class="tab" data-tab="appointments">
        <svg class="ic" viewBox="0 0 24 24"><path fill="white" d="M7 2v2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2V2h-2v2H9V2Zm12 8H5V8h14Zm-9 4h2v2h-2Zm4 0h2v2h-2Z"/></svg>
        <span>Agend.</span>
      </div>
      <div class="tab" data-tab="tasks">
        <svg class="ic" viewBox="0 0 24 24"><path fill="white" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6Zm-3 16l-3-3l1.41-1.41L11 15.17l4.59-4.59L17 12l-6 6Z"/></svg>
        <span>Tarefas</span>
      </div>
      <div class="tab" data-tab="calendar">
        <svg class="ic" viewBox="0 0 24 24"><path fill="white" d="M19 4h-1V2h-2v2H8V2H6v2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Zm0 16H5V10h14Z"/></svg>
        <span>Calend.</span>
      </div>
      <div class="tab" data-tab="insights">
        <svg class="ic" viewBox="0 0 24 24"><path fill="white" d="M21 8c-1.5 0-2.3 1.4-3 2.3c-.7-.9-1.5-2.3-3-2.3c-1.7 0-2.7 1.9-3.7 3.2c-1-1.3-2-3.2-3.7-3.2c-1.5 0-2.3 1.4-3 2.3V4H3v16h18V8z"/></svg>
        <span>Insights</span>
      </div>
    </div>
  </header>

  <main>
    <!-- Dashboard -->
    <section class="page active" id="page-dashboard">
      <h1>Dashboard</h1>
      
      <div class="card">
        <div class="cardPad">
          <div class="split">
            <div>
              <strong>Vis√£o Geral</strong>
              <div class="muted" style="font-size:13px">Resumo da sua organiza√ß√£o pessoal</div>
            </div>
            <div class="spacer"></div>
            <button class="btn ai" id="aiAnalyzeBtn" type="button">üîç An√°lise IA</button>
          </div>
          
          <div class="kpi" style="margin-top:16px">
            <div class="k"><div class="n" id="kpiCustomers">0</div><div class="t">Clientes</div></div>
            <div class="k"><div class="n" id="kpiAppts">0</div><div class="t">Agendamentos</div></div>
            <div class="k"><div class="n" id="kpiTasks">0</div><div class="t">Tarefas</div></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="cardPad">
          <strong>Insights da IA</strong>
          <div class="muted" style="font-size:13px">An√°lises inteligentes baseadas nos seus dados</div>
          
          <div id="aiInsights">
            <!-- AI insights will be loaded here -->
          </div>
          
          <div class="btnRow">
            <button class="btn secondary" id="refreshInsightsBtn" type="button">Atualizar Insights</button>
            <button class="btn ai" id="askInsightBtn" type="button">Perguntar √† IA</button>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="col">
          <div class="card">
            <div class="cardPad">
              <strong>Pr√≥ximos Compromissos</strong>
              <div class="muted" style="font-size:13px">Hoje e amanh√£</div>
              <div class="list" id="upcomingAppts" style="margin-top:12px"> </div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <div class="cardPad">
              <strong>Tarefas Pendentes</strong>
              <div class="muted" style="font-size:13px">Prioridade alta</div>
              <div class="list" id="pendingTasks" style="margin-top:12px"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Customers -->
    <section class="page" id="page-customers">
      <h1>Clientes</h1>
      <div class="card">
        <div class="cardPad">
          <div class="split">
            <div>
              <strong>Gerencie seus clientes</strong>
              <div class="muted" style="font-size:13px">Nome, telefone, email e notas.</div>
            </div>
            <div class="spacer"></div>
            <button class="btn good" id="addCustomerBtn" type="button">+ Criar cliente</button>
          </div>
          <label>Buscar</label>
          <input class="input" id="customerSearch" placeholder="Pesquisar por nome, telefone ou email">
        </div>
        <div class="list" id="customerList"></div>
      </div>
    </section>

    <!-- Appointments -->
    <section class="page" id="page-appointments">
      <h1>Agendamentos</h1>
      <div class="card">
        <div class="cardPad">
          <div class="split">
            <div>
              <strong>Novo Agendamento</strong>
              <div class="muted" style="font-size:13px">Crie compromissos com clientes</div>
            </div>
            <div class="spacer"></div>
            <button class="btn ai small" id="aiScheduleBtn" type="button">IA: Sugerir Hor√°rio</button>
          </div>
          
          <label>Cliente</label>
          <select id="apptCustomer"></select>

          <label>Tipo de lembrete</label>
          <div class="seg" role="group" aria-label="Reminder Type">
            <button type="button" class="active" data-rem="email">Email</button>
            <button type="button" data-rem="sms">SMS</button>
            <button type="button" data-rem="both">Ambos</button>
            <button type="button" data-rem="none">Nenhum</button>
          </div>

          <div class="row">
            <div class="col">
              <label>Telefone</label>
              <input class="input" id="apptPhone" placeholder="(DDD) n√∫mero">
            </div>
            <div class="col">
              <label>Email</label>
              <input class="input" id="apptEmail" placeholder="cliente@dominio.com">
            </div>
          </div>

          <label>T√≠tulo</label>
          <input class="input" id="apptTitle" placeholder="Ex.: Corte de cabelo, Reuni√£o, Consulta...">

          <div class="row">
            <div class="col">
              <label>Data</label>
              <input class="input" id="apptDate" type="date">
            </div>
            <div class="col">
              <label>Hora</label>
              <input class="input" id="apptTime" type="time">
            </div>
            <div class="col">
              <label>Dura√ß√£o</label>
              <select id="apptDuration">
                <option value="15">15 min</option>
                <option value="30" selected>30 min</option>
                <option value="45">45 min</option>
                <option value="60">60 min</option>
                <option value="90">90 min</option>
                <option value="120">120 min</option>
              </select>
            </div>
          </div>

          <label>Notas</label>
          <textarea id="apptNotes" placeholder="Detalhes do compromisso..."></textarea>

          <div class="hint" id="conflictHint" style="display:none"></div>

          <div class="btnRow">
            <button class="btn good" id="saveApptBtn" type="button">Salvar</button>
            <button class="btn secondary" id="clearApptBtn" type="button">Limpar</button>
          </div>
        </div>
        <div class="list" id="apptList"></div>
      </div>
    </section>

    <!-- Tasks -->
    <section class="page" id="page-tasks">
      <h1>Tarefas</h1>
      <div class="card">
        <div class="cardPad">
          <div class="split">
            <div>
              <strong>Gerenciador de Tarefas</strong>
              <div class="muted" style="font-size:13px">Organize suas atividades pessoais</div>
            </div>
            <div class="spacer"></div>
            <button class="btn good" id="addTaskBtn" type="button">+ Nova Tarefa</button>
          </div>
          
          <div class="row">
            <div class="col">
              <label>Filtrar</label>
              <select id="taskFilter">
                <option value="all">Todas</option>
                <option value="pending">Pendentes</option>
                <option value="completed">Conclu√≠das</option>
                <option value="today">Hoje</option>
                <option value="high">Alta Prioridade</option>
              </select>
            </div>
            <div class="col">
              <label>Ordenar</label>
              <select id="taskSort">
                <option value="due">Data de Vencimento</option>
                <option value="priority">Prioridade</option>
                <option value="created">Data de Cria√ß√£o</option>
              </select>
            </div>
            <div class="col">
              <label>Buscar</label>
              <input class="input" id="taskSearch" placeholder="Pesquisar tarefas">
            </div>
          </div>
        </div>
        <div class="list" id="taskList"></div>
      </div>
      
      <div class="card" style="margin-top:12px">
        <div class="cardPad">
          <strong>IA: Sugest√µes de Produtividade</strong>
          <div class="muted" style="font-size:13px">Baseado nos seus padr√µes</div>
          <div id="taskSuggestions" style="margin-top:12px"></div>
        </div>
      </div>
    </section>

    <!-- Calendar -->
    <section class="page" id="page-calendar">
      <h1>Calend√°rio Inteligente</h1>
      
      <div class="card">
        <div class="cardPad">
          <div class="calTop">
            <select id="calView">
              <option value="month" selected>Visualiza√ß√£o Mensal</option>
              <option value="week">Visualiza√ß√£o Semanal</option>
              <option value="day">Visualiza√ß√£o Di√°ria</option>
            </select>
            
            <div class="integration-badges">
              <div class="integration-badge google">
                <svg width="12" height="12" viewBox="0 0 24 24"><path fill="#5F6368" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Google Calendar
              </div>
              <div class="integration-badge ios">
                <svg width="12" height="12" viewBox="0 0 24 24"><path fill="#000" d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.31-2.33 1.05-3.11z"/></svg>
                Apple Calendar
              </div>
            </div>
            
            <div class="calNav">
              <button class="btn secondary small" id="calPrev" type="button">‚óÄ</button>
              <div class="pill" id="calLabel">‚Äî</div>
              <button class="btn secondary small" id="calNext" type="button">‚ñ∂</button>
            </div>
            
            <button class="btn ai small" id="syncCalendarBtn" type="button">üîÑ Sincronizar</button>
          </div>
          
          <div id="calWrap"></div>
          
          <div class="quick-add" id="quickAddSection" style="display:none; margin-top:12px">
            <div class="quick-add-btn" id="quickAddAppt">
              <svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2zm0 16H5V9h14z"/></svg>
              <span>Agendamento</span>
            </div>
            <div class="quick-add-btn" id="quickAddTask">
              <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-3 16l-3-3 1.41-1.41L11 15.17l4.59-4.59L17 12l-6 6z"/></svg>
              <span>Tarefa</span>
            </div>
            <div class="quick-add-btn" id="quickAddReminder">
              <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
              <span>Lembrete</span>
            </div>
            <div class="quick-add-btn" id="quickAddNote">
              <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm2 14h-3v3h-2v-3H8v-2h3v-3h2v3h3v2zm-3-7V3.5L18.5 9z"/></svg>
              <span>Nota</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card" style="margin-top:12px">
        <div class="cardPad">
          <strong id="dayDetailTitle">Dia selecionado</strong>
          <div class="muted" style="font-size:13px" id="dayLabel">Selecione uma data no calend√°rio</div>
          <div class="dayDetail" id="dayAppts"></div>
        </div>
      </div>
    </section>

    <!-- Insights -->
    <section class="page" id="page-insights">
      <h1>Insights com IA</h1>
      <div class="card">
        <div class="cardPad">
          <div class="split">
            <div>
              <strong>An√°lise de Produtividade</strong>
              <div class="muted" style="font-size:13px">Intelig√™ncia Artificial analisa seus dados</div>
            </div>
            <div class="spacer"></div>
            <button class="btn ai" id="generateReportBtn" type="button">Gerar Relat√≥rio</button>
          </div>
          
          <div class="row" style="margin-top:16px">
            <div class="col">
              <div class="k">
                <div class="n" id="insightBusyDays">0</div>
                <div class="t">Dias Mais Ocupados</div>
              </div>
            </div>
            <div class="col">
              <div class="k">
                <div class="n" id="insightTopClients">0</div>
                <div class="t">Clientes Frequentes</div>
              </div>
            </div>
            <div class="col">
              <div class="k">
                <div class="n" id="insightCompletion">0%</div>
                <div class="t">Taxa de Conclus√£o</div>
              </div>
            </div>
          </div>
          
          <div id="advancedInsights" style="margin-top:20px">
            <!-- Advanced insights will be loaded here -->
          </div>
        </div>
      </div>
      
      <div class="card" style="margin-top:12px">
        <div class="cardPad">
          <strong>Consultas √† IA</strong>
          <div class="muted" style="font-size:13px">Fa√ßa perguntas sobre sua agenda e produtividade</div>
          <div class="chatBody" id="insightChat" style="height:200px; margin:12px 0; border:1px solid var(--line); border-radius:12px; padding:12px; overflow-y:auto; background:#f9fdfe"></div>
          <div class="chatFoot" style="border:none; padding:0">
            <input id="insightQuery" placeholder='Ex.: "Quais s√£o meus hor√°rios mais produtivos?"'>
            <button class="btn ai" id="askInsightQueryBtn" type="button">Perguntar</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- AI floating -->
  <div class="fab" id="fab" title="Assistente IA">
    <svg viewBox="0 0 24 24"><path fill="white" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
  </div>

  <div class="chat" id="chat">
    <div class="chatHead">
      <div class="logo" style="width:30px;height:30px;border-radius:10px; background:linear-gradient(135deg, var(--ai-blue), var(--ai-purple))">AI</div>
      <div style="min-width:0">
        <strong>Assistente K‚ÄëGenda IA</strong>
        <div style="opacity:.92; font-size:12px">Assistente pessoal inteligente</div>
      </div>
      <div class="spacer"></div>
      <button class="btn secondary small" id="chatClose" type="button">Fechar</button>
    </div>
    <div class="chatBody" id="chatBody"></div>
    <div class="chatFoot">
      <input id="chatIn" placeholder='Ex.: "Agendar reuni√£o com Jo√£o amanh√£ √†s 14h", "Criar tarefa: comprar presente", "Analisar minha produtividade"'/>
      <button class="btn ai" id="chatSend" type="button">Enviar</button>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="backdrop" id="backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHead">
      <strong id="modalTitle">‚Äî</strong>
      <div class="spacer"></div>
      <button class="btn secondary small" id="modalX" type="button">‚úï</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
    <div class="modalFoot" id="modalFoot"></div>
  </div>
</div>

<script>
/* =========================
   K‚ÄëGENDA ‚Ä¢ ASSISTENTE PESSOAL COM IA
   VERS√ÉO COMPLETA CORRIGIDA
   ========================= */

/* ---------- Helpers ---------- */
const $ = (q, el=document) => el.querySelector(q);
const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

function uid(prefix="id"){
  const s = crypto.getRandomValues(new Uint8Array(16));
  return prefix + "_" + Array.from(s).map(b => b.toString(16).padStart(2, "0")).join("");
}

function nowISO(){ 
  return new Date().toISOString(); 
}

function toast(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(() => t.style.display = "none", 2400);
}

function safeJSONParse(str, fallback=null){
  try{ 
    return JSON.parse(str); 
  } catch(e){ 
    return fallback; 
  }
}

// FUN√á√ïES DE DATA CORRIGIDAS
function dateISO(d) {
  // Corrige o bug do timezone
  const date = new Date(d);
  // Usar UTC para evitar problemas de fuso hor√°rio
  const year = date.getUTCFullYear();
  const month = String(date.getUTCMonth() + 1).padStart(2, "0");
  const day = String(date.getUTCDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}

function timeHM(d) {
  const date = new Date(d);
  return String(date.getHours()).padStart(2, "0") + ":" + 
         String(date.getMinutes()).padStart(2, "0");
}

function formatDateHuman(iso) {
  const d = new Date(iso + "T12:00:00"); // Meio-dia para evitar timezone
  return d.toLocaleDateString("pt-BR", {
    weekday: "long",
    day: "numeric",
    month: "long",
    year: "numeric"
  });
}

function formatDateTimeHuman(iso) {
  const d = new Date(iso);
  return d.toLocaleDateString("pt-BR", {
    weekday: "short",
    day: "2-digit",
    month: "short"
  }) + " " + timeHM(d);
}

/* ---------- Storage Model ---------- */
const KEY = {
  profiles: "kgenda_profiles_v2",
  activeProfile: "kgenda_active_profile_v2",
  data: (profileId) => `kgenda_data_v2_${profileId}`
};

function loadProfiles(){ 
  return safeJSONParse(localStorage.getItem(KEY.profiles), []) || []; 
}

function saveProfiles(arr){ 
  localStorage.setItem(KEY.profiles, JSON.stringify(arr)); 
}

function getActiveProfileId(){ 
  return localStorage.getItem(KEY.activeProfile); 
}

function setActiveProfileId(id){ 
  localStorage.setItem(KEY.activeProfile, id); 
}

function clearActiveProfile(){ 
  localStorage.removeItem(KEY.activeProfile); 
}

function defaultData(){
  return {
    version: 2,
    profileName: "Perfil Pessoal",
    userName: "",
    userEmail: "",
    prefs: { clock24: false, interval: 15, duration: 30 },
    customers: [],
    appts: [],
    tasks: [],
    templates: [
      {id: uid("tpl"), name: "Template SMS", channel: "sms", body: "Ol√° {{FirstName}}, lembrete: {{Title}} √†s {{Time}} em {{Date}}.", tags: "{{FirstName}}, {{Date}}, {{Time}}, {{Title}}"},
      {id: uid("tpl"), name: "Template Email", channel: "email", body: "Prezado {{FirstName}},\n\nLembrete do compromisso: {{Title}}\nData: {{Date}}\nHora: {{Time}}\n\nAtenciosamente,\nSua Agenda", tags: "{{FirstName}}, {{Date}}, {{Time}}, {{Title}}"}
    ],
    aiSettings: {
      learningEnabled: true,
      productivityTips: true,
      smartScheduling: true,
      insightsFrequency: "daily"
    }
  };
}

function loadData(profileId){
  const raw = localStorage.getItem(KEY.data(profileId));
  const parsed = safeJSONParse(raw, null);
  if(!parsed) return defaultData();
  
  // Ensure fields exist
  return {
    version: 2,
    profileName: parsed.profileName || "Perfil",
    userName: parsed.userName || "",
    userEmail: parsed.userEmail || "",
    prefs: parsed.prefs || {clock24: false, interval: 15, duration: 30},
    customers: parsed.customers || [],
    appts: parsed.appts || [],
    tasks: parsed.tasks || [],
    templates: parsed.templates || defaultData().templates,
    aiSettings: parsed.aiSettings || defaultData().aiSettings
  };
}

function saveData(profileId, data){
  localStorage.setItem(KEY.data(profileId), JSON.stringify(data));
}

/* ---------- State ---------- */
let currentProfile = null;
let data = null;

/* ---------- Profile System CORRIGIDO ---------- */
const profileSelectorEl = $("#profileSelector");
const appEl = $("#app");

function showProfileSelector(){
  profileSelectorEl.hidden = false;
  appEl.hidden = true;
  renderProfilesList();
}

function showApp(){
  profileSelectorEl.hidden = true;
  appEl.hidden = false;
  
  if (currentProfile && data) {
    hydrateUI();
  }
}

function renderProfilesList(){
  const list = $("#profilesList");
  const profiles = loadProfiles();
  
  list.innerHTML = "";
  
  if(profiles.length === 0){
    list.innerHTML = `
      <div class="profile-card" style="text-align:center; justify-content:center">
        <div class="muted">Nenhum perfil criado ainda</div>
      </div>
    `;
    return;
  }
  
  profiles.forEach(profile => {
    const profileData = loadData(profile.id);
    const stats = getProfileStats(profileData);
    const initials = (profile.profileName || "P").trim()
      .split(/\s+/)
      .slice(0,2)
      .map(x => x[0]?.toUpperCase() || "")
      .join("") || "P";
    
    const el = document.createElement("div");
    el.className = "profile-card";
    el.innerHTML = `
      <div class="profile-icon">${initials}</div>
      <div class="profile-info">
        <div class="profile-name">${escapeHTML(profile.profileName)}</div>
        ${profile.userName ? `<div class="profile-email">${escapeHTML(profile.userName)}</div>` : ""}
        <div class="profile-stats">
          <span>${stats.customers} clientes</span>
          <span>‚Ä¢</span>
          <span>${stats.appts} compromissos</span>
          <span>‚Ä¢</span>
          <span>${stats.tasks} tarefas</span>
        </div>
      </div>
    `;
    
    el.addEventListener("click", () => {
      selectProfile(profile.id);
    });
    
    list.appendChild(el);
  });
}

function getProfileStats(profileData){
  return {
    customers: profileData.customers.length,
    appts: profileData.appts.length,
    tasks: profileData.tasks.filter(t => !t.completed).length
  };
}

function selectProfile(profileId){
  const profiles = loadProfiles();
  const profile = profiles.find(p => p.id === profileId);
  if(!profile) return;
  
  currentProfile = profile;
  data = loadData(profileId);
  setActiveProfileId(profileId);
  showApp();
  hydrateUI();
  toast(`Perfil "${profile.profileName}" carregado.`);
}

function createProfile(profileName, userName, userEmail){
  const profiles = loadProfiles();
  const profileId = uid("prof");
  const newProfile = {
    id: profileId,
    profileName: profileName.trim(),
    userName: userName.trim(),
    userEmail: userEmail.trim(),
    createdAt: nowISO()
  };
  
  profiles.push(newProfile);
  saveProfiles(profiles);
  
  // Create default data for new profile
  const newData = defaultData();
  newData.profileName = profileName.trim();
  newData.userName = userName.trim();
  newData.userEmail = userEmail.trim();
  saveData(profileId, newData);
  
  return newProfile;
}

/* ---------- Profile Modal ---------- */
function openCreateProfileModal(){
  $("#createProfileModal").classList.add("open");
}

function closeCreateProfileModal(){
  $("#createProfileModal").classList.remove("open");
  $("#profileName").value = "";
  $("#userName").value = "";
  $("#userEmail").value = "";
}

$("#createProfileBtn").addEventListener("click", openCreateProfileModal);
$("#closeProfileModal").addEventListener("click", closeCreateProfileModal);
$("#cancelProfileBtn").addEventListener("click", closeCreateProfileModal);

$("#saveProfileBtn").addEventListener("click", () => {
  const profileName = $("#profileName").value.trim();
  const userName = $("#userName").value.trim();
  const userEmail = $("#userEmail").value.trim();
  
  if(!profileName){
    toast("Informe um nome para o perfil.");
    return;
  }
  
  const profile = createProfile(profileName, userName, userEmail);
  closeCreateProfileModal();
  selectProfile(profile.id);
});

// CORRIGIDO: Bot√£o "Entrar como Visitante"
$("#quickStartBtn").addEventListener("click", () => {
  // Criar ou usar perfil visitante existente
  const profiles = loadProfiles();
  let guestProfile = profiles.find(p => p.profileName === "Visitante");
  
  if (!guestProfile) {
    guestProfile = createProfile("Visitante", "Visitante", "");
  }
  
  selectProfile(guestProfile.id);
});

/* ---------- Menu System CORRIGIDO ---------- */
function updateMenu(){
  const menu = $("#menu");
  
  if (!currentProfile || !data) {
    menu.innerHTML = "";
    return;
  }
  
  menu.innerHTML = `
    <div class="mi" id="miProfile">
      <strong id="miName">${data.userName || "Perfil"}</strong>
      <div class="spacer"></div>
      <small id="miEmail">${data.userEmail || "Sem email"}</small>
    </div>
    <div class="sep"></div>
    <div class="mi" id="miSwitchProfile">Trocar Perfil</div>
    <div class="mi" id="miExport">Exportar dados (JSON)</div>
    <div class="mi" id="miImport">Importar dados (JSON)</div>
    <div class="sep"></div>
    <div class="mi" id="miLogout">
      <span style="color:var(--bad);font-weight:900">Sair</span>
    </div>
  `;
  
  // Event listeners do menu
  $("#miSwitchProfile").addEventListener("click", () => {
    setMenuOpen(false);
    setTimeout(() => {
      showProfileSelector();
    }, 100);
  });
  
  $("#miLogout").addEventListener("click", () => {
    setMenuOpen(false);
    clearActiveProfile();
    currentProfile = null;
    data = null;
    showProfileSelector();
    toast("Voc√™ saiu do perfil");
  });
  
  $("#miExport").addEventListener("click", exportData);
  $("#miImport").addEventListener("click", importData);
}

function setMenuOpen(open){
  const m = $("#menu");
  if(open) {
    m.classList.add("open");
  } else {
    m.classList.remove("open");
  }
}

// CORRIGIDO: Event listener do bot√£o de perfil
$("#profileBtn").addEventListener("click", (e) => {
  e.stopPropagation();
  setMenuOpen(!$("#menu").classList.contains("open"));
});

// Fechar menu ao clicar fora
document.addEventListener("click", (e) => {
  const menu = $("#menu");
  const profileBtn = $("#profileBtn");
  
  if (menu.classList.contains("open") && 
      !menu.contains(e.target) && 
      !profileBtn.contains(e.target)) {
    setMenuOpen(false);
  }
});

/* ---------- Tabs ---------- */
function goTab(key){
  $$(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab === key));
  $$(".page").forEach(p => p.classList.remove("active"));
  $("#page-" + key).classList.add("active");
  setMenuOpen(false);
  
  if(key === "dashboard"){ renderDashboard(); }
  if(key === "appointments"){ renderAppts(); syncApptFormFromCustomer(); }
  if(key === "calendar"){ renderCalendar(); }
  if(key === "tasks"){ renderTasks(); }
  if(key === "insights"){ renderInsights(); }
  if(key === "customers"){ renderCustomers(); }
}

$$(".tab").forEach(t => t.addEventListener("click", () => goTab(t.dataset.tab)));

/* ---------- Modal ---------- */
function openModal(title, bodyHTML, buttons=[]){
  $("#modalTitle").textContent = title;
  $("#modalBody").innerHTML = bodyHTML;
  const foot = $("#modalFoot");
  foot.innerHTML = "";
  
  for(const b of buttons){
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "btn " + (b.variant || "secondary");
    btn.textContent = b.label;
    btn.addEventListener("click", b.onClick);
    foot.appendChild(btn);
  }
  
  $("#backdrop").classList.add("open");
}

function closeModal(){
  $("#backdrop").classList.remove("open");
}

$("#modalX").addEventListener("click", closeModal);
$("#backdrop").addEventListener("click", (e) => {
  if(e.target.id === "backdrop") closeModal();
});

/* ---------- Export/Import ---------- */
function exportData() {
  if (!currentProfile || !data) return;
  
  const exportData = {
    profile: currentProfile,
    data: data,
    exportedAt: nowISO(),
    version: 2
  };
  
  const json = JSON.stringify(exportData, null, 2);
  const blob = new Blob([json], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement("a");
  a.href = url;
  a.download = `kgenda-${currentProfile.profileName.replace(/\s+/g, "-").toLowerCase()}-${dateISO(new Date())}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  toast("Dados exportados com sucesso!");
  setMenuOpen(false);
}

function importData() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".json";
  
  input.onchange = (e) => {
    const file = e.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const imported = JSON.parse(reader.result);
        if(!imported.data || !imported.profile){
          toast("Arquivo inv√°lido. Certifique-se de que √© um backup do K‚ÄëGenda.");
          return;
        }
        
        openModal("Importar Dados", `
          <p>Importar dados para o perfil <strong>${escapeHTML(currentProfile.profileName)}</strong>?</p>
          <p>Isso substituir√° todos os dados atuais.</p>
          <p><strong>Importante:</strong> Certifique-se de que o arquivo √© de uma vers√£o compat√≠vel.</p>
        `, [
          {label: "Cancelar", variant: "secondary", onClick: closeModal},
          {label: "Importar e Substituir", variant: "bad", onClick: () => {
            data = imported.data;
            saveData(currentProfile.id, data);
            
            if(imported.profile.userName){
              currentProfile.userName = imported.profile.userName;
              currentProfile.userEmail = imported.profile.userEmail;
              const profiles = loadProfiles();
              const idx = profiles.findIndex(p => p.id === currentProfile.id);
              if(idx >= 0){
                profiles[idx] = currentProfile;
                saveProfiles(profiles);
              }
            }
            
            hydrateUI();
            toast("Dados importados com sucesso!");
            closeModal();
            setMenuOpen(false);
          }}
        ]);
      } catch(err){
        toast("Erro ao ler arquivo. Certifique-se de que √© um JSON v√°lido.");
      }
    };
    reader.readAsText(file);
  };
  
  input.click();
  setMenuOpen(false);
}

/* ---------- Dashboard ---------- */
function renderDashboard(){
  if (!data) return;
  
  // Update KPIs
  $("#kpiCustomers").textContent = data.customers.length;
  $("#kpiAppts").textContent = data.appts.length;
  $("#kpiTasks").textContent = data.tasks.filter(t => !t.completed).length;
  
  // Render upcoming appointments
  renderUpcomingAppts();
  
  // Render pending tasks
  renderPendingTasks();
  
  // Generate AI insights
  generateAIInsights();
}

function renderUpcomingAppts(){
  const container = $("#upcomingAppts");
  const today = dateISO(new Date());
  const tomorrow = dateISO(new Date(Date.now() + 86400000));
  
  const upcoming = data.appts
    .filter(a => {
      const apptDate = dateISO(a.start);
      return apptDate === today || apptDate === tomorrow;
    })
    .sort((a, b) => new Date(a.start) - new Date(b.start))
    .slice(0, 5);
  
  if(upcoming.length === 0){
    container.innerHTML = `
      <div class="item">
        <div>
          <strong>Nenhum compromisso pr√≥ximo</strong>
          <div class="muted">Adicione compromissos para ver aqui.</div>
        </div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = "";
  upcoming.forEach(appt => {
    const customer = appt.customerId ? data.customers.find(c => c.id === appt.customerId) : null;
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div style="flex:1">
        <div class="split">
          <strong style="font-size:14px">${escapeHTML(appt.title || "Compromisso")}</strong>
          <span class="tag" style="font-size:11px">${timeHM(appt.start)}</span>
        </div>
        <div class="muted" style="font-size:12px; margin-top:2px">
          ${customer ? escapeHTML(customer.name) : "Sem cliente"} ‚Ä¢ ${formatDateHuman(appt.start)}
        </div>
      </div>
    `;
    container.appendChild(el);
  });
}

function renderPendingTasks(){
  const container = $("#pendingTasks");
  const pending = data.tasks
    .filter(t => !t.completed)
    .filter(t => t.priority === "high")
    .slice(0, 5);
  
  if(pending.length === 0){
    container.innerHTML = `
      <div class="item">
        <div>
          <strong>Nenhuma tarefa de alta prioridade</strong>
          <div class="muted">Tudo sob controle!</div>
        </div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = "";
  pending.forEach(task => {
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div style="flex:1">
        <div class="split">
          <strong style="font-size:14px">${escapeHTML(task.title)}</strong>
          <span class="task-priority high">ALTA</span>
        </div>
        ${task.dueDate ? `<div class="muted" style="font-size:12px; margin-top:2px">Vence: ${formatDateHuman(task.dueDate)}</div>` : ""}
      </div>
    `;
    container.appendChild(el);
  });
}

/* ---------- AI Insights ---------- */
function generateAIInsights(){
  const container = $("#aiInsights");
  container.innerHTML = "";
  
  if (!data || data.appts.length === 0 && data.tasks.length === 0) {
    container.innerHTML = `
      <div class="hint">
        Comece a usar o app para receber insights da IA. Adicione clientes, compromissos e tarefas.
      </div>
    `;
    return;
  }
  
  // Insight 1: Busy days
  const busyDays = analyzeBusyDays();
  if(busyDays.length > 0){
    const insight = document.createElement("div");
    insight.className = "insight";
    insight.innerHTML = `
      <div class="insight-header">
        <svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2zm0 16H5V9h14z"/></svg>
        <div class="insight-title">Dias Mais Ocupados</div>
      </div>
      <div class="insight-content">
        Voc√™ tem mais compromissos nas ${busyDays.slice(0,2).map(d => d.day).join(" e ")}. 
        Considere distribuir melhor sua agenda.
      </div>
    `;
    container.appendChild(insight);
  }
  
  // Insight 2: Task completion rate
  const completionRate = calculateCompletionRate();
  if(data.tasks.length > 0){
    const insightClass = completionRate >= 70 ? "good" : completionRate >= 40 ? "" : "warn";
    const insight = document.createElement("div");
    insight.className = `insight ${insightClass}`;
    insight.innerHTML = `
      <div class="insight-header ${insightClass}">
        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        <div class="insight-title">Taxa de Conclus√£o de Tarefas</div>
      </div>
      <div class="insight-content">
        ${completionRate}% das tarefas conclu√≠das. 
        ${completionRate >= 70 ? "Excelente produtividade!" : 
          completionRate >= 40 ? "Bom trabalho!" : "Tente focar em concluir mais tarefas."}
      </div>
    `;
    container.appendChild(insight);
  }
  
  // Insight 3: Upcoming deadlines
  const upcomingDeadlines = getUpcomingDeadlines();
  if(upcomingDeadlines.length > 0){
    const insight = document.createElement("div");
    insight.className = "insight warn";
    insight.innerHTML = `
      <div class="insight-header warn">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
        <div class="insight-title">Prazos Pr√≥ximos</div>
      </div>
      <div class="insight-content">
        ${upcomingDeadlines.length} tarefa(s) com prazo nos pr√≥ximos 3 dias. 
        N√£o deixe para a √∫ltima hora!
      </div>
    `;
    container.appendChild(insight);
  }
}

function analyzeBusyDays(){
  const dayCount = {};
  data.appts.forEach(appt => {
    const date = new Date(appt.start);
    const day = date.toLocaleDateString('pt-BR', { weekday: 'long' });
    dayCount[day] = (dayCount[day] || 0) + 1;
  });
  
  return Object.entries(dayCount)
    .map(([day, count]) => ({ day, count }))
    .sort((a, b) => b.count - a.count);
}

function calculateCompletionRate(){
  if(data.tasks.length === 0) return 0;
  const completed = data.tasks.filter(t => t.completed).length;
  return Math.round((completed / data.tasks.length) * 100);
}

function getUpcomingDeadlines(){
  const now = new Date();
  const threeDaysFromNow = new Date(now.getTime() + 3 * 86400000);
  
  return data.tasks.filter(task => {
    if(task.completed || !task.dueDate) return false;
    const dueDate = new Date(task.dueDate);
    return dueDate >= now && dueDate <= threeDaysFromNow;
  });
}

$("#refreshInsightsBtn").addEventListener("click", generateAIInsights);
$("#aiAnalyzeBtn").addEventListener("click", () => {
  generateAIInsights();
  toast("An√°lise atualizada pela IA");
});

/* ---------- Calendar System CORRIGIDO ---------- */
let calDate = new Date();
let calView = "month";
let selectedDate = new Date();

function renderCalendar(){
  const year = calDate.getFullYear();
  const month = calDate.getMonth();
  
  // Update label
  const monthNames = [
    "Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho",
    "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
  ];
  $("#calLabel").textContent = `${monthNames[month]} ${year}`;
  
  // Build calendar grid
  if(calView === "month"){
    renderMonthCalendar(year, month);
  }
}

function renderMonthCalendar(year, month){
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDay = firstDay.getDay(); // 0 = Domingo
  const daysInMonth = lastDay.getDate();
  
  // Days of week header
  const daysOfWeek = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];
  let html = `<div class="calGrid">`;
  
  // Header
  daysOfWeek.forEach(day => {
    html += `<div class="calHeadCell">${day}</div>`;
  });
  
  // Calculate previous month's days
  const prevMonthLastDay = new Date(year, month, 0).getDate();
  
  // Empty cells before first day
  for(let i = 0; i < startDay; i++){
    const day = prevMonthLastDay - (startDay - 1) + i;
    const date = new Date(year, month - 1, day);
    const dateStr = dateISO(date);
    html += renderCalendarCell(dateStr, day, "mutedDay");
  }
  
  // Current month days
  const todayStr = dateISO(new Date());
  const selectedStr = dateISO(selectedDate);
  
  for(let day = 1; day <= daysInMonth; day++){
    const date = new Date(year, month, day);
    const dateStr = dateISO(date);
    const isToday = dateStr === todayStr;
    const isSelected = dateStr === selectedStr;
    
    let className = "";
    if(isToday) className += " today";
    if(isSelected) className += " selected";
    if(date.getDay() === 0 || date.getDay() === 6) className += " mutedDay";
    
    html += renderCalendarCell(dateStr, day, className);
  }
  
  // Fill remaining cells
  const totalCells = 42; // 6 weeks
  const usedCells = startDay + daysInMonth;
  for(let i = 1; i <= (totalCells - usedCells); i++){
    const date = new Date(year, month + 1, i);
    const dateStr = dateISO(date);
    html += renderCalendarCell(dateStr, i, "mutedDay");
  }
  
  html += `</div>`;
  $("#calWrap").innerHTML = html;
  
  // Add click events
  $$(".calCell").forEach(cell => {
    cell.addEventListener("click", () => {
      const dateStr = cell.dataset.date;
      selectDate(dateStr);
      showDayDetails(dateStr);
    });
  });
}

function renderCalendarCell(dateStr, dayNumber, className = ""){
  // Get events for this day
  const appts = data.appts.filter(a => dateISO(a.start) === dateStr);
  const tasks = data.tasks.filter(t => t.dueDate && dateISO(t.dueDate) === dateStr && !t.completed);
  
  let html = `<div class="calCell ${className}" data-date="${dateStr}">`;
  html += `<div class="d">${dayNumber}</div>`;
  
  // Add event indicators
  if(appts.length > 0 || tasks.length > 0){
    html += `<div class="calEvents">`;
    
    // Show appointments
    appts.slice(0, 2).forEach(appt => {
      html += `<div class="calEvent" title="${escapeHTML(appt.title)}">
                <span class="calEventDot" style="background:var(--teal)"></span>
                ${appt.title.substring(0, 10)}${appt.title.length > 10 ? "..." : ""}
              </div>`;
    });
    
    // Show tasks
    tasks.slice(0, 1).forEach(task => {
      const color = task.priority === "high" ? "var(--bad)" : 
                   task.priority === "medium" ? "var(--warn)" : "var(--muted)";
      html += `<div class="calEvent task" title="${escapeHTML(task.title)}">
                <span class="calEventDot" style="background:${color}"></span>
                ${task.title.substring(0, 10)}${task.title.length > 10 ? "..." : ""}
              </div>`;
    });
    
    // Show more indicator
    const totalEvents = appts.length + tasks.length;
    if(totalEvents > 3){
      html += `<div class="calEvent" style="font-style:italic">+${totalEvents - 3} mais</div>`;
    }
    
    html += `</div>`;
  }
  
  html += `</div>`;
  return html;
}

function selectDate(dateStr){
  selectedDate = new Date(dateStr + "T12:00:00");
  
  // Update UI
  $$(".calCell.selected").forEach(c => c.classList.remove("selected"));
  $$(`.calCell[data-date="${dateStr}"]`).forEach(c => c.classList.add("selected"));
  
  // Show quick add buttons
  $("#quickAddSection").style.display = "grid";
}

function showDayDetails(dateStr){
  const date = new Date(dateStr + "T12:00:00");
  const formattedDate = formatDateHuman(dateStr);
  
  $("#dayDetailTitle").textContent = "Agenda do dia";
  $("#dayLabel").textContent = formattedDate;
  
  // Get appointments and tasks for this day
  const dayAppts = data.appts
    .filter(a => dateISO(a.start) === dateStr)
    .sort((a, b) => new Date(a.start) - new Date(b.start));
  
  const dayTasks = data.tasks.filter(t => 
    t.dueDate && dateISO(t.dueDate) === dateStr
  );
  
  const container = $("#dayAppts");
  container.innerHTML = "";
  
  if(dayAppts.length === 0 && dayTasks.length === 0){
    container.innerHTML = `
      <div class="item" style="text-align:center; padding:20px">
        <div><strong>Dia livre! üéâ</strong></div>
        <div class="muted" style="margin-top:8px">Nenhum compromisso ou tarefa para esta data.</div>
        <button class="btn good small" id="addToDayBtn" style="margin-top:12px">
          + Adicionar ao dia
        </button>
      </div>
    `;
    
    $("#addToDayBtn").addEventListener("click", () => {
      goTab("appointments");
      $("#apptDate").value = dateStr;
      $("#apptTime").value = "09:00";
    });
    return;
  }
  
  // Appointments
  if(dayAppts.length > 0){
    const apptHeader = document.createElement("div");
    apptHeader.className = "item";
    apptHeader.innerHTML = `<strong style="color:var(--teal)">üìÖ Compromissos (${dayAppts.length})</strong>`;
    container.appendChild(apptHeader);
    
    dayAppts.forEach(appt => {
      const customer = appt.customerId ? 
        data.customers.find(c => c.id === appt.customerId) : null;
      const startTime = timeHM(appt.start);
      
      const el = document.createElement("div");
      el.className = "dayEventItem";
      el.innerHTML = `
        <div class="split">
          <div>
            <span class="dayEventTime">${startTime}</span>
            <strong>${escapeHTML(appt.title)}</strong>
            <span class="dayEventType">${appt.duration || 30}min</span>
          </div>
          <div>
            <span class="tag" style="font-size:10px; padding:2px 6px">
              ${customer ? escapeHTML(customer.name) : "Sem cliente"}
            </span>
          </div>
        </div>
        ${appt.notes ? `
          <div class="muted" style="font-size:12px; margin-top:6px">
            ${escapeHTML(appt.notes.substring(0, 60))}${appt.notes.length > 60 ? "..." : ""}
          </div>
        ` : ""}
      `;
      
      el.addEventListener("click", () => {
        openAppointmentDetails(appt);
      });
      
      container.appendChild(el);
    });
  }
  
  // Tasks
  if(dayTasks.length > 0){
    const taskHeader = document.createElement("div");
    taskHeader.className = "item";
    taskHeader.innerHTML = `<strong style="color:var(--warn)">üìã Tarefas (${dayTasks.length})</strong>`;
    container.appendChild(taskHeader);
    
    dayTasks.forEach(task => {
      const el = document.createElement("div");
      el.className = "dayEventItem";
      el.innerHTML = `
        <div class="split">
          <div>
            <strong style="${task.completed ? "text-decoration:line-through; color:var(--muted)" : ""}">
              ${escapeHTML(task.title)}
            </strong>
            <span class="dayEventType ${task.priority || "low"}">
              ${task.priority === "high" ? "ALTA" : 
                task.priority === "medium" ? "M√âDIA" : "BAIXA"}
            </span>
          </div>
          <div>
            ${task.completed ? 
              `<span class="tag" style="background:var(--good); color:white">Conclu√≠da</span>` : 
              `<span class="tag warn">Pendente</span>`}
          </div>
        </div>
        ${task.description ? `
          <div class="muted" style="font-size:12px; margin-top:6px">
            ${escapeHTML(task.description.substring(0, 60))}${task.description.length > 60 ? "..." : ""}
          </div>
        ` : ""}
      `;
      
      el.addEventListener("click", () => {
        openTaskDetails(task);
      });
      
      container.appendChild(el);
    });
  }
  
  // Add more button
  const addMore = document.createElement("div");
  addMore.className = "item";
  addMore.style.textAlign = "center";
  addMore.innerHTML = `
    <button class="btn good small" id="addMoreToDayBtn">
      + Adicionar mais ao dia
    </button>
  `;
  container.appendChild(addMore);
  
  $("#addMoreToDayBtn").addEventListener("click", () => {
    goTab("appointments");
    $("#apptDate").value = dateStr;
    $("#apptTime").value = "09:00";
  });
}

function openAppointmentDetails(appt){
  const customer = appt.customerId ? 
    data.customers.find(c => c.id === appt.customerId) : null;
  const startDate = new Date(appt.start);
  const endDate = new Date(startDate.getTime() + (parseInt(appt.duration) || 30) * 60000);
  
  const details = `
    <div style="font-size:14px; line-height:1.6">
      <div style="background:linear-gradient(135deg, #e8f7fa, #d4f0f5); padding:12px; border-radius:10px; margin-bottom:16px">
        <strong style="font-size:16px; color:var(--teal2)">${escapeHTML(appt.title)}</strong>
        <div style="margin-top:8px">
          <div>üìÖ ${formatDateHuman(appt.start)}</div>
          <div>üïê ${timeHM(appt.start)} - ${timeHM(endDate)} (${appt.duration || 30} min)</div>
          ${customer ? `<div>üë§ ${escapeHTML(customer.name)}</div>` : ""}
        </div>
      </div>
      
      ${appt.notes ? `
        <div style="margin-bottom:16px">
          <strong>Notas:</strong>
          <div style="margin-top:4px; padding:8px; background:#f8fbfc; border-radius:8px">
            ${escapeHTML(appt.notes)}
          </div>
        </div>
      ` : ""}
    </div>
  `;
  
  openModal("Detalhes do Compromisso", details, [
    {label: "Fechar", variant: "secondary", onClick: closeModal},
    {label: "Editar", variant: "good", onClick: () => {
      closeModal();
      openApptEditor(appt);
    }},
    {label: "Excluir", variant: "bad", onClick: () => {
      closeModal();
      confirmDeleteAppt(appt);
    }}
  ]);
}

function openTaskDetails(task){
  const details = `
    <div style="font-size:14px; line-height:1.6">
      <div style="background:linear-gradient(135deg, ${task.completed ? "#e8fae8" : "#fff8e6"}, ${task.completed ? "#d4f5d4" : "#ffeed4"}); 
           padding:12px; border-radius:10px; margin-bottom:16px">
        <strong style="font-size:16px; ${task.completed ? "color:var(--good)" : "color:var(--warn)"}">
          ${escapeHTML(task.title)}
        </strong>
        <div style="margin-top:8px">
          ${task.dueDate ? `<div>üìÖ Vence: ${formatDateHuman(task.dueDate)}</div>` : ""}
          <div>üéØ Prioridade: ${task.priority === "high" ? "Alta" : 
                               task.priority === "medium" ? "M√©dia" : "Baixa"}</div>
          <div>${task.completed ? "‚úÖ Conclu√≠da" : "‚è≥ Pendente"}</div>
        </div>
      </div>
      
      ${task.description ? `
        <div style="margin-bottom:16px">
          <strong>Descri√ß√£o:</strong>
          <div style="margin-top:4px; padding:8px; background:#f8fbfc; border-radius:8px">
            ${escapeHTML(task.description)}
          </div>
        </div>
      ` : ""}
    </div>
  `;
  
  openModal("Detalhes da Tarefa", details, [
    {label: "Fechar", variant: "secondary", onClick: closeModal},
    task.completed ? 
      {label: "Marcar como Pendente", variant: "warn", onClick: () => {
        task.completed = false;
        task.updatedAt = nowISO();
        saveData(currentProfile.id, data);
        renderCalendar();
        renderTasks();
        toast("Tarefa reaberta!");
        closeModal();
      }} :
      {label: "Marcar como Conclu√≠da", variant: "good", onClick: () => {
        task.completed = true;
        task.updatedAt = nowISO();
        saveData(currentProfile.id, data);
        renderCalendar();
        renderTasks();
        toast("Tarefa conclu√≠da!");
        closeModal();
      }},
    {label: "Editar", variant: "good", onClick: () => {
      closeModal();
      openTaskEditor(task);
    }},
    {label: "Excluir", variant: "bad", onClick: () => {
      closeModal();
      confirmDeleteTask(task);
    }}
  ]);
}

// Calendar navigation
$("#calPrev").addEventListener("click", () => {
  if(calView === "month"){
    calDate.setMonth(calDate.getMonth() - 1);
  }
  renderCalendar();
});

$("#calNext").addEventListener("click", () => {
  if(calView === "month"){
    calDate.setMonth(calDate.getMonth() + 1);
  }
  renderCalendar();
});

$("#calView").addEventListener("change", () => {
  calView = $("#calView").value;
  renderCalendar();
});

// Quick add buttons
$("#quickAddAppt").addEventListener("click", () => {
  goTab("appointments");
  $("#apptDate").value = dateISO(selectedDate);
  $("#apptTime").value = "09:00";
  $("#apptTitle").focus();
});

$("#quickAddTask").addEventListener("click", () => {
  openTaskEditor(null, dateISO(selectedDate));
});

$("#quickAddReminder").addEventListener("click", () => {
  toast("Funcionalidade de lembrete em desenvolvimento");
});

$("#quickAddNote").addEventListener("click", () => {
  toast("Funcionalidade de notas em desenvolvimento");
});

// Today button
$("#todayPill").addEventListener("click", () => {
  calDate = new Date();
  selectedDate = new Date();
  renderCalendar();
  showDayDetails(dateISO(new Date()));
  toast("Voltando para hoje");
});

/* ---------- Hydrate UI ---------- */
function hydrateUI(){
  if(!currentProfile || !data) return;
  
  // Update who line
  $("#who").textContent = data.userName ? 
    `${data.userName} ‚Ä¢ Assistente Pessoal com IA` : 
    "Assistente Pessoal com IA";
  
  // Update today pill
  $("#todayPill").textContent = new Date().toLocaleDateString("pt-BR", {
    weekday: "short", 
    day: "2-digit", 
    month: "short"
  });
  
  // Update menu
  updateMenu();
  
  // Initialize forms
  initApptForm();
  
  // Render initial data
  renderDashboard();
  renderCustomers();
  renderAppts();
  renderTasks();
  renderInsights();
  
  // Initialize calendar
  renderCalendar();
  showDayDetails(dateISO(new Date()));
}

/* ---------- Startup ---------- */
function startup(){
  // Check if there's an active profile
  const activeProfileId = getActiveProfileId();
  const profiles = loadProfiles();
  
  if(activeProfileId && profiles.find(p => p.id === activeProfileId)){
    // Load active profile
    const profile = profiles.find(p => p.id === activeProfileId);
    currentProfile = profile;
    data = loadData(activeProfileId);
    showApp();
  } else {
    // Show profile selector (already visible by default)
    showProfileSelector();
  }
}

// Start the app
document.addEventListener("DOMContentLoaded", startup);

/* ---------- Utility Functions ---------- */
function escapeHTML(text){
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

function escapeAttr(text){
  return String(text).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

// Fun√ß√µes restantes do c√≥digo anterior (Customers, Appointments, Tasks, etc.)
// ... [O restante do c√≥digo JavaScript das fun√ß√µes CRUD permanece igual] ...

/* ---------- Customers CRUD ---------- */
function renderCustomers(){
  const q = ($("#customerSearch").value || "").trim().toLowerCase();
  const list = $("#customerList");
  list.innerHTML = "";
  const arr = data.customers
    .slice()
    .sort((a, b) => (a.name || "").localeCompare(b.name || ""))
    .filter(c => {
      if(!q) return true;
      return (c.name || "").toLowerCase().includes(q) ||
             (c.phone || "").toLowerCase().includes(q) ||
             (c.email || "").toLowerCase().includes(q);
    });

  if(arr.length === 0){
    list.innerHTML = `
      <div class="item">
        <div>
          <strong>Nenhum cliente</strong>
          <div class="muted">Crie seu primeiro cliente.</div>
        </div>
      </div>
    `;
    return;
  }

  for(const c of arr){
    const initials = (c.name || "?").trim()
      .split(/\s+/)
      .slice(0,2)
      .map(x => x[0]?.toUpperCase() || "")
      .join("");
    
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="profileBtn" style="border-color:#d7eef3;background:#eef7f9;color:#0b6c7a">
        ${initials || "?"}
      </div>
      <div style="flex:1; min-width:0">
        <div class="split">
          <strong style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
            ${escapeHTML(c.name || "Sem nome")}
          </strong>
          <div class="spacer"></div>
          <span class="tag">${(c.phone || "Sem telefone")}</span>
        </div>
        <div class="muted" style="font-size:13px; margin-top:2px">
          ${escapeHTML(c.email || "Sem email")}
        </div>
        ${c.notes ? `
          <div class="muted" style="font-size:12px; margin-top:6px">
            ${escapeHTML(c.notes)}
          </div>
        ` : ""}
        <div class="btnRow" style="margin-top:10px">
          <button class="btn small secondary" data-act="edit" data-id="${c.id}">Editar</button>
          <button class="btn small" data-act="newAppt" data-id="${c.id}">Agendar</button>
          <button class="btn small bad" data-act="del" data-id="${c.id}">Excluir</button>
        </div>
      </div>
    `;
    list.appendChild(el);
  }

  $$("[data-act]", list).forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.id;
      const act = btn.dataset.act;
      const c = data.customers.find(x => x.id === id);
      if(!c) return;
      
      if(act === "edit") openCustomerEditor(c);
      if(act === "del") confirmDeleteCustomer(c);
      if(act === "newAppt"){
        goTab("appointments");
        $("#apptCustomer").value = c.id;
        syncApptFormFromCustomer();
        $("#apptTitle").focus();
      }
    });
  });
}

function openCustomerEditor(c = null){
  const isNew = !c;
  const obj = c ? {...c} : {
    id: uid("cus"),
    name: "",
    phone: "",
    email: "",
    notes: ""
  };
  
  openModal(isNew ? "Novo Cliente" : "Editar Cliente", `
    <label>Nome</label>
    <input class="input" id="mName" value="${escapeAttr(obj.name)}">
    
    <label>Telefone</label>
    <input class="input" id="mPhone" value="${escapeAttr(obj.phone)}" placeholder="(DDD) n√∫mero">
    
    <label>Email</label>
    <input class="input" id="mEmail" value="${escapeAttr(obj.email)}" placeholder="email@dominio.com">
    
    <label>Notas</label>
    <textarea id="mNotes">${escapeHTML(obj.notes || "")}</textarea>
  `, [
    {label: "Cancelar", variant: "secondary", onClick: closeModal},
    {label: isNew ? "Criar" : "Atualizar", variant: "good", onClick: () => {
      const updated = {
        id: obj.id,
        name: $("#mName").value.trim(),
        phone: $("#mPhone").value.trim(),
        email: $("#mEmail").value.trim().toLowerCase(),
        notes: $("#mNotes").value.trim(),
        updatedAt: nowISO()
      };
      
      if(!updated.name){
        toast("Nome √© obrigat√≥rio.");
        return;
      }
      
      if(isNew){
        updated.createdAt = nowISO();
        data.customers.push(updated);
        toast("Cliente adicionado.");
      } else {
        const idx = data.customers.findIndex(x => x.id === obj.id);
        if(idx >= 0) data.customers[idx] = updated;
        toast("Cliente atualizado.");
      }
      
      saveData(currentProfile.id, data);
      renderCustomers();
      closeModal();
    }}
  ]);
}

function confirmDeleteCustomer(c){
  openModal("Excluir Cliente", `
    <p>Tem certeza que deseja excluir <strong>${escapeHTML(c.name)}</strong>?</p>
    <p>Esta a√ß√£o n√£o pode ser desfeita.</p>
  `, [
    {label: "Cancelar", variant: "secondary", onClick: closeModal},
    {label: "Excluir", variant: "bad", onClick: () => {
      data.customers = data.customers.filter(x => x.id !== c.id);
      // Also delete appointments linked to this customer
      data.appts = data.appts.filter(a => a.customerId !== c.id);
      saveData(currentProfile.id, data);
      renderCustomers();
      toast("Cliente exclu√≠do.");
      closeModal();
    }}
  ]);
}

$("#customerSearch").addEventListener("input", () => renderCustomers());
$("#addCustomerBtn").addEventListener("click", () => openCustomerEditor());

/* ---------- Appointments CRUD ---------- */
function renderAppts(){
  const list = $("#apptList");
  list.innerHTML = "";
  const now = new Date();
  const arr = data.appts.slice().sort((a, b) => new Date(a.start) - new Date(b.start));
  
  if(arr.length === 0){
    list.innerHTML = `
      <div class="item">
        <div>
          <strong>Nenhum compromisso</strong>
          <div class="muted">Crie seu primeiro agendamento.</div>
        </div>
      </div>
    `;
    return;
  }
  
  for(const a of arr){
    const c = a.customerId ? data.customers.find(x => x.id === a.customerId) : null;
    const start = new Date(a.start);
    const end = new Date(start.getTime() + (parseInt(a.duration) || 30) * 60000);
    const past = end < now;
    
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div style="flex:1">
        <div class="split">
          <strong style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
            ${escapeHTML(a.title || "Compromisso")}
          </strong>
          <div class="spacer"></div>
          <span class="tag ${past ? "muted" : "good"}">${timeHM(start)}</span>
        </div>
       <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap; margin-top:4px">
          <span class="muted" style="font-size:12px">${c ? escapeHTML(c.name) : "Sem cliente"}</span>
          <span style="opacity:.6">‚Ä¢</span>
          <span class="muted" style="font-size:12px">${formatDateHuman(a.start)}</span>
          <span style="opacity:.6">‚Ä¢</span>
          <span class="muted" style="font-size:12px">Dura√ß√£o: ${a.duration || 30} min</span>
        </div>
        ${a.notes ? `
          <div class="muted" style="font-size:12px; margin-top:6px">
            ${escapeHTML(a.notes)}
          </div>
        ` : ""}
        <div class="btnRow" style="margin-top:10px">
          <button class="btn small secondary" data-act="edit" data-id="${a.id}">Editar</button>
          <button class="btn small ${past ? "secondary" : "warn"}" data-act="remind" data-id="${a.id}">Lembrar</button>
          <button class="btn small bad" data-act="del" data-id="${a.id}">Excluir</button>
        </div>
      </div>
    `;
    list.appendChild(el);
  }
  
  $$("[data-act]", list).forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.id;
      const act = btn.dataset.act;
      const a = data.appts.find(x => x.id === id);
      if(!a) return;
      
      if(act === "edit") openApptEditor(a);
      if(act === "del") confirmDeleteAppt(a);
      if(act === "remind") sendReminder(a);
    });
  });
}

function syncApptFormFromCustomer(){
  const cid = $("#apptCustomer").value;
  if(!cid){
    $("#apptPhone").value = "";
    $("#apptEmail").value = "";
    return;
  }
  const c = data.customers.find(x => x.id === cid);
  if(c){
    $("#apptPhone").value = c.phone || "";
    $("#apptEmail").value = c.email || "";
  }
}

function openApptEditor(a = null){
  const isNew = !a;
  const obj = a ? {...a} : {
    id: uid("appt"),
    customerId: "",
    title: "",
    start: new Date().toISOString(),
    duration: "30",
    reminder: "email",
    phone: "",
    email: "",
    notes: ""
  };
  
  openModal(isNew ? "Novo Agendamento" : "Editar Agendamento", `
    <label>Cliente</label>
    <select class="input" id="mApptCustomer"></select>
    
    <label>Tipo de lembrete</label>
    <div class="seg" role="group" aria-label="Reminder Type">
      <button type="button" ${obj.reminder === "email" ? 'class="active"' : ''} data-rem="email">Email</button>
      <button type="button" ${obj.reminder === "sms" ? 'class="active"' : ''} data-rem="sms">SMS</button>
      <button type="button" ${obj.reminder === "both" ? 'class="active"' : ''} data-rem="both">Ambos</button>
      <button type="button" ${obj.reminder === "none" ? 'class="active"' : ''} data-rem="none">Nenhum</button>
    </div>
    
    <div class="row">
      <div class="col">
        <label>Telefone</label>
        <input class="input" id="mApptPhone" value="${escapeAttr(obj.phone || "")}" placeholder="(DDD) n√∫mero">
      </div>
      <div class="col">
        <label>Email</label>
        <input class="input" id="mApptEmail" value="${escapeAttr(obj.email || "")}" placeholder="cliente@dominio.com">
      </div>
    </div>
    
    <label>T√≠tulo</label>
    <input class="input" id="mApptTitle" value="${escapeAttr(obj.title)}" placeholder="Ex.: Corte de cabelo, Reuni√£o, Consulta...">
    
    <div class="row">
      <div class="col">
        <label>Data</label>
        <input class="input" id="mApptDate" type="date" value="${dateISO(obj.start)}">
      </div>
      <div class="col">
        <label>Hora</label>
        <input class="input" id="mApptTime" type="time" value="${timeHM(obj.start)}">
      </div>
      <div class="col">
        <label>Dura√ß√£o</label>
        <select class="input" id="mApptDuration">
          <option value="15" ${obj.duration === "15" ? "selected" : ""}>15 min</option>
          <option value="30" ${obj.duration === "30" ? "selected" : ""}>30 min</option>
          <option value="45" ${obj.duration === "45" ? "selected" : ""}>45 min</option>
          <option value="60" ${obj.duration === "60" ? "selected" : ""}>60 min</option>
          <option value="90" ${obj.duration === "90" ? "selected" : ""}>90 min</option>
          <option value="120" ${obj.duration === "120" ? "selected" : ""}>120 min</option>
        </select>
      </div>
    </div>
    
    <label>Notas</label>
    <textarea id="mApptNotes">${escapeHTML(obj.notes || "")}</textarea>
    
    <div class="hint" id="mConflictHint" style="display:none"></div>
  `, [
    {label: "Cancelar", variant: "secondary", onClick: closeModal},
    {label: isNew ? "Criar" : "Atualizar", variant: "good", onClick: () => {
      // Gather data
      const customerId = $("#mApptCustomer").value;
      const phone = $("#mApptPhone").value.trim();
      const email = $("#mApptEmail").value.trim();
      const title = $("#mApptTitle").value.trim();
      const dateStr = $("#mApptDate").value;
      const timeStr = $("#mApptTime").value;
      const duration = $("#mApptDuration").value;
      const notes = $("#mApptNotes").value.trim();
      const reminder = $(".seg button.active", $("#modalBody")).dataset.rem;
      
      // Validation
      if(!title){
        toast("T√≠tulo √© obrigat√≥rio.");
        return;
      }
      if(!dateStr || !timeStr){
        toast("Data e hora s√£o obrigat√≥rias.");
        return;
      }
      
      // Create ISO date
      const start = new Date(dateStr + "T" + timeStr);
      const startISO = start.toISOString();
      
      // Check for conflicts
      const conflict = checkScheduleConflict(startISO, parseInt(duration), a?.id);
      if(conflict){
        $("#mConflictHint").style.display = "block";
        $("#mConflictHint").innerHTML = `‚ö†Ô∏è Conflito com: <strong>${conflict.title}</strong> (${formatDateTimeHuman(conflict.start)})`;
        return;
      }
      
      // Build appointment object
      const updated = {
        id: obj.id,
        customerId,
        title,
        start: startISO,
        duration,
        reminder,
        phone,
        email,
        notes,
        updatedAt: nowISO()
      };
      
      if(isNew){
        updated.createdAt = nowISO();
        data.appts.push(updated);
        toast("Compromisso criado.");
      } else {
        const idx = data.appts.findIndex(x => x.id === obj.id);
        if(idx >= 0) data.appts[idx] = updated;
        toast("Compromisso atualizado.");
      }
      
      saveData(currentProfile.id, data);
      renderAppts();
      renderDashboard();
      renderCalendar();
      closeModal();
    }}
  ]);
  
  // Populate customer dropdown
  const customerSelect = $("#mApptCustomer");
  customerSelect.innerHTML = `<option value="">Selecionar cliente</option>`;
  data.customers.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = `${c.name} (${c.phone || "sem telefone"})`;
    if(c.id === obj.customerId) opt.selected = true;
    customerSelect.appendChild(opt);
  });
  
  // Reminder buttons
  $$(".seg button", $("#modalBody")).forEach(btn => {
    btn.addEventListener("click", () => {
      $$(".seg button", $("#modalBody")).forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    });
  });
  
  // Check conflicts on change
  const checkConflicts = () => {
    const dateStr = $("#mApptDate").value;
    const timeStr = $("#mApptTime").value;
    const duration = $("#mApptDuration").value;
    if(!dateStr || !timeStr) return;
    
    const start = new Date(dateStr + "T" + timeStr);
    const startISO = start.toISOString();
    const conflict = checkScheduleConflict(startISO, parseInt(duration), a?.id);
    
    if(conflict){
      $("#mConflictHint").style.display = "block";
      $("#mConflictHint").innerHTML = `‚ö†Ô∏è Conflito com: <strong>${conflict.title}</strong> (${formatDateTimeHuman(conflict.start)})`;
    } else {
      $("#mConflictHint").style.display = "none";
    }
  };
  
  $("#mApptDate").addEventListener("change", checkConflicts);
  $("#mApptTime").addEventListener("change", checkConflicts);
  $("#mApptDuration").addEventListener("change", checkConflicts);
}

function checkScheduleConflict(startISO, durationMinutes, excludeId = null){
  const start = new Date(startISO);
  const end = new Date(start.getTime() + durationMinutes * 60000);
  
  for(const appt of data.appts){
    if(appt.id === excludeId) continue;
    const apptStart = new Date(appt.start);
    const apptEnd = new Date(apptStart.getTime() + (parseInt(appt.duration) || 30) * 60000);
    
    if(start < apptEnd && end > apptStart){
      return appt;
    }
  }
  return null;
}

function confirmDeleteAppt(a){
  openModal("Excluir Compromisso", `
    <p>Tem certeza que deseja excluir <strong>${escapeHTML(a.title)}</strong>?</p>
    <p>Agendado para ${formatDateTimeHuman(a.start)}.</p>
  `, [
    {label: "Cancelar", variant: "secondary", onClick: closeModal},
    {label: "Excluir", variant: "bad", onClick: () => {
      data.appts = data.appts.filter(x => x.id !== a.id);
      saveData(currentProfile.id, data);
      renderAppts();
      renderDashboard();
      renderCalendar();
      toast("Compromisso exclu√≠do.");
      closeModal();
    }}
  ]);
}

function sendReminder(appt){
  const c = appt.customerId ? data.customers.find(x => x.id === appt.customerId) : null;
  const name = c ? c.name : "Cliente";
  const channel = appt.reminder || "email";
  
  if(channel === "none"){
    toast("Este compromisso n√£o tem lembrete configurado.");
    return;
  }
  
  toast(`üì® Lembrete enviado para ${name} via ${channel.toUpperCase()}`);
}

// Appointment form initialization
function initApptForm(){
  // Populate customer dropdown
  const select = $("#apptCustomer");
  select.innerHTML = `<option value="">Selecionar cliente</option>`;
  data.customers.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = `${c.name} (${c.phone || "sem telefone"})`;
    select.appendChild(opt);
  });
  
  // Set today as default date
  $("#apptDate").value = dateISO(new Date());
  $("#apptTime").value = "09:00";
  
  // Reminder buttons
  $$(".seg button", $("#page-appointments")).forEach(btn => {
    btn.addEventListener("click", () => {
      $$(".seg button", $("#page-appointments")).forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    });
  });
  
  // Customer change
  select.addEventListener("change", syncApptFormFromCustomer);
  
  // Save button
  $("#saveApptBtn").addEventListener("click", () => {
    // Gather data
    const customerId = $("#apptCustomer").value;
    const reminder = $(".seg button.active", $("#page-appointments")).dataset.rem;
    const phone = $("#apptPhone").value.trim();
    const email = $("#apptEmail").value.trim();
    const title = $("#apptTitle").value.trim();
    const dateStr = $("#apptDate").value;
    const timeStr = $("#apptTime").value;
    const duration = $("#apptDuration").value;
    const notes = $("#apptNotes").value.trim();
    
    // Validation
    if(!title){
      toast("T√≠tulo √© obrigat√≥rio.");
      return;
    }
    if(!dateStr || !timeStr){
      toast("Data e hora s√£o obrigat√≥rias.");
      return;
    }
    
    // Create ISO date
    const start = new Date(dateStr + "T" + timeStr);
    const startISO = start.toISOString();
    
    // Check for conflicts
    const conflict = checkScheduleConflict(startISO, parseInt(duration));
    if(conflict){
      $("#conflictHint").style.display = "block";
      $("#conflictHint").innerHTML = `‚ö†Ô∏è Conflito com: <strong>${conflict.title}</strong> (${formatDateTimeHuman(conflict.start)})`;
      return;
    }
    
    // Create appointment
    const appt = {
      id: uid("appt"),
      customerId,
      title,
      start: startISO,
      duration,
      reminder,
      phone,
      email,
      notes,
      createdAt: nowISO(),
      updatedAt: nowISO()
    };
    
    data.appts.push(appt);
    saveData(currentProfile.id, data);
    
    // Reset form
    $("#apptTitle").value = "";
    $("#apptPhone").value = "";
    $("#apptEmail").value = "";
    $("#apptNotes").value = "";
    $("#conflictHint").style.display = "none";
    
    toast("Compromisso criado!");
    renderAppts();
    renderDashboard();
    renderCalendar();
  });
  
  // Clear button
  $("#clearApptBtn").addEventListener("click", () => {
    $("#apptCustomer").value = "";
    $("#apptPhone").value = "";
    $("#apptEmail").value = "";
    $("#apptTitle").value = "";
    $("#apptNotes").value = "";
    $("#conflictHint").style.display = "none";
    $$(".seg button", $("#page-appointments")).forEach(b => b.classList.remove("active"));
    $$(".seg button", $("#page-appointments"))[0].classList.add("active");
  });
  
  // AI schedule button
  $("#aiScheduleBtn").addEventListener("click", () => {
    const now = new Date();
    const tomorrow = dateISO(new Date(now.getTime() + 86400000));
    const availableSlots = [];
    
    // Check tomorrow's available slots (9 AM to 5 PM)
    for(let hour = 9; hour <= 17; hour++){
      const time = `${hour.toString().padStart(2, "0")}:00`;
      const startISO = new Date(tomorrow + "T" + time).toISOString();
      if(!checkScheduleConflict(startISO, 30)){
        availableSlots.push(time);
        if(availableSlots.length >= 3) break;
      }
    }
    
    if(availableSlots.length > 0){
      toast(`IA sugere amanh√£ √†s: ${availableSlots.join(", ")}`);
      $("#apptDate").value = tomorrow;
      $("#apptTime").value = availableSlots[0];
    } else {
      toast("IA: Nenhum hor√°rio dispon√≠vel amanh√£. Tente outro dia.");
    }
  });
}

/* ---------- Tasks CRUD ---------- */
function renderTasks(){
  const filter = $("#taskFilter").value;
  const sort = $("#taskSort").value;
  const search = ($("#taskSearch").value || "").trim().toLowerCase();
  
  let arr = data.tasks.slice();
  
  // Filter
  if(filter === "pending") arr = arr.filter(t => !t.completed);
  if(filter === "completed") arr = arr.filter(t => t.completed);
  if(filter === "today"){
    const today = dateISO(new Date());
    arr = arr.filter(t => dateISO(t.dueDate) === today);
  }
  if(filter === "high") arr = arr.filter(t => t.priority === "high");
  
  // Search
  if(search){
    arr = arr.filter(t => 
      (t.title || "").toLowerCase().includes(search) ||
      (t.description || "").toLowerCase().includes(search)
    );
  }
  
  // Sort
  if(sort === "due"){
    arr.sort((a, b) => {
      if(a.dueDate && b.dueDate) return new Date(a.dueDate) - new Date(b.dueDate);
      if(a.dueDate) return -1;
      if(b.dueDate) return 1;
      return 0;
    });
  }
  if(sort === "priority"){
    const priorityOrder = {high: 0, medium: 1, low: 2};
    arr.sort((a, b) => {
      const pa = priorityOrder[a.priority || "low"];
      const pb = priorityOrder[b.priority || "low"];
      if(pa !== pb) return pa - pb;
      return new Date(a.createdAt) - new Date(b.createdAt);
    });
  }
  if(sort === "created"){
    arr.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  }
  
  // Render
  const list = $("#taskList");
  list.innerHTML = "";
  
  if(arr.length === 0){
    list.innerHTML = `
      <div class="item">
        <div>
          <strong>Nenhuma tarefa</strong>
          <div class="muted">Crie sua primeira tarefa.</div>
        </div>
      </div>
    `;
    return;
  }
  
  for(const t of arr){
    const el = document.createElement("div");
    el.className = "task-item";
    el.innerHTML = `
      <div class="task-check ${t.completed ? "checked" : ""}" data-id="${t.id}"></div>
      <div class="task-content">
        <div class="split">
          <div class="task-title ${t.completed ? "muted" : ""}" style="${t.completed ? "text-decoration:line-through" : ""}">
            ${escapeHTML(t.title)}
          </div>
          <span class="task-priority ${t.priority || "low"}">
            ${t.priority === "high" ? "ALTA" : t.priority === "medium" ? "M√âDIA" : "BAIXA"}
          </span>
        </div>
        ${t.description ? `
          <div class="task-desc">${escapeHTML(t.description)}</div>
        ` : ""}
        ${t.dueDate ? `
          <div class="task-due">Vence: ${formatDateHuman(t.dueDate)}</div>
        ` : ""}
      </div>
      <div>
        <button class="btn small secondary" data-act="edit" data-id="${t.id}">Editar</button>
        <button class="btn small bad" data-act="del" data-id="${t.id}">Excluir</button>
      </div>
    `;
    list.appendChild(el);
  }
  
  // Toggle completion
  $$(".task-check", list).forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.id;
      const task = data.tasks.find(x => x.id === id);
      if(task){
        task.completed = !task.completed;
        task.updatedAt = nowISO();
        saveData(currentProfile.id, data);
        renderTasks();
        renderDashboard();
        renderCalendar();
        toast(task.completed ? "Tarefa conclu√≠da!" : "Tarefa reaberta.");
      }
    });
  });
  
  // Edit/Delete buttons
  $$("[data-act]", list).forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.dataset.id;
      const act = btn.dataset.act;
      const task = data.tasks.find(x => x.id === id);
      if(!task) return;
      
      if(act === "edit") openTaskEditor(task);
      if(act === "del") confirmDeleteTask(task);
    });
  });
  
  // Generate AI suggestions
  generateTaskSuggestions();
}

function openTaskEditor(t = null, dueDateStr = null){
  const isNew = !t;
  const obj = t ? {...t} : {
    id: uid("task"),
    title: "",
    description: "",
    dueDate: dueDateStr || dateISO(new Date()),
    priority: "medium",
    completed: false,
    tags: []
  };
  
  const dueDateValue = obj.dueDate ? dateISO(new Date(obj.dueDate)) : "";
  
  openModal(isNew ? "Nova Tarefa" : "Editar Tarefa", `
    <label>T√≠tulo</label>
    <input class="input" id="mTaskTitle" value="${escapeAttr(obj.title)}" placeholder="O que precisa fazer?">
    
    <label>Descri√ß√£o</label>
    <textarea id="mTaskDesc">${escapeHTML(obj.description || "")}</textarea>
    
    <div class="row">
      <div class="col">
        <label>Data de Vencimento</label>
        <input class="input" id="mTaskDue" type="date" value="${dueDateValue}">
      </div>
      <div class="col">
        <label>Prioridade</label>
        <select class="input" id="mTaskPriority">
          <option value="low" ${obj.priority === "low" ? "selected" : ""}>Baixa</option>
          <option value="medium" ${obj.priority === "medium" ? "selected" : ""}>M√©dia</option>
          <option value="high" ${obj.priority === "high" ? "selected" : ""}>Alta</option>
        </select>
      </div>
    </div>
  `, [
    {label: "Cancelar", variant: "secondary", onClick: closeModal},
    {label: isNew ? "Criar" : "Atualizar", variant: "good", onClick: () => {
      const title = $("#mTaskTitle").value.trim();
      const description = $("#mTaskDesc").value.trim();
      const dueDate = $("#mTaskDue").value;
      const priority = $("#mTaskPriority").value;
      
      if(!title){
        toast("T√≠tulo √© obrigat√≥rio.");
        return;
      }
      
      const updated = {
        id: obj.id,
        title,
        description,
        dueDate: dueDate || null,
        priority,
        completed: obj.completed || false,
        updatedAt: nowISO()
      };
      
      if(isNew){
        updated.createdAt = nowISO();
        data.tasks.push(updated);
        toast("Tarefa criada.");
      } else {
        const idx = data.tasks.findIndex(x => x.id === obj.id);
        if(idx >= 0) data.tasks[idx] = updated;
        toast("Tarefa atualizada.");
      }
      
      saveData(currentProfile.id, data);
      renderTasks();
      renderDashboard();
      renderCalendar();
      closeModal();
    }}
  ]);
}

function confirmDeleteTask(t){
  openModal("Excluir Tarefa", `
    <p>Tem certeza que deseja excluir <strong>${escapeHTML(t.title)}</strong>?</p>
  `, [
    {label: "Cancelar", variant: "secondary", onClick: closeModal},
    {label: "Excluir", variant: "bad", onClick: () => {
      data.tasks = data.tasks.filter(x => x.id !== t.id);
      saveData(currentProfile.id, data);
      renderTasks();
      renderDashboard();
      renderCalendar();
      toast("Tarefa exclu√≠da.");
      closeModal();
    }}
  ]);
}

function generateTaskSuggestions(){
  const container = $("#taskSuggestions");
  container.innerHTML = "";
  
  // Suggest based on due dates
  const overdueTasks = data.tasks.filter(t => 
    !t.completed && 
    t.dueDate && 
    new Date(t.dueDate) < new Date()
  );
  
  if(overdueTasks.length > 0){
    const div = document.createElement("div");
    div.className = "insight warn";
    div.innerHTML = `
      <div class="insight-header warn">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
        <div class="insight-title">Tarefas Atrasadas</div>
      </div>
      <div class="insight-content">
        Voc√™ tem ${overdueTasks.length} tarefa(s) atrasada(s). 
        Considere renegociar prazos ou priorizar.
      </div>
    `;
    container.appendChild(div);
  }
  
  // If no suggestions
  if(container.children.length === 0){
    container.innerHTML = `
      <div class="hint">
        Continue usando o app para receber sugest√µes personalizadas da IA.
      </div>
    `;
  }
}

$("#taskFilter").addEventListener("change", renderTasks);
$("#taskSort").addEventListener("change", renderTasks);
$("#taskSearch").addEventListener("input", renderTasks);
$("#addTaskBtn").addEventListener("click", () => openTaskEditor());

/* ---------- AI Chat ---------- */
function setChatOpen(open){
  const chat = $("#chat");
  if(open) chat.classList.add("open");
  else chat.classList.remove("open");
}

$("#fab").addEventListener("click", () => setChatOpen(true));
$("#chatClose").addEventListener("click", () => setChatOpen(false));

function addChatMessage(content, isUser = false){
  const bubble = document.createElement("div");
  bubble.className = `bubble ${isUser ? "me" : "ai"}`;
  bubble.textContent = content;
  $("#chatBody").appendChild(bubble);
  $("#chatBody").scrollTop = $("#chatBody").scrollHeight;
}

$("#chatSend").addEventListener("click", () => {
  const input = $("#chatIn");
  const text = input.value.trim();
  if(!text) return;
  
  addChatMessage(text, true);
  input.value = "";
  
  // Process AI response
  setTimeout(() => {
    const response = processAIQuery(text);
    addChatMessage(response);
  }, 500);
});

$("#chatIn").addEventListener("keydown", (e) => {
  if(e.key === "Enter"){
    e.preventDefault();
    $("#chatSend").click();
  }
});

function processAIQuery(query){
  query = query.toLowerCase();
  
  // Simple AI responses
  if(query.includes("ol√°") || query.includes("oi") || query.includes("bom dia")){
    return `Ol√°! Eu sou seu assistente K‚ÄëGenda IA. Como posso ajud√°-lo hoje?\n\nPosso ajud√°-lo a:\n‚Ä¢ Agendar compromissos\n‚Ä¢ Criar tarefas\n‚Ä¢ Analisar sua produtividade\n‚Ä¢ Sugerir hor√°rios\n‚Ä¢ Responder perguntas sobre seus dados`;
  }
  
  if(query.includes("agendar") || query.includes("marcar")){
    return `Para agendar um compromisso, v√° para a aba "Agendamentos" ou me informe:\n‚Ä¢ Nome do cliente\n‚Ä¢ Data e hora\n‚Ä¢ T√≠tulo do compromisso\n\nPor exemplo: "Agendar reuni√£o com Jo√£o amanh√£ √†s 14h"`;
  }
  
  if(query.includes("tarefa") || query.includes("to-do")){
    return `Para criar uma tarefa, v√° para a aba "Tarefas" ou me informe:\n‚Ä¢ T√≠tulo da tarefa\n‚Ä¢ Prioridade (alta, m√©dia, baixa)\n‚Ä¢ Data de vencimento\n\nPor exemplo: "Criar tarefa de alta prioridade: preparar relat√≥rio at√© sexta"`;
  }
  
  if(query.includes("compromisso") && query.includes("pr√≥ximo")){
    const upcoming = data.appts
      .filter(a => new Date(a.start) > new Date())
      .sort((a, b) => new Date(a.start) - new Date(b.start))
      .slice(0, 3);
    
    if(upcoming.length === 0){
      return "Voc√™ n√£o tem compromissos futuros agendados.";
    }
    
    let response = "Seus pr√≥ximos compromissos:\n";
    upcoming.forEach(appt => {
      response += `‚Ä¢ ${appt.title} - ${formatDateTimeHuman(appt.start)}\n`;
    });
    return response;
  }
  
  if(query.includes("tarefa") && query.includes("pendente")){
    const pending = data.tasks.filter(t => !t.completed).length;
    return `Voc√™ tem ${pending} tarefas pendentes no momento.`;
  }
  
  if(query.includes("cliente") && query.includes("quantos")){
    return `Voc√™ tem ${data.customers.length} clientes cadastrados.`;
  }
  
  // Default response
  return `Entendi sua pergunta: "${query}"\n\nPara a√ß√µes espec√≠ficas, v√° para a aba correspondente:\n‚Ä¢ "Agendamentos" para compromissos\n‚Ä¢ "Tarefas" para atividades\n‚Ä¢ "Clientes" para gerenciamento\n‚Ä¢ "Insights" para an√°lises\n\nOu fa√ßa uma pergunta mais espec√≠fica sobre seus dados.`;
}

/* ---------- Insights ---------- */
function renderInsights(){
  if (!data) return;
  
  // Update KPIs
  const busyDays = analyzeBusyDays();
  $("#insightBusyDays").textContent = busyDays[0]?.day || "‚Äî";
  $("#insightTopClients").textContent = data.customers.length;
  $("#insightCompletion").textContent = calculateCompletionRate() + "%";
  
  // Advanced insights
  generateAdvancedInsights();
}

function generateAdvancedInsights(){
  const container = $("#advancedInsights");
  container.innerHTML = "";
  
  // Customer frequency
  if(data.appts.length > 0){
    const customerFrequency = {};
    data.appts.forEach(appt => {
      if(appt.customerId){
        customerFrequency[appt.customerId] = (customerFrequency[appt.customerId] || 0) + 1;
      }
    });
    
    const topCustomers = Object.entries(customerFrequency)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3)
      .map(([id, count]) => {
        const customer = data.customers.find(c => c.id === id);
        return customer ? {name: customer.name, count} : null;
      })
      .filter(c => c);
    
    if(topCustomers.length > 0){
      const div = document.createElement("div");
      div.className = "insight";
      div.innerHTML = `
        <div class="insight-header">
          <svg viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0-4-4a4 4 0 0 0 4 4Zm0 2c-3.33 0-8 1.67-8 5v1h16v-1c0-3.33-4.67-5-8-5Z"/></svg>
          <div class="insight-title">Clientes Frequentes</div>
        </div>
        <div class="insight-content">
          ${topCustomers.map(c => `${c.name} (${c.count} compromissos)`).join(", ")}
        </div>
      `;
      container.appendChild(div);
    }
  }
  
  // Task completion trend
  if(data.tasks.length > 5){
    const completedThisWeek = data.tasks.filter(t => 
      t.completed && 
      t.updatedAt && 
      new Date(t.updatedAt) > new Date(Date.now() - 7 * 86400000)
    ).length;
    
    const div = document.createElement("div");
    div.className = "insight good";
    div.innerHTML = `
      <div class="insight-header good">
        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        <div class="insight-title">Produtividade Semanal</div>
      </div>
      <div class="insight-content">
        Voc√™ completou ${completedThisWeek} tarefas nos √∫ltimos 7 dias. Continue assim!
      </div>
    `;
    container.appendChild(div);
  }
}

$("#generateReportBtn").addEventListener("click", () => {
  openModal("Relat√≥rio de Produtividade", `
    <div style="font-size:14px; line-height:1.6">
      <h3 style="margin-top:0">Relat√≥rio K‚ÄëGenda IA</h3>
      <p><strong>Perfil:</strong> ${escapeHTML(currentProfile.profileName)}</p>
      <p><strong>Data:</strong> ${new Date().toLocaleDateString("pt-BR")}</p>
      <hr style="border:none; border-top:1px solid var(--line); margin:12px 0">
      <p><strong>Clientes cadastrados:</strong> ${data.customers.length}</p>
      <p><strong>Compromissos agendados:</strong> ${data.appts.length}</p>
      <p><strong>Tarefas:</strong> ${data.tasks.filter(t => !t.completed).length} pendentes, ${data.tasks.filter(t => t.completed).length} conclu√≠das</p>
      <p><strong>Taxa de conclus√£o:</strong> ${calculateCompletionRate()}%</p>
      <hr style="border:none; border-top:1px solid var(--line); margin:12px 0">
      <p><strong>Recomenda√ß√µes da IA:</strong></p>
      <ul style="margin:8px 0; padding-left:16px">
        <li>Mantenha sua taxa de conclus√£o acima de 70%</li>
        <li>Agende compromissos com pelo menos 24h de anteced√™ncia</li>
        <li>Revise tarefas pendentes diariamente</li>
        <li>Use os insights da IA para otimizar sua agenda</li>
      </ul>
    </div>
  `, [
    {label: "Fechar", variant: "secondary", onClick: closeModal},
    {label: "Exportar PDF", variant: "ai", onClick: () => {
      toast("Em uma vers√£o completa, isso geraria um PDF para download.");
      closeModal();
    }}
  ]);
});

// Insight chat
$("#askInsightQueryBtn").addEventListener("click", () => {
  const query = $("#insightQuery").value.trim();
  if(!query) return;
  
  const chat = $("#insightChat");
  const bubble = document.createElement("div");
  bubble.className = "bubble me";
  bubble.textContent = query;
  chat.appendChild(bubble);
  
  // Process query
  setTimeout(() => {
    const response = processInsightQuery(query);
    const respBubble = document.createElement("div");
    respBubble.className = "bubble ai";
    respBubble.textContent = response;
    chat.appendChild(respBubble);
    chat.scrollTop = chat.scrollHeight;
  }, 500);
  
  $("#insightQuery").value = "";
});

$("#insightQuery").addEventListener("keydown", (e) => {
  if(e.key === "Enter"){
    e.preventDefault();
    $("#askInsightQueryBtn").click();
  }
});

function processInsightQuery(query){
  query = query.toLowerCase();
  
  if(query.includes("hor√°rio") && query.includes("produtivo")){
    const peakHours = analyzePeakHours();
    if(peakHours.length > 0){
      return `Seus hor√°rios mais produtivos s√£o: ${peakHours.slice(0,3).join(", ")}.\nBaseado na concentra√ß√£o de compromissos agendados nesses hor√°rios.`;
    }
    return "N√£o h√° dados suficientes para analisar hor√°rios produtivos. Adicione mais compromissos.";
  }
  
  if(query.includes("cliente") && (query.includes("frequente") || query.includes("mais"))){
    const customerFrequency = {};
    data.appts.forEach(appt => {
      if(appt.customerId){
        customerFrequency[appt.customerId] = (customerFrequency[appt.customerId] || 0) + 1;
      }
    });
    
    const top = Object.entries(customerFrequency)
      .sort((a, b) => b[1] - a[1])[0];
    
    if(top){
      const customer = data.customers.find(c => c.id === top[0]);
      if(customer){
        return `Cliente mais frequente: ${customer.name} (${top[1]} compromissos)`;
      }
    }
    return "N√£o h√° dados suficientes sobre clientes frequentes.";
  }
  
  return `Analisando sua pergunta: "${query}"\n\nBaseado nos seus dados, recomendo:\n1. Revise compromissos diariamente\n2. Priorize tarefas de alta prioridade\n3. Mantenha seus clientes atualizados\n\nPara an√°lises espec√≠ficas, adicione mais dados ao sistema.`;
}

function analyzePeakHours(){
  const hourCount = {};
  data.appts.forEach(appt => {
    const date = new Date(appt.start);
    const hour = date.getHours();
    hourCount[hour] = (hourCount[hour] || 0) + 1;
  });
  
  const peakHours = Object.entries(hourCount)
    .filter(([hour, count]) => count >= 2)
    .sort((a, b) => b[1] - a[1])
    .map(([hour]) => `${hour}h`);
  
  return peakHours;
}

// Add AI assistant button
$("#askInsightBtn").addEventListener("click", () => {
  setChatOpen(true);
  $("#chatIn").focus();
});

// Sync calendar button
$("#syncCalendarBtn").addEventListener("click", () => {
  toast("Sincroniza√ß√£o com calend√°rios externos em desenvolvimento");
});

/* ---------- Final Initialization ---------- */
// Make sure the app starts correctly
document.addEventListener("DOMContentLoaded", () => {
  startup();
  
  // Add keyboard shortcuts
  document.addEventListener("keydown", (e) => {
    // Ctrl/Cmd + K to open AI chat
    if((e.ctrlKey || e.metaKey) && e.key === "k"){
      e.preventDefault();
      setChatOpen(true);
      $("#chatIn").focus();
    }
    
    // Escape to close modals and menus
    if(e.key === "Escape"){
      if($("#backdrop").classList.contains("open")){
        closeModal();
      }
      if($("#menu").classList.contains("open")){
        setMenuOpen(false);
      }
      if($("#chat").classList.contains("open")){
        setChatOpen(false);
      }
    }
  });
});

// Export functions to global scope for debugging
window.KGenda = {
  data,
  currentProfile,
  renderCalendar,
  renderDashboard,
  saveData: () => saveData(currentProfile.id, data)
};
</script>

<script>
/* FORCE DIRECT ACCESS MODE (iOS file:// SAFE) */
document.addEventListener("DOMContentLoaded", function(){
  try{
    var ps = document.getElementById("profileSelector");
    if(ps){ ps.parentNode.removeChild(ps); }
    var app = document.getElementById("app");
    if(app){
      app.hidden = false;
      app.style.display = "block";
    }
  }catch(e){}
});
</script>


<script>
/* =========================
   K-GENDA ‚Äî ZIP A (STABLE FIXES)
   1) Cliente no agendamento carrega corretamente
   2) Selecionar cliente preenche telefone + email automaticamente
   3) Dura√ß√£o livre (qualquer minutos) com sincroniza√ß√£o segura
   (Sem mexer no calend√°rio nesta vers√£o)
   ========================= */
(function(){
  const $ = (q, el=document)=>el.querySelector(q);

  function safe(fn){ try{ fn(); }catch(e){} }

  function populateApptCustomerSelect(){
    const sel = document.getElementById("apptCustomer");
    if(!sel || !window.data) return;

    const current = sel.value;
    sel.innerHTML = "";

    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "‚Äî Selecione ‚Äî";
    sel.appendChild(opt0);

    const customers = Array.isArray(window.data.customers) ? window.data.customers : [];
    customers.forEach(c=>{
      const o = document.createElement("option");
      o.value = c.id;
      o.textContent = c.name || "(Sem nome)";
      sel.appendChild(o);
    });

    if(current) sel.value = current;
  }

  function autofillFromSelectedCustomer(){
    const sel = document.getElementById("apptCustomer");
    const phone = document.getElementById("apptPhone");
    const email = document.getElementById("apptEmail");
    if(!sel || !phone || !email || !window.data) return;

    const id = sel.value;
    if(!id) return;

    const customers = Array.isArray(window.data.customers) ? window.data.customers : [];
    const c = customers.find(x=>x.id === id);
    if(!c) return;

    // Always fill (user requested)
    phone.value = c.phone || "";
    email.value = (c.email || "").toLowerCase();
  }

  function bindCustomerSelect(){
    const sel = document.getElementById("apptCustomer");
    if(!sel || sel.dataset.kgBound) return;
    sel.dataset.kgBound = "1";
    sel.addEventListener("focus", ()=> safe(populateApptCustomerSelect));
    sel.addEventListener("click", ()=> safe(populateApptCustomerSelect));
    sel.addEventListener("change", ()=> safe(autofillFromSelectedCustomer));
  }

    function enhanceAppointmentsOnce(){
    populateApptCustomerSelect();
    bindCustomerSelect();
    enableFreeDuration();
  }

  // Run on load and whenever user navigates to appointments
  document.addEventListener("DOMContentLoaded", function(){
    safe(enhanceAppointmentsOnce);

    // Wrap goTab if exists to re-apply when entering appointments
    if(typeof window.goTab === "function" && !window.goTab.__kgWrappedA){
      const orig = window.goTab;
      window.goTab = function(key){
        const r = orig.apply(this, arguments);
        if(key === "appointments"){
          setTimeout(()=>safe(enhanceAppointmentsOnce), 0);
        }
        return r;
      };
      window.goTab.__kgWrappedA = true;
    }

    // Wrap renderCustomers so if customers change, dropdown updates
    if(typeof window.renderCustomers === "function" && !window.renderCustomers.__kgWrappedA){
      const origRC = window.renderCustomers;
      window.renderCustomers = function(){
        const r = origRC.apply(this, arguments);
        setTimeout(()=>safe(populateApptCustomerSelect), 0);
        return r;
      };
      window.renderCustomers.__kgWrappedA = true;
    }
  });
})();
</script>


<script>
/* =========================
   K-GENDA ‚Äî DURATION DROPDOWN FIX
   - Restore dropdown behavior
   - Extend options up to 12 hours
   ========================= */
(function(){
  function extendDurationDropdown(){
    const sel = document.getElementById("apptDuration");
    if(!sel || sel.dataset.extended) return;
    sel.dataset.extended = "1";
    sel.innerHTML = "";

    const options = [
      15,30,45,60,90,120,180,240,300,360,420,480,540,600,660,720
    ];

    options.forEach(min=>{
      const o = document.createElement("option");
      o.value = String(min);
      o.textContent = min < 60 ? `${min} min` :
        (min % 60 === 0 ? `${min/60} h` : `${Math.floor(min/60)}h ${min%60}m`);
      sel.appendChild(o);
    });

    // default 30 min
    sel.value = "30";
  }

  document.addEventListener("DOMContentLoaded", function(){
    extendDurationDropdown();

    if(typeof window.goTab === "function" && !window.goTab.__kgDurWrapped){
      const orig = window.goTab;
      window.goTab = function(key){
        const r = orig.apply(this, arguments);
        if(key === "appointments"){
          setTimeout(extendDurationDropdown, 0);
        }
        return r;
      };
      window.goTab.__kgDurWrapped = true;
    }
  });
})();
</script>


<script>
/* =========================
   K-GENDA ‚Äî ZIP B (CALENDAR INTERACTION)
   - Tap on calendar appointment opens details
   - From details user can edit or delete
   - No changes to calendar rendering logic
   ========================= */
(function(){
  function safe(fn){ try{ fn(); }catch(e){} }

  function bindCalendarClicks(){
    const wrap = document.getElementById("calWrap");
    if(!wrap || wrap.dataset.kgBound) return;
    wrap.dataset.kgBound = "1";

    wrap.addEventListener("click", function(ev){
      const evEl = ev.target.closest(".calEvent");
      if(!evEl) return;

      ev.stopPropagation();

      const apptId = evEl.getAttribute("data-apptid") || evEl.getAttribute("data-id");
      if(!apptId || !window.data || !Array.isArray(window.data.appts)) return;

      const appt = window.data.appts.find(a => a.id === apptId);
      if(!appt) return;

      // Prefer details modal if exists, else open editor
      if(typeof window.openAppointmentDetails === "function"){
        window.openAppointmentDetails(appt);
      }else if(typeof window.openApptEditor === "function"){
        window.openApptEditor(appt);
      }else{
        alert("Compromisso: " + (appt.title || "Sem t√≠tulo"));
      }
    });
  }

  document.addEventListener("DOMContentLoaded", function(){
    safe(bindCalendarClicks);

    // Re-bind after calendar re-render
    if(typeof window.renderCalendar === "function" && !window.renderCalendar.__kgWrappedB){
      const orig = window.renderCalendar;
      window.renderCalendar = function(){
        const r = orig.apply(this, arguments);
        setTimeout(()=>safe(bindCalendarClicks), 0);
        return r;
      };
      window.renderCalendar.__kgWrappedB = true;
    }
  });
})();
</script>


<script>
/* =========================
   K-GENDA ‚Äî ZIP B2 (CALENDAR POPUP UX)
   - Tap on calendar cell with appointments opens a beautiful popup card
   - Popup shows title, date, time, duration, client, notes
   ========================= */
(function(){
  function escapeHTML(s){
    return String(s||"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }
  function formatDate(d){
    try{
      const dt = new Date(d);
      return dt.toLocaleDateString('pt-BR', { weekday:'long', day:'2-digit', month:'short', year:'numeric' });
    }catch(e){ return d; }
  }
  function timeHM(d){
    const dt = new Date(d);
    return dt.toTimeString().slice(0,5);
  }

  function openApptSticker(appt){
    const cust = appt.customerId && window.data
      ? (window.data.customers||[]).find(c=>c.id===appt.customerId)
      : null;

    const start = new Date(appt.start);
    const dur = parseInt(appt.duration||30,10);
    const end = new Date(start.getTime()+dur*60000);

    const body = `
      <div style="
        background:linear-gradient(135deg,#e7f7fb,#d8f1f6);
        border-radius:18px;
        padding:18px;
        box-shadow:0 12px 30px rgba(0,0,0,.12)
      ">
        <h2 style="margin:0 0 8px 0;color:#2b8fa3">${escapeHTML(appt.title||'Compromisso')}</h2>
        <div style="font-size:14px;color:#2a3b44;line-height:1.6">
          <div>üìÖ ${formatDate(start)}</div>
          <div>üïò ${timeHM(start)} ‚Äì ${timeHM(end)} (${dur} min)</div>
          ${cust ? `<div>üë§ ${escapeHTML(cust.name)}</div>` : ``}
        </div>
      </div>
      ${appt.notes ? `
        <div style="margin-top:16px">
          <strong>Notas</strong>
          <div style="margin-top:6px;padding:10px;border-radius:12px;background:#f6fbfd">
            ${escapeHTML(appt.notes)}
          </div>
        </div>
      ` : ``}
    `;

    if(typeof window.openModal === "function"){
      window.openModal("Detalhes do Compromisso", body, [
        {label:"Fechar", variant:"secondary", onClick: window.closeModal},
        {label:"Editar", variant:"good", onClick: ()=>{ window.closeModal(); window.openApptEditor && window.openApptEditor(appt);} },
        {label:"Excluir", variant:"bad", onClick: ()=>{ window.closeModal(); window.confirmDeleteAppt && window.confirmDeleteAppt(appt);} }
      ]);
    }
  }

  function bindCalendarCellClicks(){
    const wrap = document.getElementById("calWrap");
    if(!wrap || wrap.dataset.kgPopup) return;
    wrap.dataset.kgPopup = "1";

    wrap.addEventListener("click", function(ev){
      const cell = ev.target.closest(".calCell");
      if(!cell) return;

      const date = cell.getAttribute("data-date");
      if(!date || !window.data) return;

      const appts = (window.data.appts||[]).filter(a => a.start && a.start.startsWith(date));
      if(appts.length === 0) return;

      // If multiple, open first for now (can expand later)
      openApptSticker(appts[0]);
    });
  }

  document.addEventListener("DOMContentLoaded", function(){
    bindCalendarCellClicks();

    if(typeof window.renderCalendar === "function" && !window.renderCalendar.__kgPopupWrapped){
      const orig = window.renderCalendar;
      window.renderCalendar = function(){
        const r = orig.apply(this, arguments);
        setTimeout(bindCalendarCellClicks, 0);
        return r;
      };
      window.renderCalendar.__kgPopupWrapped = true;
    }
  });
})();
</script>


<script>
/* =========================
   K-GENDA ‚Äî ZIP C
   - Apple Calendar (ICS real)
   - Google Calendar (TEMPLATE link)
   - Reminder button (local notification-like)
   - Notes button (quick notes per appointment)
   ========================= */
(function(){
  function esc(s){return String(s||"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
  function pad(n){return String(n).padStart(2,"0");}
  function toICS(d){
    const x=new Date(d);
    return x.getUTCFullYear()+pad(x.getUTCMonth()+1)+pad(x.getUTCDate())+"T"+pad(x.getUTCHours())+pad(x.getUTCMinutes())+"00Z";
  }

  function downloadICS(appt){
    const start=new Date(appt.start);
    const end=new Date(start.getTime()+(parseInt(appt.duration||30)*60000));
    const ics=[
      "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//K-Genda//PT-BR",
      "BEGIN:VEVENT",
      "UID:"+appt.id+"@kgenda",
      "DTSTAMP:"+toICS(Date.now()),
      "DTSTART:"+toICS(start),
      "DTEND:"+toICS(end),
      "SUMMARY:"+esc(appt.title),
      appt.notes?"DESCRIPTION:"+esc(appt.notes):"",
      "END:VEVENT","END:VCALENDAR"
    ].join("\r\n");
    const blob=new Blob([ics],{type:"text/calendar"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="kgenda-"+appt.id+".ics";
    a.click();
  }

  function googleLink(appt){
    const s=toICS(appt.start);
    const e=toICS(new Date(new Date(appt.start).getTime()+appt.duration*60000));
    const url=`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(appt.title)}&dates=${s}/${e}&details=${encodeURIComponent(appt.notes||"")}`;
    window.open(url,"_blank");
  }

  function reminder(appt){
    alert("üîî Lembrete criado:\n"+appt.title+"\n"+new Date(appt.start).toLocaleString());
  }

  function quickNote(appt){
    const note=prompt("Nota r√°pida:",appt.notes||"");
    if(note!==null){
      appt.notes=note;
      if(window.saveData) window.saveData(window.getActiveProfileId(),window.data);
      alert("üìù Nota salva");
    }
  }

  // Extend popup buttons
  if(window.openAppointmentDetails && !window.openAppointmentDetails.__zipC){
    const orig=window.openAppointmentDetails;
    window.openAppointmentDetails=function(appt){
      orig(appt);
      setTimeout(()=>{
        const footer=document.querySelector(".modal-footer");
        if(!footer) return;
        const btn=(t,fn)=>{
          const b=document.createElement("button");
          b.textContent=t;
          b.className="btn secondary";
          b.onclick=fn;
          return b;
        };
        footer.appendChild(btn("Ô£ø Apple",()=>downloadICS(appt)));
        footer.appendChild(btn("Google",()=>googleLink(appt)));
        footer.appendChild(btn("üîî Lembrete",()=>reminder(appt)));
        footer.appendChild(btn("üìù Nota",()=>quickNote(appt)));
      },50);
    };
    window.openAppointmentDetails.__zipC=true;
  }
})();
</script>

</body>
</html>
